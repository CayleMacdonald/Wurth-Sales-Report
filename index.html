<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Reporting Dashboard</title>
<style>
:root{--bg:#fff5f5;--card:#fff;--accent:#d32f2f;--muted:#6b7280}
.metric-card{position:relative;overflow:hidden;transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease;background-clip:padding-box;border:1px solid rgba(255,255,255,0.28)}
.metric-card::after{content:"";position:absolute;inset:-40% 10% auto auto;width:220px;height:220px;background:radial-gradient(circle at center,rgba(255,255,255,0.35),rgba(255,255,255,0));transform:rotate(6deg);pointer-events:none;opacity:0.8}
.metric-card:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(15,23,42,0.18);border-color:rgba(255,255,255,0.45)}
.metric-icon{position:absolute;top:14px;right:14px;font-size:34px;opacity:0.26;transition:transform .25s ease,opacity .25s ease}
.metric-card:hover .metric-icon{transform:scale(1.12) rotate(-8deg);opacity:0.4}
.chart-card{position:relative;transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease;border:1px solid #e2e8f0;background:linear-gradient(135deg,#f9fafb,#eef2ff)}
.chart-card::after{content:"";position:absolute;inset:8px;pointer-events:none;border-radius:12px;background:radial-gradient(circle at 25% 20%,rgba(99,102,241,0.09),transparent 55%)}
.chart-card canvas{transition:transform .2s ease}
.chart-card:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(15,23,42,0.14);border-color:#cbd5e1}
.chart-card:hover canvas{transform:translateY(-1px) scale(1.01)}
*{box-sizing:border-box}
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a;min-height:100vh}
header{background:linear-gradient(90deg,#d32f2f,#f36b6b);color:#fff;padding:16px 22px;display:flex;align-items:center;justify-content:space-between}
.container{max-width:100%;margin:0;padding:20px;min-height:calc(100vh - 120px)}
.nav-btn{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.nav-btn.active{background:rgba(255,255,255,0.12)}
.card{background:var(--card);border-radius:8px;padding:20px;box-shadow:0 4px 12px rgba(15,23,42,0.06);margin-bottom:12px;height:100%}
.reports-list{display:grid;grid-template-columns:repeat(4,1fr);gap:24px;height:auto;padding:28px;max-width:1160px;margin:0 auto}
.report-tile{background:#fff;padding:28px;border-radius:18px;cursor:pointer;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease;flex-direction:column;gap:16px;box-shadow:0 3px 16px rgba(15,23,42,0.14);aspect-ratio:1/1;width:100%}
.report-tile:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(15,23,42,0.18);border-color:#d32f2f}
.report-tile.selected{border:2px solid #d32f2f;box-shadow:0 0 0 2px rgba(211,47,47,0.12)}
select,input,button{padding:12px 16px;border:1px solid #e6e9ef;border-radius:6px;background:#fff;font-size:16px}
button{background:var(--accent);color:#fff;border:0;cursor:pointer;font-weight:600}
.signin-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#d32f2f,#f36b6b)}
.signin-card{background:#fff;padding:50px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.15);max-width:500px;width:100%;margin:20px}
.view{display:none}
.signin-title{color:#d32f2f;font-size:28px;text-align:center;margin-bottom:30px;font-weight:700}
.form-group{margin-bottom:24px}
.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:16px}
.form-group input{width:100%;padding:16px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;transition:border-color 0.3s}
.form-group input:focus{outline:none;border-color:#d32f2f}
.signin-card button{width:100%;padding:16px;font-size:16px;font-weight:600;border-radius:8px;margin-top:8px}
.group-slicer{position:fixed;right:18px;top:132px;width:260px;max-height:60vh;overflow:auto;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(15,23,42,0.15);padding:14px;z-index:30;display:none}
.group-slicer h4{margin:0 0 8px 0;font-size:13px;color:#0f172a;font-weight:700;letter-spacing:0.01em}
.group-slicer small{display:block;margin-bottom:10px;color:#6b7280;font-size:12px}
.group-slicer button{width:100%;margin-bottom:6px;text-align:left;font-size:13px;padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;color:#0f172a;cursor:pointer;transition:all .15s}
.group-slicer button.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9;box-shadow:0 6px 14px rgba(14,165,233,0.25)}
.group-slicer button:hover{border-color:#0ea5e9}
@media(max-width:1100px){.group-slicer{display:none}}
@media(max-width:1200px){.reports-list{grid-template-columns:repeat(2,1fr)}}
@media(max-width:880px){.reports-list{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="signinPage" class="signin-container">
<div class="signin-card">
<div id="authNotification" style="display:none;margin-bottom:20px;padding:12px;border-radius:6px"></div>
<h1 class="signin-title">ğŸ¢ Enterprise Reporting</h1>
<form id="signinForm">
<div class="form-group">
<label>Email Address</label>
<input type="email" id="emailInput" required placeholder="Enter your email"/>
</div>
<button type="submit">Continue</button>
</form>
<form id="verifyForm" style="display:none">
<div class="form-group">
<label>Verification Code</label>
<input type="text" id="authCode" class="auth-code" maxlength="6" placeholder="000000" required/>
<div style="font-size:14px;color:#6b7280;margin-top:12px">Default code: 000000</div>
</div>
<button type="submit">Verify & Sign In</button>
</form>
</div>
</div>

<div id="mainApp" style="display:none">
<header>
<div style="display:flex;align-items:center;gap:8px">
<div style="font-size:24px">ğŸ“Š</div>
<h1 style="margin:0;font-size:20px">Enterprise Reporting Dashboard</h1>
</div>
<div style="display:flex;align-items:center;gap:16px">
<span id="userEmail" style="font-size:14px;opacity:0.9"></span>
<button onclick="signOut()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2)">Sign Out</button>
</div>
</header>

<main class="container">
<aside id="groupSlicerPanel" class="group-slicer" aria-label="Sales group slicer" style="display:none">
<h4>Sales Group Slicer</h4>
<small>Single-click to filter Sales, Dashboard, and Customers.</small>
<div id="groupSlicerButtons"></div>
</aside>
<section id="home" class="card view" style="display:block">
<h2 style="margin:0 0 24px 0;text-align:center">ğŸ“ˆ Select Report Type</h2>
<div class="reports-list">
<div class="report-tile" data-open="sales" role="button" tabindex="0">
<div style="font-size:48px">ğŸ“ˆ</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">Sales Reports</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Monthly sales analysis and performance metrics</p>
</div>
</div>
<div class="report-tile" data-open="masterdata" role="button" tabindex="0">
<div style="font-size:48px">ğŸ—ƒï¸</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">Master Data</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Upload and manage data sources</p>
</div>
</div>
<div class="report-tile" data-open="customers" role="button" tabindex="0">
<div style="font-size:48px">ğŸ‘¥</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">Customers</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Customer analytics and insights</p>
</div>
</div>
<div class="report-tile" data-open="stock" role="button" tabindex="0">
<div style="font-size:48px">ğŸ“¦</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">Stock Data</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Inventory management and tracking</p>
</div>
</div>
<div class="report-tile" data-open="pricing" role="button" tabindex="0">
<div style="font-size:48px">ğŸ“¦</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">Products Data</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Product performance and pricing</p>
</div>
</div>
<div class="report-tile" data-open="salesDashboard" role="button" tabindex="0">
<div style="font-size:48px">ğŸ“Š</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">Sales Dashboard</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Executive dashboard and KPIs</p>
</div>
</div>
<div class="report-tile" data-open="financial" role="button" tabindex="0">
<div style="font-size:48px">ğŸ’°</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">Financial</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Financial reports and analysis</p>
</div>
</div>
<div class="report-tile" data-open="kpi" role="button" tabindex="0">
<div style="font-size:48px">ğŸ¯</div>
<div style="text-align:center">
<h3 style="margin:8px 0 6px 0;font-size:16px;font-weight:600">KPI Metrics</h3>
<p style="margin:0;color:#6b7280;font-size:12px;line-height:1.3">Key performance indicators</p>
</div>
</div>
</div>
</section>

<section id="masterdata" class="card view">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<div style="display:flex;align-items:center;gap:10px">
<button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px">â† Back</button>
<h2 style="margin:0;font-size:32px;color:#1f2937">MASTER DATA MANAGEMENT</h2>
</div>
</div>

<div class="card">
<h3 style="margin:0 0 40px 0;color:#374151;font-size:28px;font-weight:600;text-align:center">Upload Master Data</h3>
<div style="max-width:1200px;margin:0 auto">

<div style="margin-bottom:30px">
<label style="display:block;margin-bottom:12px;font-size:18px;color:#374151;font-weight:600">Select Data Type:</label>
<select id="uploadDataType" style="width:100%;padding:16px 20px;border:2px solid #d1d5db;border-radius:12px;font-size:18px">
<option value="sales">ğŸ“Š Sales Performance Data</option>
<option value="revenue">ğŸ’° Revenue & Financial Metrics</option>
<option value="customer">ğŸ‘¥ Customer Analytics Data</option>
<option value="operational">âš™ï¸ Operational Metrics</option>
<option value="marketing">ğŸ“ˆ Marketing Performance</option>
<option value="inventory">ğŸ“¦ Inventory & Stock Levels</option>
<option value="targets">ğŸ¯ Sales Targets & Goals</option>
<option value="pricing">ğŸ’² Products Data</option>
<option value="hr">ğŸ‘¤ HR & Employee Metrics</option>
</select>
</div>

<div style="margin-bottom:30px;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0">
<h4 style="margin:0 0 16px 0;color:#1f2937;font-size:16px">ğŸ“‹ Data Management</h4>
<div style="display:flex;gap:15px;align-items:center">
<button onclick="viewCurrentData()" style="background:#6b7280;color:white;padding:8px 16px;border:none;border-radius:6px;font-size:14px;cursor:pointer">ğŸ‘ï¸ View Current Data</button>
<button onclick="clearCurrentData()" style="background:#ef4444;color:white;padding:8px 16px;border:none;border-radius:6px;font-size:14px;cursor:pointer">ğŸ—‘ï¸ Clear Current Data</button>
<span id="dataCount" style="color:#6b7280;font-size:14px">No data loaded</span>
</div>
</div>

<div style="margin-bottom:30px;text-align:center">
<a href="#" onclick="cleanupTempFiles()" style="color:#3b82f6;text-decoration:none;font-size:16px;padding:8px 16px;border:1px solid #3b82f6;border-radius:6px">ğŸ§¹ Cleanup Temporary Upload Files</a>
</div>

<div style="margin-bottom:30px">
<label style="display:block;margin-bottom:12px;font-size:18px;color:#374151;font-weight:600">Select File:</label>
<div style="position:relative">
<input type="file" id="unifiedFileInput" accept=".csv,.xlsx,.xls" style="width:100%;padding:16px 20px;border:2px solid #d1d5db;border-radius:12px;font-size:18px">
<div id="fileSelectedInfo" style="font-size:16px;color:#6b7280;margin-top:12px;margin-left:20px">ğŸ“ No file chosen</div>
</div>
</div>

<div style="margin-bottom:35px">
<label style="display:flex;align-items:center;gap:12px;font-size:16px;color:#374151;margin-left:20px;cursor:pointer">
<input type="checkbox" id="enableDebugMode" style="margin:0;width:20px;height:20px">
<span>ğŸ” Enable Debug Mode (first 10 rows only)</span>
</label>
</div>

<div style="margin-bottom:40px;padding:20px;background:linear-gradient(135deg,#d1fae5,#a7f3d0);border-radius:12px;display:flex;align-items:center;gap:15px;border:2px solid #10b981">
<span style="color:#059669;font-size:24px">âœ“</span>
<span style="color:#065f46;font-size:16px">ğŸš€ <strong>Celery Available:</strong> Async processing enabled!</span>
</div>

<div style="display:flex;gap:20px;align-items:center;justify-content:center">
<button id="uploadMasterDataBtn" onclick="uploadMasterData()" style="background:linear-gradient(135deg,#ef4444,#dc2626);padding:18px 40px;border-radius:12px;font-size:18px;font-weight:700;transition:all 0.3s;box-shadow:0 4px 15px rgba(239,68,68,0.3)">ğŸ“¤ Upload Data</button>
<button onclick="exportSelectedTemplate()" style="background:linear-gradient(135deg,#3b82f6,#2563eb);padding:18px 40px;border-radius:12px;font-size:18px;font-weight:700;transition:all 0.3s;box-shadow:0 4px 15px rgba(59,130,246,0.3)">ğŸ“„ Export Template</button>
</div>

<div id="uploadStatus" style="margin-top:30px;font-size:16px;text-align:center"></div>
</div>
</div>
</section>

<section id="sales" class="card view">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<div style="display:flex;align-items:center;gap:10px">
<button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px">â† Back</button>
<h2 style="margin:0">ğŸ“ˆ SALES REPORTS</h2>
</div>
</div>
<div id="salesContent">
<div id="salesFilters" style="background:#f8fafc;padding:16px;margin-bottom:20px;border-radius:8px;border:1px solid #e5e7eb;display:block">
    <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px">ğŸ” Filters</h4>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
        <div>
            <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">From Date:</label>
            <input type="date" id="salesDateFrom" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
        </div>
        <div>
            <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">To Date:</label>
            <input type="date" id="salesDateTo" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
        </div>
        <div>
            <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">Sales Division:</label>
            <select id="salesDivisionFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                <option value="" disabled>All Sales Divisions</option>
            </select>
        </div>
        <div>
            <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">Sales Group (Code + Name):</label>
            <select id="salesGroupFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                <option value="" disabled>All Sales Groups (Code + Name)</option>
            </select>
        </div>
        <div>
            <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">CSC Name:</label>
            <select id="salesBusinessCoFilter" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                <option value="">All CSC Names</option>
            </select>
        </div>
        <div style="display:flex;align-items:end;gap:8px">
            <button onclick="applySalesFilters()" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:4px;font-size:14px;cursor:pointer">Apply</button>
            <button onclick="clearSalesFilters()" style="background:#6b7280;color:white;padding:8px 16px;border:none;border-radius:4px;font-size:14px;cursor:pointer">Clear</button>
        </div>
    </div>
</div>
<div id="salesData" style="display:none">
    <div style="margin-bottom:20px">
        <h3 style="color:#1f2937;margin-bottom:16px">ğŸ“Š Sales Data Overview</h3>
        <div id="salesSummary" style="background:#f8fafc;padding:20px;border-radius:8px;margin-bottom:20px"></div>
    </div>
    <div style="max-height:400px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px">
        <table id="salesTable" style="width:100%;border-collapse:collapse">
            <thead style="background:#f9fafb;position:sticky;top:0">
                <tr id="salesTableHeader"></tr>
            </thead>
            <tbody id="salesTableBody"></tbody>
        </table>
    </div>
    <div id="salesTableActions" style="display:none;margin-top:14px;align-items:center;justify-content:center;gap:16px;font-size:13px;color:#4b5563">
        <button id="salesTableLoadMore" onclick="loadMoreSalesRows()" style="background:#2563eb;color:white;padding:8px 18px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;box-shadow:0 2px 8px rgba(37,99,235,0.2)">Load More Rows</button>
        <span id="salesTableCount"></span>
    </div>
</div>
<p id="noSalesData" style="color:#6b7280;text-align:center;padding:40px">Upload sales data in Master Data section to view reports here.</p>
</div>
</section>

<section id="customers" class="card view">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<div style="display:flex;align-items:center;gap:10px">
<button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px">â† Back</button>
<h2 style="margin:0">ğŸ‘¥ CUSTOMER REPORTS</h2>
</div>
</div>
        <div id="customerContent">
            <div id="customerFilters" style="background:#f8fafc;padding:16px;margin-bottom:20px;border-radius:8px;border:1px solid #e5e7eb;display:block">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px">ğŸ” Filters</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">From Date:</label>
                        <input type="date" id="customerDateFrom" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">To Date:</label>
                        <input type="date" id="customerDateTo" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">Division:</label>
                        <select id="customerDivisionFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                            <option value="" disabled>All Divisions</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">Sales Group (Code + Name):</label>
                        <select id="customerGroupFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                            <option value="" disabled>All Groups</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:4px;font-size:14px;color:#374151">Business Co:</label>
                        <select id="customerBusinessCoFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                            <option value="" disabled>All Business Co</option>
                        </select>
                    </div>
                    <div style="display:flex;align-items:end;gap:8px">
                        <button onclick="applyCustomerFilters()" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:4px;font-size:14px;cursor:pointer">Apply</button>
                        <button onclick="clearCustomerFilters()" style="background:#6b7280;color:white;padding:8px 16px;border:none;border-radius:4px;font-size:14px;cursor:pointer">Clear</button>
                    </div>
                </div>
            </div>
            <div id="customerNoData" style="color:#6b7280;text-align:center;padding:40px">Upload customer data in Master Data section to view reports here.</div>
            <div id="customerSummary" style="display:none;margin-bottom:24px"></div>
            <div id="customerInsights" style="display:none;margin-bottom:24px"></div>
            <div id="customerTableSection" style="display:none">
                <div style="background:white;border-radius:12px;padding:16px;border:1px solid #e5e7eb;box-shadow:0 4px 15px rgba(0,0,0,0.05)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div id="customerTableCount" style="font-size:13px;color:#6b7280"></div>
                        <button id="customerTableLoadMore" onclick="loadMoreCustomerRows()" style="display:none;background:#3b82f6;color:white;padding:6px 12px;border:none;border-radius:6px;font-size:13px;cursor:pointer">Load more</button>
                    </div>
                    <div style="overflow:auto;max-height:420px">
                        <table style="width:100%;border-collapse:collapse;font-size:13px">
                            <thead id="customerTableHeader"></thead>
                            <tbody id="customerTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stock Data Section -->
    <section id="stock" class="card view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:10px">
                <button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px">â† Back</button>
                <h2 style="margin:0">ğŸ“¦ STOCK DATA</h2>
            </div>
            <button onclick="toggleStockFilters()" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">ğŸ” Filters</button>
        </div>

        <!-- Stock Filter Panel -->
        <div id="stockFilters" style="display:block;background:#f8fafc;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0">
            <h3 style="margin:0 0 16px 0;color:#1f2937;font-size:18px">ğŸ“¦ Filter Stock Data</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Category:</label>
                    <select id="stockCategoryFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Categories</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Supplier:</label>
                    <select id="stockSupplierFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Suppliers</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Stock Level:</label>
                    <select id="stockLevelFilter" multiple size="4" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Levels</option>
                        <option value="low">Low Stock</option>
                        <option value="normal">Normal Stock</option>
                        <option value="high">High Stock</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:12px">
                <button onclick="applyStockFilters()" style="background:#059669;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Apply Filters</button>
                <button onclick="clearStockFilters()" style="background:#6b7280;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Clear All</button>
            </div>
        </div>
        <div id="stockContent">
            <p style="color:#6b7280;text-align:center;padding:40px">Upload stock data in Master Data section to view inventory reports here.</p>
        </div>
    </section>

    <!-- Products Data Section -->
    <section id="pricing" class="card view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:10px">
                <button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px">â† Back</button>
                <h2 style="margin:0">ğŸ“¦ PRODUCTS DATA</h2>
            </div>
            <button onclick="togglePricingFilters()" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">ğŸ” Filters</button>
        </div>

        <!-- Pricing / Product Filter Panel -->
        <div id="pricingFilters" style="display:block;background:#f8fafc;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0">
            <h3 style="margin:0 0 16px 0;color:#1f2937;font-size:18px">ğŸ§­ Product Filters</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Sales Sector 2:</label>
                    <select id="pricingDivisionFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Sales Sector 2</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Sales Area:</label>
                    <select id="pricingSectorFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Sales Areas</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Sales Rep:</label>
                    <select id="pricingRepFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Reps</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Power Product (Yes = Power):</label>
                    <select id="pricingPowerFilter" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="">All</option>
                        <option value="yes">Yes (Power Product)</option>
                        <option value="no">No / Standard</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Product Search:</label>
                    <input type="search" id="pricingProductSearch" placeholder="Search product name or code" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px"/>
                </div>
            </div>
            <div style="display:flex;gap:12px">
                <button onclick="applyPricingFilters()" style="background:#059669;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Apply Filters</button>
                <button onclick="clearPricingFilters()" style="background:#6b7280;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Clear All</button>
            </div>
        </div>
        <div id="pricingContent" style="display:flex;flex-direction:column;gap:16px">
            <p style="color:#6b7280;text-align:center;padding:40px">Upload products data in Master Data section to view product and power-product analysis here.</p>
        </div>
    </section>

    <!-- Sales Dashboard Section -->
    <section id="salesDashboard" class="card view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:10px">
                <button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600">â† Back</button>
                <h2 style="margin:0;color:#1f2937;font-size:24px;font-weight:700">ğŸ“ˆ SALES DASHBOARD</h2>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <button onclick="toggleGroupSlicerDropdown()" style="background:#0ea5e9;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600">ğŸŒ Group Slicer</button>
                <button onclick="toggleSalesDashboardFilters()" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600">ğŸ” Filters</button>
            </div>
        </div>

        <!-- Sales Dashboard Filter Panel -->
        <div id="salesDashboardFilters" style="display:block;background:white;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;box-shadow:0 2px 4px rgba(0,0,0,0.05)">
            <h3 style="margin:0 0 16px 0;color:#1f2937;font-size:18px;font-weight:600">ğŸ” Dashboard Filters</h3>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                <!-- Date Range -->
                <div>
                    <label style="display:block;margin-bottom:6px;font-size:14px;color:#374151;font-weight:500">ğŸ“… From Date</label>
                    <input type="date" id="dashboardDateFrom" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px">
                </div>
                
                <div>
                    <label style="display:block;margin-bottom:6px;font-size:14px;color:#374151;font-weight:500">ğŸ“… To Date</label>
                    <input type="date" id="dashboardDateTo" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px">
                </div>
                
                <!-- Division -->
                <div>
                    <label style="display:block;margin-bottom:6px;font-size:14px;color:#374151;font-weight:500">ğŸ¢ Division</label>
                    <select id="dashboardDivisionFilter" multiple size="6" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;background:white">
                        <option value="" disabled>All Divisions</option>
                    </select>
                </div>

                <!-- Sales Group -->
                <div>
                    <label style="display:block;margin-bottom:6px;font-size:14px;color:#374151;font-weight:500">ğŸŒ Sales Group (Code + Name)</label>
                    <select id="dashboardGroupFilter" multiple size="6" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;background:white">
                        <option value="" disabled>All Sales Groups (Code + Name)</option>
                    </select>
                </div>
                
                <!-- Sales Rep -->
                <div>
                    <label style="display:block;margin-bottom:6px;font-size:14px;color:#374151;font-weight:500">ğŸ‘¥ Sales Rep</label>
                    <select id="dashboardSalesRepFilter" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;background:white">
                        <option value="">All Sales Reps</option>
                    </select>
                </div>
                
                <!-- Performance Level -->
                <div>
                    <label style="display:block;margin-bottom:6px;font-size:14px;color:#374151;font-weight:500">ğŸ¯ Performance Level</label>
                    <select id="dashboardPerformanceFilter" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;background:white">
                        <option value="">All Performance Levels</option>
                        <option value="high">ğŸ† High (80%+)</option>
                        <option value="medium">ğŸ”¥ Medium (60-80%)</option>
                        <option value="low">ğŸ”» Low (<60%)</option>
                    </select>
                </div>
                
                <!-- Turnover Range -->
                <div>
                    <label style="display:block;margin-bottom:6px;font-size:14px;color:#374151;font-weight:500">ğŸ’° Turnover Range</label>
                    <select id="dashboardTurnoverFilter" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;background:white">
                        <option value="">All Turnover Ranges</option>
                        <option value="0-10000">R0 - R10K</option>
                        <option value="10000-25000">R10K - R25K</option>
                        <option value="25000-50000">R25K - R50K</option>
                        <option value="50000+">R50K+</option>
                    </select>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display:flex;gap:12px;justify-content:center;margin-top:20px">
                <button onclick="applySalesDashboardFilters()" style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:12px 24px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;box-shadow:0 2px 8px rgba(5,150,105,0.3);transition:all 0.2s">âœ¨ Apply Filters</button>
                <button onclick="clearSalesDashboardFilters()" style="background:linear-gradient(135deg,#6b7280,#9ca3af);color:white;padding:12px 24px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;box-shadow:0 2px 8px rgba(107,114,128,0.3);transition:all 0.2s">ğŸ”„ Clear All</button>
            </div>
        </div>
        <div id="salesDashboardContent" style="max-width:1400px;margin:30px auto 0 auto;display:flex;flex-direction:column;gap:28px">
            <!-- Key Metrics Cards -->
            <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-auto-rows:1fr;gap:24px">
                
                <!-- Total Turnover Card -->
                <div title="Sum of turnover across filtered sales" data-dashboard-drill="turnover" data-dashboard-card="true" class="metric-card" role="button" tabindex="0" style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(5,150,105,0.3);cursor:pointer;outline:none">
                    <span class="metric-icon">ğŸ’°</span>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 8px 0;font-size:14px;font-weight:600;opacity:0.9">Total Turnover</h3>
                        <div id="dashboardTotalTurnover" style="font-size:32px;font-weight:800;margin-bottom:8px">R0</div>
                        <button onclick="toggleCardDetails('turnoverDetails', this)" style="margin-top:4px;background:rgba(255,255,255,0.18);color:white;border:1px solid rgba(255,255,255,0.35);border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600;cursor:pointer">View details â–¸</button>
                        <div id="turnoverDetails" style="display:none;margin-top:12px">
                            <div style="display:flex;align-items:center;gap:6px;font-size:12px;opacity:0.8">
                                <span id="turnoverTrend" style="padding:2px 6px;background:rgba(255,255,255,0.2);border-radius:12px">+0%</span>
                                <span>vs last period</span>
                            </div>
                            <div id="turnoverTargetText" style="margin-top:12px;font-size:12px;opacity:0.85">Targets pending upload</div>
                            <div style="margin-top:6px;height:6px;background:rgba(255,255,255,0.25);border-radius:4px;overflow:hidden">
                                <div id="turnoverProgressBar" style="height:100%;width:0%;background:rgba(255,255,255,0.9);transition:width 0.3s ease"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Clients Card -->
                <div title="Customers with purchases in the last 12 months and total turnover under R1000" data-dashboard-drill="activeClients" data-dashboard-card="true" class="metric-card" role="button" tabindex="0" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);color:white;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(59,130,246,0.3);cursor:pointer;outline:none">
                    <span class="metric-icon">ğŸ‘¥</span>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 8px 0;font-size:14px;font-weight:600;opacity:0.9">Active Clients &lt;R1000 (12m)</h3>
                        <div id="dashboardActiveClients" style="font-size:32px;font-weight:800;margin-bottom:8px">0</div>
                        <button onclick="toggleCardDetails('activeClientsDetails', this)" style="margin-top:4px;background:rgba(255,255,255,0.18);color:white;border:1px solid rgba(255,255,255,0.35);border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600;cursor:pointer">View details â–¸</button>
                        <div id="activeClientsDetails" style="display:none;margin-top:12px">
                            <div style="display:flex;align-items:center;gap:6px;font-size:12px;opacity:0.8">
                                <span id="clientsBreakdown" style="padding:2px 6px;background:rgba(255,255,255,0.2);border-radius:12px">12m cohort</span>
                                <span>under R1000</span>
                            </div>
                            <div id="activeClientsTargetText" style="margin-top:12px;font-size:12px;opacity:0.85">Targets pending upload</div>
                            <div style="margin-top:6px;height:6px;background:rgba(255,255,255,0.25);border-radius:4px;overflow:hidden">
                                <div id="activeClientsProgressBar" style="height:100%;width:0%;background:rgba(255,255,255,0.9);transition:width 0.3s ease"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Lines Card -->
                <div title="Total order lines across filtered data" data-dashboard-drill="orderLines" data-dashboard-card="true" class="metric-card" role="button" tabindex="0" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:white;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(139,92,246,0.3);cursor:pointer;outline:none">
                    <span class="metric-icon">ğŸ“‹</span>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 8px 0;font-size:14px;font-weight:600;opacity:0.9">Order Lines</h3>
                        <div id="dashboardOrderLines" style="font-size:32px;font-weight:800;margin-bottom:8px">0</div>
                        <button onclick="toggleCardDetails('orderLinesDetails', this)" style="margin-top:4px;background:rgba(255,255,255,0.18);color:white;border:1px solid rgba(255,255,255,0.35);border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600;cursor:pointer">View details â–¸</button>
                        <div id="orderLinesDetails" style="display:none;margin-top:12px">
                            <div style="display:flex;align-items:center;gap:6px;font-size:12px;opacity:0.8">
                                <span id="avgOrderValue" style="padding:2px 6px;background:rgba(255,255,255,0.2);border-radius:12px">R0 avg</span>
                                <span>per order</span>
                            </div>
                            <div id="orderLinesTargetText" style="margin-top:12px;font-size:12px;opacity:0.85">Targets pending upload</div>
                            <div style="margin-top:6px;height:6px;background:rgba(255,255,255,0.25);border-radius:4px;overflow:hidden">
                                <div id="orderLinesProgressBar" style="height:100%;width:0%;background:rgba(255,255,255,0.9);transition:width 0.3s ease"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Balance Card -->
                <div title="Estimated balance calculated at 15% of turnover" data-dashboard-card="true" class="metric-card" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);color:white;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(245,158,11,0.3);cursor:pointer">
                    <span class="metric-icon">âš–ï¸</span>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 8px 0;font-size:14px;font-weight:600;opacity:0.9">Customer Balance</h3>
                        <div id="dashboardCustomerBalance" style="font-size:32px;font-weight:800;margin-bottom:8px">R0</div>
                        <button onclick="toggleCardDetails('customerBalanceDetails', this)" style="margin-top:4px;background:rgba(255,255,255,0.18);color:white;border:1px solid rgba(255,255,255,0.35);border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600;cursor:pointer">View details â–¸</button>
                        <div id="customerBalanceDetails" style="display:none;margin-top:12px">
                            <div style="display:flex;align-items:center;gap:6px;font-size:12px;opacity:0.8">
                                <span id="balanceStatus" style="padding:2px 6px;background:rgba(255,255,255,0.2);border-radius:12px">Healthy</span>
                                <span>overall status</span>
                            </div>
                            <div id="customerBalanceTargetText" style="margin-top:12px;font-size:12px;opacity:0.85">Targets pending upload</div>
                            <div style="margin-top:6px;height:6px;background:rgba(255,255,255,0.25);border-radius:4px;overflow:hidden">
                                <div id="customerBalanceProgressBar" style="height:100%;width:0%;background:rgba(255,255,255,0.9);transition:width 0.3s ease"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- New Business Card -->
                <div title="Turnover secured during the last 30 days" data-dashboard-card="true" class="metric-card" style="background:linear-gradient(135deg,#ef4444,#f87171);color:white;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(239,68,68,0.3);cursor:pointer">
                    <span class="metric-icon">ğŸŒŸ</span>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 8px 0;font-size:14px;font-weight:600;opacity:0.9">New Business</h3>
                        <div id="dashboardNewBusiness" style="font-size:32px;font-weight:800;margin-bottom:8px">R0</div>
                        <button onclick="toggleCardDetails('newBusinessDetails', this)" style="margin-top:4px;background:rgba(255,255,255,0.18);color:white;border:1px solid rgba(255,255,255,0.35);border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600;cursor:pointer">View details â–¸</button>
                        <div id="newBusinessDetails" style="display:none;margin-top:12px">
                            <div style="display:flex;align-items:center;gap:6px;font-size:12px;opacity:0.8">
                                <span id="newBusinessCount" style="padding:2px 6px;background:rgba(255,255,255,0.2);border-radius:12px">External feed</span>
                                <span>latest period</span>
                            </div>
                            <div id="newBusinessTargetText" style="margin-top:12px;font-size:12px;opacity:0.85">Targets pending upload</div>
                            <div style="margin-top:6px;height:6px;background:rgba(255,255,255,0.25);border-radius:4px;overflow:hidden">
                                <div id="newBusinessProgressBar" style="height:100%;width:0%;background:rgba(255,255,255,0.9);transition:width 0.3s ease"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Remaining Days & Target Card -->
                <div title="Working days left before the 15 Dec 2026 close" data-dashboard-card="true" class="metric-card" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);color:white;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(14,165,233,0.3);cursor:pointer">
                    <span class="metric-icon">ğŸ—“ï¸</span>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 8px 0;font-size:14px;font-weight:600;opacity:0.9">Remaining Working Days</h3>
                        <div id="dashboardRemainingDays" style="font-size:32px;font-weight:800;margin-bottom:8px">0 days</div>
                        <button onclick="toggleCardDetails('remainingDaysDetails', this)" style="margin-top:4px;background:rgba(255,255,255,0.18);color:white;border:1px solid rgba(255,255,255,0.35);border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600;cursor:pointer">View details â–¸</button>
                        <div id="remainingDaysDetails" style="display:none;margin-top:12px">
                            <div style="display:flex;align-items:center;gap:6px;font-size:12px;opacity:0.85">
                                <span style="padding:2px 6px;background:rgba(255,255,255,0.25);border-radius:12px">Gap to Target</span>
                                <span id="dashboardRemainingTarget" style="font-weight:600">Target pending</span>
                            </div>
                            <div id="dashboardRemainingCardMessage" style="margin-top:12px;font-size:12px;opacity:0.85">Upload sales targets to calculate the remaining gap.</div>
                        </div>
                    </div>
                </div>
                
            </div>

            <!-- Advanced Sales Intelligence Additions -->
            <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-auto-rows:1fr;gap:24px">
                <!-- Sales Forecast Card -->
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border:1px solid #e5e7eb;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-24px;right:-24px;font-size:90px;opacity:0.08">ğŸ”®</div>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">Sales Forecast</h3>
                        <p style="margin:0 0 12px 0;color:#6b7280;font-size:13px">Projected turnover based on recent momentum.</p>
                        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-bottom:12px">
                            <div style="background:#f3f4f6;border-radius:8px;padding:12px;text-align:center">
                                <div style="font-size:12px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.04em">Next 30 Days</div>
                                <div id="dashboardForecast30" style="font-size:20px;font-weight:800;color:#059669">R0</div>
                            </div>
                            <div style="background:#f3f4f6;border-radius:8px;padding:12px;text-align:center">
                                <div style="font-size:12px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.04em">Next 90 Days</div>
                                <div id="dashboardForecast90" style="font-size:20px;font-weight:800;color:#059669">R0</div>
                            </div>
                        </div>
                        <div id="dashboardForecastConfidence" style="font-size:13px;color:#1f2937;font-weight:600;margin-bottom:4px">Confidence: Pending data</div>
                        <div id="dashboardForecastMomentum" style="font-size:12px;color:#6b7280">Momentum: Waiting for sales history</div>
                        <div id="groupForecastList" style="margin-top:12px;font-size:12px;color:#374151;line-height:1.5;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px">Load sales data to surface group-level forecasts.</div>
                    </div>
                </div>

                <!-- Deal Velocity Card -->
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border:1px solid #e5e7eb;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-24px;right:-24px;font-size:90px;opacity:0.08">âš¡</div>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">Deal Velocity</h3>
                        <p style="margin:0 0 12px 0;color:#6b7280;font-size:13px">Cycle speed from first touch to close.</p>
                        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-bottom:12px">
                            <div style="background:#eef2ff;border-radius:8px;padding:12px;text-align:center">
                                <div style="font-size:12px;color:#6366f1;font-weight:600;text-transform:uppercase;letter-spacing:0.04em">Velocity</div>
                                <div id="dashboardDealVelocity" style="font-size:20px;font-weight:800;color:#4338ca">0 deals/week</div>
                            </div>
                            <div style="background:#fffbeb;border-radius:8px;padding:12px;text-align:center">
                                <div style="font-size:12px;color:#f59e0b;font-weight:600;text-transform:uppercase;letter-spacing:0.04em">Cycle Duration</div>
                                <div id="dashboardCycleDuration" style="font-size:20px;font-weight:800;color:#d97706">- days</div>
                            </div>
                        </div>
                        <div id="dashboardStageDurations" style="font-size:13px;color:#374151;margin-bottom:4px">Stage insights pending</div>
                        <div id="dashboardVelocitySample" style="font-size:12px;color:#6b7280">Upload transactional history to unlock velocity analytics.</div>
                    </div>
                </div>

                <!-- Top Customers by Sales Rep Card -->
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border:1px solid #e5e7eb;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-24px;right:-24px;font-size:90px;opacity:0.08">ğŸ†</div>
                    <div style="position:relative;z-index:1">
                        <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">Top Customers by Sales Rep</h3>
                        <p style="margin:0 0 12px 0;color:#6b7280;font-size:13px">Ten highest purchasing customers with their managing reps.</p>
                        <div id="topCustomersByRepContent" style="font-size:13px;color:#374151;line-height:1.6">No qualifying customers listed yet.</div>
                    </div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-auto-rows:1fr;gap:24px">
                <!-- Margin Intelligence Card -->
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border:1px solid #e5e7eb">
                    <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">Margin Intelligence</h3>
                    <p id="marginIntelligenceSummary" style="margin:0 0 12px 0;color:#6b7280;font-size:13px">No margin alerts yet.</p>
                    <div id="marginIntelligenceList" style="font-size:13px;color:#374151;line-height:1.5">
                        <p style="margin:0;color:#6b7280;font-size:13px">Upload sales with gross margin% to surface high-risk deals.</p>
                    </div>
                </div>

                <!-- Performance Trends Card -->
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border:1px solid #e5e7eb">
                    <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">Performance Trends</h3>
                    <div id="performanceTrendsContent" style="font-size:13px;color:#374151;line-height:1.6">
                        <p style="margin:0;color:#6b7280;font-size:13px">7-day and 30-day momentum will appear once sales are loaded.</p>
                    </div>
                </div>

                <!-- Conversion Funnel Card -->
                <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border:1px solid #e5e7eb">
                    <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">Conversion Funnel</h3>
                    <div id="conversionFunnelContent" style="font-size:13px;color:#374151;line-height:1.6">
                        <p style="margin:0;color:#6b7280;font-size:13px">Lead â†’ quote â†’ order conversion flow will appear with sales activity.</p>
                    </div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));grid-auto-rows:1fr;gap:24px">
                <div id="dashboardAlerts" style="background:linear-gradient(135deg,#fff,#fef2f2);border-radius:12px;padding:24px;box-shadow:0 6px 20px rgba(248,113,113,0.25);border:1px solid rgba(248,113,113,0.35);position:relative;overflow:hidden">
                    <div style="position:absolute;top:-32px;right:-32px;font-size:108px;opacity:0.05;color:#f97316">ğŸ“¢</div>
                    <div style="display:flex;gap:18px;align-items:flex-start;position:relative;z-index:1">
                        <div style="display:flex;flex-direction:column;align-items:center;gap:12px;flex-shrink:0">
                            <div style="width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#ef4444,#f97316);color:white;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 6px 14px rgba(239,68,68,0.35)">ğŸ’¬</div>
                            <div style="width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#f59e0b,#f87171);color:white;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 6px 14px rgba(248,113,113,0.35)">ğŸ“£</div>
                            <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEBAQEBAVEBANDQ0NDQoJDQ8ICQ4NIB0iIiAdHx8kKDQgJCYxJx8fJTItMSw1MDAwIx81OD8xODQtLy0BCgoKDg0OFhAQFTclFhktLS8tKzcrKzItKzctNzcrKzcrLS0rNTcrKzctKystKysrLS43Ky0rKy0rKys3KzgrN//AABEIAMgAyAMBIgACEQEDEQH/xAAcAAABBQEBAQAAAAAAAAAAAAAEAAIDBQYBBwj/xAA8EAABAwIEBAQCCQMCBwAAAAABAAIDBBEFEiFREzFBYQZxgZEioQcUIzJSscHR8EJy4VNiFSQzQ4KS8f/EABoBAAIDAQEAAAAAAAAAAAAAAAIDAAEEBQb/xAAqEQACAgEDBAEEAQUAAAAAAAAAAQIRAxIhMQQTQVEiBVJhcTIUIzNCgf/aAAwDAQACEQMRAD8Ae4pjl264Fxj3Gk4GpEJziFC9ytEoRAUL0nPUL5USAlR17gmAqJzk+MdfkjFaiS3ZdCe0qTh9UNlqSGsC3fhp32LP7T+ZWKiAWy8Pu+yb2B/NFEwfUXcF+ys8SO+0HkfzVM5XOOvGcX1+97Kv+HZLlsx/Sv8AtRK96HeFauaNlE5o2UUh/JVFqblVrkGyaWDZXrJo/JWZV3KrHINkuGNkWoB7FeGlTMjRscQ2RsNONkLkTXRVNgOynjgOyu4qYbIuOlGyG7BfUUU0FOdvkktAym7JKaRL6ncylk6yfZNKE64wgKJzApSmOKtEoHkYELIxEyOTALo0JnFA7IupUoCmsugK7M7ORsRUbFGxTxuQsBnDCeYWkwJ3wDyKp4nK3wzlp3R4zD1ruC/YJi7Mzgf7lW2sdVY4lJqO+ZBSG4Qy5G9P/jR1rAU/ghBcctNjyRTZtEDTRpi7OPiCgkaE6eUoR8hUSCJ2sCmEQQsd1Kbq2Do9sIZlCMie1VTGHsiY4T2UAnBey4imajI6pio2QnspmxHsoIlCPsujVNSVQITuEkSbEvHH2VjgoyFI5MJSjvpjENMeikmktoFASiRdkRaU+y60qQxk9EQjIwdt72PLopQEnwkgjkenmpYYjYXGvXzVmaTONCkYFKyFTRw9lQpyGRkq4w136oWGFvVT0zgHEDlcpmPkxdU7iiDE4HOs4dC4W7Kua07rQZwGi4v8TteltFUzyNBOm6p8jMEqgivnj3Q0M1ri/JOr6tvIKsdP7lEo2tx+osnzj1XWM6lBUw6keiJMnZDL8DoLywphUt0Gx/ZPL+yCiN7hcZ7hFxkbhVbH9kSyTsoLmi0jeNx8lOx43CqWy9lI2Y7IhEkXAeNwkqnjHZJWK0kDkNNLbQc1JUy28+iANz3J9SlJHaeStjpKZm7p7qZ/UaKLKjoHuC41iiIKsIN7FAQWnsi0piJ5Wv0aBrgdQpGFV1BNy10V7FTZhcIdJnnkZFGQeSc6ZrdydmDMUKKUGUll2kEtcWkhrnddFYNoS0A+6CUkuCQg5bsgjrmf1Bze7gLKWB4LyWkEE6EG4IQeIwbbKnirXwPuNR1Y77pCZilYjqMTrY1NTJZgG7n/AKKhr6gAH1RtTWtkjje06OzXHIg7FZ2vlvfYfMpqjbAxuooGmnubn0CfTQ3+I+gTKWEE3PsjcwUk/CNmLE3uyQeScCFAZAmGVL0jmmHscE8uCrRN3XTL3U0i9LLFkgUomCpxJ3T+KN1NJUoMuBUtXRVhVAlG6dxxurFvGWxqxskqr6wEle4PbD36m55norjDMLAGdw+I8hsE/B8Lv9o8f2tO6vOCs8n4RqlOv2V/1Ruyra/CBq5g82rRtgUgp1StCu7RgeGNkx8APRa3FsCzDPGPi5lg5FZ/g62PMXBB0N06LC7ikil1idfm0rR4ViYAvodCQOl0DUUoIIPVVdPDIyTKNWnchuia0mrMU5NOvBqMLAALnH/ydpqj5pGZdHA32cCVSOIDAS0v5/Zt+8SqmnY+Wb4YhCQSb8TiEDusui9zSsjVJIva1/wXOpuWgA62Wbr2jXX53KJx1r+IGNcS0sacoOUkqllsPh4b2EH7z3Z2kpuOG1i82R3VD6OqLS9pPwus63S/X9F2eUOAA3QcbLvPYKR8dlrirRkU3F2FQvsibA6j2VYyRFwzWS5RaOngzxkh7k0qcgOFx6hROCAexi6VxdAVg2cslZdskrIcslZdSsoQ5ZdSSUKPXmRABOEaixIDhPu7JYXzg2sUHgMz5nF73WyDJwW3br+IrJRh3pyLVsSlbEpWsUzGIlEzyyEbIlVY1gAkBkjFnjm0aBy0UbFMGJiQjvNO0eTzMIJBFiNCDobqKGMZiSLlrS4eYW+8ReHhMC9mkg59A4LIfU3wuzWvYEFp5EJj3ix0MqbTG0jx9xwHUHZC12JxxZw1tmMIa50bNHybCy7G/U2Fj8Vmm2a6EbVmMcMQvkdc53sYSzPzOqzqG5v1/EqcXxSN0rSwWt5uHkmVORzA8DnqBc2B8lFibC0lxicLkk5bOCgYDwy46AkWadDdaNKpUZ9bt2MgaDc2/qBG6JIBWg8EYRxXB8jLx5ZPjd1cdNPdQ+JsCdSvzN1jcTZ2yfjM0siujMyx25JMeiDYhDPZZG42CpODuIZBLZFlocLjn1Cq43IqGYg3CRKNHV6fqFJUxxYuWRbgHi45jmEO4IDS40MASsnALqgIwhIJ9lzKrINIST2hJQqj1ueJrxZ4uAQbHldPhp2B5kAs8tDCRcAhBUdY2Qc9UW3QrNRglFrZliwoqMIGJygixdpkcBbhRXE1Q92SMSdGjc7piMk4tl9GFKAooypQUyKMchrlmMZYwBx81e11SACsH4lxHQi+mt1aVsZBMoZ5xxDY2ueexVhDZ7DrYi5Pms/RU0kzJZrExh7WZxfR2qhfPNHcDUHTZDPHcjfiy1FWF4nT6avuM1u6oaqXoOTb+6lqauRwt07aoLhnqmRhXIGXIpcHqfgeK1OBsQPXKFf1dEyVhY8Xa7p1VT4NA+rnvJ10P3WrQtTKo57e55T4n8OPpXZ2XdEevOyoOa9zqKZkjSx4Ba4EEHVeZ+KfCz6ZxkjBdCbnTUsTFK+RuOfhmTey2o9ko5FO5qHkZbUcuoVtWMTcHa4C4Z7HRG5Q8XHPqFURORlPNYrPOFHW6bqVJUyUtsuEIokOGYc+qjypZqaIWhSBq6Qk1WUE4Zhr6iRscYu53o1o3PZJFYDT1D5mCnuJAbh40DRueySujJmyyjKlJIs6N7mEWOnzBWtw6UPFidf1VC6m6geY6EKSnnLCCOXzBWfndFzV/F/8Zoqykc5haHlma3xsF3W62QOEYfxC1z2lkMJ+wpnXBLvxu7o/D65rxZ3NWDG90UfwYZuUbiwuMqOpqco5oaeqDRZZrG/EMMAJlkDdCQy+aU+QR34Rnjivd8BuI1nPXdeeeJa9pJBcANb3PxHsqrH/ABrLNdsA4TDf4zZ07h+iyxlvckkk83OJLrrTjxNbsGeWK2R7H9FMjX0lQCA5pqnCSNwDhwy1tkHU4eyodUOoyXxQvLSyVuV5G7fxDnsVVfRJWv8A+dp2WMk8THQiQ5WB4uCT7j2XoWAeG3U8eXP8d2vc2OwOYeac8UZcioZpQdo8rqaYDUfIWU2E4WZnFzhlhiuXudZoe618o3KvceoOFUyREWJDZGMtd2U/5v7KtxCkMhAZoInHghtiGC+nql4cblJp+DTnyKME4/7EuF+JvqVU1kxIpqpgJcQSIpfxeXIFekUlSyRofG9r2OFxJG4PYR5rxXxuTaBjm5Xta4u6t1tyWboMSnp3XhlfETz4TzGD57psoGGz6XaVOYmvaWuAIOhB1C8Qwj6Sq2IgTBtQ0c84EE1vMafJb/AfpFoZyGuead5t8NXZkZPZ3L3skuDQVld4l8ICOS7DZj7kADQFZjEMFMYJvfmvT8cxKM5QCCG3NwQ5t1574lxQG7W8+vkiTZphLbcypZY9tT6p8b1BJLfkiKClLzs0cypOq3LwanOoFjh9yDtop3Nsuts0Wb0Ud1l5Z6CPxikztkZhmGSVEgjibmcfRrRuTsmUNG+Z4YxpcTzytLg1u57LX4pfCXRCmkDnSN+3imDXl1uR3A59VaRny5q+Mf5M54VjmoKkxTxljKizBLYOj4nSxXUbQ+OoZBkqYst7Xe0Coh9uf5pItjlZoZJSuUNyMhBVTOo9R0IR8zcp1/whpLLItnZ1bUkAw1ZYQR935tWnocUDmC51CydTHY3A8x0KqsXrnQ08pYbZmlg6Oa46fqmpauDNkqqn48gPirxzNLJJHARHEHOa2WO/GeB1v0v2WKnmLiSSSTzLiS4lNldy81E5y3xgorY485uXJwldCYnhMANf9GFWI8RiB5StkhNtdSLj5gL3qR9st/Rw53Xzb4YqeDV00h0DKiEuP+24v8l9F4o7Kxh2c0+iGXJa4M34mgNTUkRtGaGPhmSxzEcyPL/KkofDrYWAyWLjZxA5ALQUkID5Db75LvmuY5/0nuH+k8/JE5OqRR4P9Ik4fVm3Rg06C5J/Kyyb7fzVW3iWo4lTI7uG+wA/RVDlChoOvoE66jaeZ3J9l0uUIWVDjs8DcrXks/03kuaPLZFS1hfqDfNY3PNZ9xuFb4JHnb/a4goZUlY7EpTelFhR0+Y68uquY7AWHJCxADQIpiyTlqZ3emwrEvyOUtPA+Q5WNL3HkyNpe4+gXIYy9zWt1LnBrR3K9KZD/wAOZBDTwcaaoJ4kpOQEi17noNVSRM+fRSS3ZUeDMQFI8w1MRhMxBbUTMdE6+xv0Vp418PGoHHh1kYzK6PnxGdu6nx531y9JE1rnNyuqKh3xxU/YbuWQg8V1MML6cHNYlkc7tZI29t+2ytmGEZTn3I7S8ooHaaEWIvcHQ3STXOJNybkkkk6kldQnVR6a6xFihXQhN44TH1KztmeMJLgiqIxqsJ41lyxho/rkB9B/9C2FVUnVYDxvPd8bPwsc4+ZP+E3ArmhPVusbsytQ/T2XCmVPJKM3APYe66RxB4XQuJzVCieNfRFPWCegppb34kETj/dbX5r52jK9g+j7EOJhTmE/FSzSMG+U6j8z7KS8Fo9Fpm6j+0H0UWLAFjh0MT/aynpo7EHdjdrXsqXxzVmCjnkHMU8rAdnOFh8yqZD5wq33e47uJQr3aH+aqSQ80PMeQ3N/RWUJcc5Me8bqNz9D/NVCDxrbyurzw27SQbOabKjDgPM8h1VjgUlpSPxNPugyK4mnpJacqZscPpHzSMjjF3SEADkF6HR4bh1GBHOWSTFuZ3GbxSfIdO3UrIeCK6OGpDpCAHMcwPdo1rjbX5W9V6DMaGKQ1LyziOA+0zcWQ6W0H7LEdLPkbdb1+DLyYDVSSmop6XgsDw+KJzmsfYcjYn5LaUONwTxlrn8GXKWSQyOEE8butr/mhMC8R/Wp3RshIjDS7jOdc+o5C/msr44LDWPydGMEhFrcS37WRCtMs0tEtqLHE8UpqKJ8FG/iSyk8SozCUt73HMrEFSFq5lVNnQxYVBe2R2SU7Iup5BJUO0mjNT3TH1HdV/ETXSJGkfoQQ+Uk81gvFM2apk1uGZWD0H73WzEiwGKPzSyneWQ+l1p6aPybOT9U+MEvbK+TVRUp5jY/JSPKggPxkbgFbjhBKe0phK6CrITMK3f0ZVuWSogJ0mjjlAPLMx37E+ywLSrvwxWcGqhf0z5HeR0VlH0rEf52WB+mGvyUXD/13Mb6A3/RbSjqs+Q20cxrh01tdeYfTnUDJSMvqeM4ga6afuUKLPI3lDPOp7WClkdYX2uhr6fzmrINkKhedPP806Ry5GLuaO91CBMLLann7qbC3/bs7uIUchsEqD77Ts9v5oXwHjdSRsGEhaTwpXU8UuecOOW3DLQHsa7chZqF99CiY9FkaO8lao9FxLxhG1hbSj4n3vMWcNoO9up81jJXFxJJJLiSXE5nEqGMqYBAPw4YwWxGpWDS55BdazqeQQlXUdBy2U5HtqCtjauo6DkuoB5JSTlj2OXl6puWxocy4XI0UnZNdTdlltHa1Ir3PWGlNyTuSV6DPTmx01yn3Xnr1q6bycP6tK9C/YFJohQbPB3uEbOEBPv15jzWo4wdm5KRgQ8Ju1p3ARDFChONkVHJaxHMWcPNCPKliP8AO6tFM+j/AAnWiWjp5BreJoO9xovJvplrQ+tbGOUMDWkf7iSfystX9FmKg0ZjcdYXO07LzDxxWcWuqXk/957ddhp+iHhheDO1DuQ31PkoXlIOzEn28k2RWUMcU6m+95D5qNykpOpPLQeqhZLUHkOpRNKyxHmEKx1zcC5PLYKwoYi57Be5L2+Sp8BR5L+FyOhduomUxCIjiWVnax5KCYUZGANSmU0QU0kYslM6EMiSsFqJvZVsjrlWE0V9AjMKwQyOA6f1O6AI40tzLmm57AOFYW6dwAFh/U7oAkvRaGgjhaGtHmdMxK4heV+DNSXA3/hlup9gopcP/mUJJLX2oejmf1Wb72CS0Z7f+oXjlSCCRY6Ej1XEkyMFG6FTyzn/ACd0BTg8yhnRk9D1SSUBCYB8I0/pCnaDskkoQa8ap7QkkrRTNh9G2IcOdzCbNcWuN9RyP7LEY5Ul8sjuskj3nyJuupKnyF4AYwUx4KSShRE6+ymgc2wB6edrpJKFhbG7fK60Xg2hE1QSQcsMbnHmPiOg/MpJKmRcm9ZhEex9ypW4NFsfdJJDpQayS9hMWER9/dENwWM883uF1JVpj6L72T7h7cAi/wB3uP2R1PS8MWbcDyBP5JJKOEfRfdyfcS5HfiPs39kkklO3H0D3sn3H/9k=" alt="Sales lead alert" style="width:140px;height:140px;border-radius:24px;object-fit:cover;border:3px solid rgba(248,113,113,0.7);box-shadow:0 12px 22px rgba(15,23,42,0.25)"/>
                        </div>
                        <div style="flex:1 1 auto">
                            <h3 style="margin:0 0 10px 0;font-size:18px;color:#1f2937;font-weight:700">Sales Alerts</h3>
                            <div id="dashboardAlertsMessage" style="font-size:13px;color:#374151;line-height:1.7">
                                <p style="margin:0;color:#6b7280">Upload sales data to generate contextual alerts.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dashboardRecommendations" style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border:1px solid #e5e7eb">
                    <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">ğŸ¯ Target Recommendations</h3>
                    <p style="margin:0;color:#6b7280;font-size:14px">Upload sales data and corresponding targets to surface tailored recommendations.</p>
                </div>
            </div>
            
            <!-- Dashboard Charts Section -->
            <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 4px 15px rgba(0,0,0,0.08);display:flex;flex-direction:column;gap:24px">
                <h3 style="margin:0 0 20px 0;color:#1f2937;font-size:18px;font-weight:600">ğŸ“Š Performance Analytics</h3>
                
                <!-- Quick Stats Row -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin:0;padding:16px;background:#f8fafc;border-radius:8px">
                    <div style="text-align:center">
                        <div id="dashboardTotalDeals" style="font-size:24px;font-weight:800;color:#059669;margin-bottom:4px">0</div>
                        <div style="font-size:12px;color:#6b7280">Total Deals</div>
                    </div>
                    <div style="text-align:center">
                        <div id="dashboardAvgDealSize" style="font-size:24px;font-weight:800;color:#3b82f6;margin-bottom:4px">R0</div>
                        <div style="font-size:12px;color:#6b7280">Avg Deal Size</div>
                    </div>
                    <div style="text-align:center">
                        <div id="dashboardTopDivision" style="font-size:24px;font-weight:800;color:#8b5cf6;margin-bottom:4px">-</div>
                        <div style="font-size:12px;color:#6b7280">Top Division</div>
                    </div>
                    <div style="text-align:center">
                        <div id="dashboardTopRep" style="font-size:24px;font-weight:800;color:#f59e0b;margin-bottom:4px">-</div>
                        <div style="font-size:12px;color:#6b7280">Top Rep</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div id="dashboardChartsWrapper" style="margin-bottom:24px">
                    <p id="dashboardChartMessage" style="margin:0 0 16px 0;color:#6b7280;font-size:13px">Upload sales data to unlock visual insights.</p>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;align-items:stretch">
                        <div class="chart-card" style="position:relative;padding:20px;border:1px solid #e5e7eb;border-radius:14px;background:#f9fafb;display:flex;flex-direction:column;height:320px">
                            <h4 style="margin:0 0 12px 0;color:#0f172a;font-size:15px;font-weight:600">Sales vs Forecast by Group</h4>
                            <canvas id="turnoverTrendChart" style="flex:1 1 auto;width:100%;min-height:0"></canvas>
                            <div id="turnoverTrendEmpty" style="position:absolute;inset:64px 24px 24px 24px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:13px;text-align:center;background:rgba(255,255,255,0.82);border-radius:12px;padding:16px">Need at least two months of sales to plot group trends.</div>
                        </div>
                        <div class="chart-card" style="position:relative;padding:20px;border:1px solid #e5e7eb;border-radius:14px;background:#f9fafb;display:flex;flex-direction:column;height:320px">
                            <h4 style="margin:0 0 12px 0;color:#0f172a;font-size:15px;font-weight:600">Turnover Target Progress</h4>
                            <canvas id="turnoverProgressChart" style="flex:1 1 auto;width:100%;min-height:0"></canvas>
                            <div id="turnoverProgressEmpty" style="position:absolute;inset:64px 24px 24px 24px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:13px;text-align:center;background:rgba(255,255,255,0.82);border-radius:12px;padding:16px">Upload turnover targets to visualise progress.</div>
                        </div>
                        <div class="chart-card" style="position:relative;padding:20px;border:1px solid #e5e7eb;border-radius:14px;background:#f9fafb;display:flex;flex-direction:column;height:320px">
                            <h4 style="margin:0 0 12px 0;color:#0f172a;font-size:15px;font-weight:600">Rep Momentum</h4>
                            <canvas id="repMomentumChart" style="flex:1 1 auto;width:100%;min-height:0"></canvas>
                            <div id="repMomentumEmpty" style="position:absolute;inset:64px 24px 24px 24px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:13px;text-align:center;background:rgba(255,255,255,0.82);border-radius:12px;padding:16px">Awaiting rep performance data.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Table -->
                <div style="max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px">
                    <table id="dashboardTable" style="width:100%;border-collapse:collapse">
                        <thead style="background:#f9fafb;position:sticky;top:0">
                            <tr id="dashboardTableHeader">
                                <th style="padding:12px;text-align:left;border-bottom:1px solid #e5e7eb;font-weight:600">Division</th>
                                <th style="padding:12px;text-align:left;border-bottom:1px solid #e5e7eb;font-weight:600">Sales Rep</th>
                                <th style="padding:12px;text-align:right;border-bottom:1px solid #e5e7eb;font-weight:600">Turnover</th>
                                <th style="padding:12px;text-align:center;border-bottom:1px solid #e5e7eb;font-weight:600">Deals</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody">
                            <tr>
                                <td colspan="4" style="padding:40px;text-align:center;color:#6b7280;font-style:italic">Upload sales data to view dashboard analytics</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </section>

    <!-- Financial Section -->
    <section id="financial" class="card view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:10px">
                <button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px">â† Back</button>
                <h2 style="margin:0">ğŸ’¼ FINANCIAL</h2>
            </div>
            <button onclick="toggleFinancialFilters()" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">ğŸ” Filters</button>
        </div>

        <!-- Financial Filter Panel -->
        <div id="financialFilters" style="display:block;background:#f8fafc;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0">
            <h3 style="margin:0 0 16px 0;color:#1f2937;font-size:18px">ğŸ’¼ Filter Financial Data</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Date Range From:</label>
                    <input type="date" id="financialDateFrom" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Date Range To:</label>
                    <input type="date" id="financialDateTo" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Department:</label>
                    <select id="financialDepartmentFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Departments</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Amount Range:</label>
                    <select id="financialAmountFilter" multiple size="5" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Amounts</option>
                        <option value="0-10000">R0 - R10,000</option>
                        <option value="10000-50000">R10,000 - R50,000</option>
                        <option value="50000+">R50,000+</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:12px">
                <button onclick="applyFinancialFilters()" style="background:#059669;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Apply Filters</button>
                <button onclick="clearFinancialFilters()" style="background:#6b7280;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Clear All</button>
            </div>
        </div>
        <div id="financialContent">
            <p style="color:#6b7280;text-align:center;padding:40px">Upload financial data in Master Data section to view financial reports here.</p>
        </div>
    </section>

    <!-- KPI Metrics Section -->
    <section id="kpi" class="card view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:10px">
                <button onclick="showView('home')" style="background:#fff;border:1px solid #ddd;color:#333;margin-right:15px">â† Back</button>
                <h2 style="margin:0">ğŸ¯ KPI METRICS</h2>
            </div>
            <button onclick="toggleKpiFilters()" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">ğŸ” Filters</button>
        </div>

        <!-- KPI Filter Panel -->
        <div id="kpiFilters" style="display:block;background:#f8fafc;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0">
            <h3 style="margin:0 0 16px 0;color:#1f2937;font-size:18px">ğŸ¯ Filter KPI Data</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Date Range From:</label>
                    <input type="date" id="kpiDateFrom" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Date Range To:</label>
                    <input type="date" id="kpiDateTo" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Department:</label>
                    <select id="kpiDepartmentFilter" multiple size="6" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Departments</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#374151">Performance Level:</label>
                    <select id="kpiPerformanceFilter" multiple size="4" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px">
                        <option value="" disabled>All Performance</option>
                        <option value="high">High (80%+)</option>
                        <option value="medium">Medium (60-80%)</option>
                        <option value="low">Low (<60%)</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:12px">
                <button onclick="applyKpiFilters()" style="background:#059669;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Apply Filters</button>
                <button onclick="clearKpiFilters()" style="background:#6b7280;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer">Clear All</button>
            </div>
        </div>
        <div id="kpiContent">
            <p style="color:#6b7280;text-align:center;padding:40px">Upload KPI data in Master Data section to view performance metrics here.</p>
        </div>
    </section>
</main>

<footer style="text-align:center;padding:18px;color:#6b7280;margin-top:20px">Built with HTML, CSS, and JavaScript</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
// Authentication
document.addEventListener('DOMContentLoaded', function() {
const signinForm = document.getElementById('signinForm');
const verifyForm = document.getElementById('verifyForm');
const emailInput = document.getElementById('emailInput');
const authCode = document.getElementById('authCode');
const signinPage = document.getElementById('signinPage');
const mainApp = document.getElementById('mainApp');
const userEmail = document.getElementById('userEmail');
const AUTH_STORAGE_KEY = 'reportingDashboardUser';
const DEFAULT_AUTH_CODE = '000000';
let pendingSigninEmail = null;

function showNotification(message, type = 'info') {
const notification = document.getElementById('authNotification');
notification.style.display = 'block';
notification.textContent = message;
notification.style.backgroundColor = type === 'error' ? '#fee' : type === 'success' ? '#efe' : '#eef';
notification.style.color = type === 'error' ? '#c00' : type === 'success' ? '#060' : '#006';
if (type !== 'error') setTimeout(() => notification.style.display = 'none', 3000);
}

signinForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const email = emailInput.value.trim().toLowerCase();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showNotification('Please enter a valid email address.', 'error');
        emailInput.focus();
        return;
    }
    pendingSigninEmail = email;
    signinForm.style.display = 'none';
    verifyForm.style.display = 'block';
    authCode.value = '';
    showNotification(`Verification code sent to ${email}. Use ${DEFAULT_AUTH_CODE} to sign in.`, 'info');
    authCode.focus();
});

verifyForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const code = authCode.value.trim();
    if (code !== DEFAULT_AUTH_CODE) {
        showNotification('Invalid verification code. Try 000000.', 'error');
        authCode.focus();
        return;
    }
    const email = pendingSigninEmail || emailInput.value.trim().toLowerCase();
    if (!email) {
        showNotification('Please restart the sign in process.', 'error');
        verifyForm.style.display = 'none';
        signinForm.style.display = 'block';
        return;
    }
    completeSignin(email);
});

function completeSignin(email) {
    pendingSigninEmail = null;
    try {
        localStorage.setItem(AUTH_STORAGE_KEY, email);
    } catch (err) {
        console.warn('Unable to save sign-in state', err);
    }
    userEmail.textContent = email;
    signinForm.reset();
    verifyForm.reset();
    verifyForm.style.display = 'none';
    signinForm.style.display = 'block';
    signinPage.style.display = 'none';
    mainApp.style.display = 'block';
    showView('home');
}

window.signOut = function signOut() {
    pendingSigninEmail = null;
    try {
        localStorage.removeItem(AUTH_STORAGE_KEY);
    } catch (err) {
        console.warn('Unable to clear sign-in state', err);
    }
    mainApp.style.display = 'none';
    signinPage.style.display = 'flex';
    signinForm.reset();
    verifyForm.reset();
    verifyForm.style.display = 'none';
    signinForm.style.display = 'block';
    emailInput.focus();
    showNotification('Signed out. Enter your email to continue.', 'info');
};

try {
    const savedEmail = localStorage.getItem(AUTH_STORAGE_KEY);
    if (savedEmail) {
        completeSignin(savedEmail);
    }
} catch (err) {
    console.warn('Unable to read saved sign-in state', err);
}

}); // End authentication bootstrap once DOM is ready

// Master Data Management
const masterData = {
sales: null,
revenue: null,
customer: null,
operational: null,
marketing: null,
inventory: null,
pricing: null,
targets: null,
hr: null
};

const templates = {
sales: 'Cal. year / month,Sales Region,Region,Sales Territory,CSC Name,Sales Area,Sales group code,Sales group,Sales Division code,Sales Division,Customer number,Customer name,Turnover,CostPFEP,GrossProfitPFEP,GrossProfit%PFEP,Order LinesLines\n07.2025,296,National Sales,2013,"LOFTIE EATON, DIAN",64939,ASM27,"ASM Group 27 - AU/ME/WO",AU,Auto,128000309,"Kleynhans Bakeries",84313.54,16480.00,67833.54,80.45,3\n07.2025,296,National Sales,2029,TEUNISSEN CHAVONNE,65738,REG03,"Region 3 Support",ME,Auto,128000479,"M. Briers Landgoed",80861.81,3370.42,77491.39,95.83,11\n07.2025,296,National Sales,2030,TALJAARD SUSANNA,64913,ASM21,"ASM Group 21 - AU/CA",CA,Auto,128017889,"Albertinia Meubel",40268.68,2051.47,38217.21,94.91,10',
revenue: 'Date,Revenue Stream,Amount,Cost,Profit Margin,Department,Currency\n2024-01-15,Product Sales,25000,15000,40%,North,USD\n2024-01-16,Service Revenue,12000,8000,33%,South,USD',
customer: 'Customer ID,Customer Name,Segment,Region,Acquisition Date,Lifetime Value,Status\nCUST001,ABC Corp,Enterprise,North,2023-05-15,45000,Active\nCUST002,XYZ Ltd,SMB,South,2023-08-22,12000,Active',
operational: 'Date,Process Name,Efficiency Rate,Quality Score,Downtime Hours,Cost Center\n2024-01-15,Production Line A,95%,98%,2,CC001\n2024-01-16,Quality Control,88%,96%,1,CC002',
marketing: 'Campaign ID,Campaign Name,Start Date,End Date,Budget,Impressions,Clicks,Conversions,ROI\nCAMP001,Q1 Launch,2024-01-01,2024-03-31,50000,100000,5000,250,120%\nCAMP002,Spring Sale,2024-03-01,2024-04-30,25000,75000,3500,180,95%',
inventory: 'Item Code,Item Name,Category,Current Stock,Reorder Level,Unit Cost,Supplier\nITM001,Laptop Pro,Electronics,45,20,1200,TechCorp\nITM002,Office Chair,Furniture,12,5,350,FurnishCo',
targets: 'rep_id,year,month,Turnover target,Lines target,Actives target,Customer Balance Target,New Business target,Conversion target\n2267,2025,1,175667,474,40,3,,\n2267,2025,2,207000,474,40,3,,',
pricing: 'Sales Branch,Sales Area,Rep Code,CSC Name,Product name,Sum of Invoice Quantity,Sum of Turnover,Sum of GrossProfitPFEP,Targets February 2026,Still Needed,% Achieved,% GP %\nRegion 1,ASM Group 06 - CA,4288,GRP06_ME,Product A,1763,28099.18,17239.44,27972.35,-126.83,100%,61%\nRegion 1,ASM Group 14 - AU/ME,4262,NAIDOO, KURT,1002,20457.83,10610.38,20604.18,146.35,99%,52%\nRegion 1,ASM Group 14 - AU/ME,4320,WILLIAMS, JOASH_ALISIDAIR,953,27787.24,16158.22,31930.86,4143.62,87%,58%',
hr: 'Employee ID,Department,Position,Hire Date,Performance Score,Training Hours,Satisfaction Rating\nEMP001,Sales,Manager,2023-01-15,4.2,40,8.5\nEMP002,Marketing,Analyst,2023-03-10,3.8,25,7.8'
};

// Normalized sales data cache to keep expensive parsing work off the UI path.
const salesNormalizationState = {
    sourceRef: null,
    normalized: [],
    meta: {
        divisions: [],
        salesGroups: [],
        businessCos: [],
        salesReps: [],
        customers: [],
        dateInfo: null,
        totals: {
            turnover: 0,
            units: 0,
            cost: 0,
            grossProfit: 0,
            orderLines: 0
        }
    },
    cacheToken: 0,
    cachedRevision: -1
};

const groupSlicerState = {
    selectedGroup: null,
    open: false
};

let activeView = 'home';

const SALES_FIELD_ALIASES = {
    date: ['date', 'sales date', 'transaction date', 'deal date', 'order date', 'period', 'document date', 'cal. year / month', 'cal year month'],
    turnover: ['turnover', 'revenue', 'amount', 'sales', 'value', 'total', 'price', 'net amount', 'gross amount', 'invoice amount', 'income'],
    division: ['division', 'department', 'region', 'business unit', 'branch', 'sales division', 'sales division code', 'sales branch'],
    salesGroup: ['sales group', 'salesgroup', 'group', 'channel', 'segment', 'sales area'],
    salesGroupCode: ['sales group code', 'group code', 'sales region', 'sales region code', 'sales regi', 'region code'],
    businessCo: ['csc name', 'business co', 'business company', 'business', 'company', 'business unit', 'entity', 'sales territory'],
    salesRep: ['sales rep', 'salesrep', 'sales representative', 'representative', 'rep', 'salesperson', 'sales person', 'account manager', 'csc name', 'rep_id', 'rep id', 'rep code'],
    customer: ['customer', 'customer name', 'client', 'account', 'client name', 'account name', 'customer description', 'sales territory'],
    customerId: ['customer id', 'customer number', 'customer no', 'cust number', 'customer #', 'customer code', 'customer ref', 'account number'],
    units: ['units sold', 'units', 'quantity', 'qty', 'volume', 'order qty', 'order lines', 'order lineslines', 'order lines lines', 'sum of invoice quantity', 'invoice quantity'],
    target: ['target achievement', 'achievement rate', 'target %', 'target', 'targets', 'achievement', 'targets february 2026'],
    cost: ['cost', 'costpfep', 'cost pfep'],
    grossProfit: ['grossprofit', 'gross profit', 'grossprofitpfep', 'gross profit pfep', 'sum of grossprofitpfep'],
    grossMargin: ['grossprofit%pfep', 'grossprofit%', 'gross profit %', 'gross profit%', 'margin %', 'gross margin', 'gross margin %', '% gp %'],
    orderLines: ['order lines', 'order lineslines', 'order lines lines', 'orderlines', 'orders', 'order count'],
    productName: ['product name', 'product', 'item', 'item name', 'material', 'material description', 'material name', 'product description'],
    productCode: ['product code', 'item code', 'sku', 'material code', 'product id', 'material number'],
    productCategory: ['product category', 'category', 'family', 'line', 'product line', 'segment category'],
    powerProduct: ['power product', 'power products', 'power', 'power item', 'powerproduct', 'power product flag'],
    salesSector2: ['sales sector 2', 'sales sector', 'sector 2', 'sales sector2', 'sector two']
};

const PRODUCT_FIELD_ALIASES = {
    division: SALES_FIELD_ALIASES.division,
    salesGroup: SALES_FIELD_ALIASES.salesGroup,
    salesRep: SALES_FIELD_ALIASES.salesRep,
    repCode: ['rep code', 'rep_code', 'rep id', 'rep_id', 'rep number', 'rep#', 'repid'],
    businessCo: SALES_FIELD_ALIASES.businessCo,
    productName: ['product name', 'item description', 'product description', 'item name'],
    productCode: ['product code', 'sku', 'item code', 'product'],
    productCategory: SALES_FIELD_ALIASES.productCategory,
    turnover: ['sum of turnover', ...SALES_FIELD_ALIASES.turnover],
    grossProfit: SALES_FIELD_ALIASES.grossProfit,
    grossMargin: SALES_FIELD_ALIASES.grossMargin,
    units: SALES_FIELD_ALIASES.units,
    powerProduct: SALES_FIELD_ALIASES.powerProduct,
    salesSector2: SALES_FIELD_ALIASES.salesSector2,
    target: SALES_FIELD_ALIASES.target,
    targetAchievement: ['% achieved', 'achieved %', 'target achieved', ...SALES_FIELD_ALIASES.target],
    stillNeeded: ['still needed', 'gap', 'remaining']
};

const SALES_CURRENCY_KEYWORDS = ['turnover', 'revenue', 'amount', 'value', 'sales', 'total', 'price', 'income', 'invoice', 'net amount', 'gross amount', 'cost', 'grossprofit'];
const SALES_PERCENT_KEYWORDS = ['rate', 'achievement', 'margin', 'roi', '%', 'ratio', 'growth'];

const SALES_TABLE_DEFAULT_ROWS = 50;
const SALES_TABLE_INCREMENT = 50;
const DAY_IN_MS = 86400000;
const COMPANY_END_DATE = new Date('2026-12-15');
const SOUTH_AFRICA_HOLIDAY_CACHE = new Map();
const CUSTOMER_TABLE_DEFAULT_ROWS = 50;
const CUSTOMER_TABLE_INCREMENT = 50;

const salesTableState = {
    visibleRows: SALES_TABLE_DEFAULT_ROWS,
    totalRows: 0,
    currentData: []
};

const customerTableState = {
    visibleRows: CUSTOMER_TABLE_DEFAULT_ROWS,
    totalRows: 0,
    currentData: []
};

const productFilterState = {
    division: [],
    sector: [],
    reps: [],
    power: '',
    productSearch: ''
};

const PRODUCT_TABLE_DEFAULT_ROWS = 100;
const PRODUCT_TABLE_INCREMENT = 100;
const productTableState = {
    visibleRows: PRODUCT_TABLE_DEFAULT_ROWS,
    totalRows: 0,
    rows: []
};

const productNormalizationState = {
    sourceRef: null,
    normalized: [],
    meta: {
        divisions: [],
        salesGroups: [],
        salesReps: [],
        products: [],
        productCodes: [],
        salesSectors: [],
        powerFlags: [],
        totals: {
            turnover: 0,
            grossProfit: 0,
            units: 0
        }
    },
    cacheToken: 0,
    cachedRevision: -1
};

const CUSTOMER_FIELD_ALIASES = {
    customerId: ['customer id', 'customer number', 'customer no', 'customer code', 'customer - sales view', 'account number', 'customer reference'],
    customerName: ['customer name', 'client name', 'account name', 'customer'],
    customerStatus: ['customer status', 'status'],
    salesRep: ['sales rep', 'sales representative', 'rep', 'account manager', 'csc name'],
    salesArea: ['sales area', 'area'],
    salesTerritory: ['sales territory', 'territory'],
    salesDivision: ['sales division', 'division', 'business unit'],
    salesGroupCode: ['sales group code', 'sales group id', 'group code'],
    salesGroupName: ['sales group name', 'sales group', 'group name'],
    businessCode: ['business code', 'business co', 'business company', 'company code'],
    orgUnit: ['org unit', 'orgunit', 'org. unit assigned'],
    email: ['email', 'e-mail', 'email address', 'e-mail address'],
    phone: ['phone number', 'phone', 'telephone', 'mobile phone number'],
    lastOrderDate: ['date last order', 'last order date', 'last order'],
    period: ['cal. year / month', 'cal year month', 'period', 'month'],
    orderCount: ['number of records', 'orders', 'order count', 'records']
};

const customerNormalizationState = {
    sourceRef: null,
    normalized: [],
    meta: {
        divisions: [],
        salesGroups: [],
        businessCodes: [],
        salesReps: [],
        statuses: [],
        territories: [],
        dateInfo: { minDate: null, maxDate: null }
    },
    cacheToken: 0,
    cachedRevision: -1
};

const salesDrilldownState = {
    summary: null,
    normalized: [],
    targetSummary: null,
    options: {}
};

const customerDrilldownState = {
    summary: null,
    dataset: [],
    options: {},
    insights: []
};

const drilldownUiState = {
    overlay: null,
    dialog: null,
    titleEl: null,
    contentEl: null,
    closeBtn: null,
    active: false,
    lastFocus: null,
    originalOverflow: ''
};

function setSalesDrilldownState(summary, normalized, targetSummary, options = {}) {
    salesDrilldownState.summary = summary || null;
    salesDrilldownState.normalized = Array.isArray(normalized) ? normalized : [];
    salesDrilldownState.targetSummary = targetSummary || null;
    salesDrilldownState.options = options && typeof options === 'object' ? options : {};
}

const DASHBOARD_METRIC_SPECS = {
    turnover: {
        label: 'Total Turnover',
        type: 'currency',
        aliases: ['turnover', 'sales', 'revenue', 'total turnover', 'target amount', 'turnover target']
    },
    activeClients: {
        label: 'Active Clients <R1000 (12m)',
        type: 'count',
        aliases: ['active clients', 'active customers', 'clients', 'customers under 1000', 'customer count', 'actives target', 'active under 1000']
    },
    orderLines: {
        label: 'Order Lines',
        type: 'count',
        aliases: ['order lines', 'orders', 'order count', 'orderlines', 'lines target']
    },
    customerBalance: {
        label: 'Customer Balance',
        type: 'currency',
        aliases: ['customer balance', 'balance', 'receivables', 'debtor balance', 'customer balance target']
    },
    newBusiness: {
        label: 'New Business',
        type: 'currency',
        aliases: ['new business', 'new sales', 'new revenue', 'pipeline wins', 'new business target']
    }
};

const SALES_TARGET_FIELD_ALIASES = {
    metric: ['metric', 'metric name', 'kpi', 'kpi name', 'measure'],
    target: ['target amount', 'target value', 'target', 'goal', 'target sales', 'target turnover'],
    actual: ['actual amount', 'actual value', 'actual', 'actual sales', 'actual turnover'],
    date: ['date', 'period', 'month', 'cal. year / month'],
    year: ['year', 'target year'],
    month: ['month', 'period month', 'month number'],
    division: ['division', 'sales division', 'business unit'],
    salesRep: ['sales rep', 'representative', 'sales representative', 'rep', 'csc name', 'rep_id', 'rep id'],
    salesGroup: ['sales group', 'group', 'region', 'sales region', 'business group'],
    salesGroupCode: ['sales group code', 'group code', 'sales region', 'sales region code']
};

const TARGET_METRIC_ALIAS_LOOKUP = Object.entries(DASHBOARD_METRIC_SPECS).reduce((acc, [metricKey, spec]) => {
    spec.aliases.forEach(alias => {
        acc[alias.toLowerCase()] = metricKey;
    });
    return acc;
}, {});

function invalidateSalesNormalizationState() {
    salesNormalizationState.sourceRef = null;
    salesNormalizationState.cacheToken += 1;
}

function invalidateCustomerNormalizationState() {
    customerNormalizationState.sourceRef = null;
    customerNormalizationState.cacheToken += 1;
}

function invalidateProductNormalizationState() {
    productNormalizationState.sourceRef = null;
    productNormalizationState.cacheToken += 1;
}

function cleanSalesText(value) {
    if (value === undefined || value === null) {
        return '';
    }
    return String(value).trim();
}

function parseSalesNumber(value) {
    if (value === undefined || value === null || value === '') {
        return 0;
    }
    if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
    }
    const sanitized = String(value).replace(/[^\d.+-]/g, '');
    const parsed = parseFloat(sanitized);
    return Number.isFinite(parsed) ? parsed : 0;
}

function parseSalesCurrency(value) {
    if (value === undefined || value === null || value === '') {
        return 0;
    }
    if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
    }

    let str = String(value).trim();
    if (!str) {
        return 0;
    }

    const isNegative = /^\s*\(/.test(str) || /-/.test(str);
    str = str.replace(/[()]/g, '');
    str = str.replace(/([A-Za-z]|\s)/g, '');

    if (!str) {
        return 0;
    }

    const commaIndex = str.lastIndexOf(',');
    const dotIndex = str.lastIndexOf('.');

    if (commaIndex > dotIndex) {
        str = str.replace(/\./g, '');
        str = str.replace(',', '.');
    } else {
        str = str.replace(/,/g, '');
    }

    str = str.replace(/[^\d.+-]/g, '');
    const parsed = parseFloat(str);
    if (!Number.isFinite(parsed)) {
        return 0;
    }
    return isNegative ? -Math.abs(parsed) : parsed;
}

function parseSalesPercentage(value) {
    if (value === undefined || value === null || value === '') {
        return null;
    }
    if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
    }
    const str = String(value).trim();
    if (!str) {
        return null;
    }
    const sanitized = str.replace(/%/g, '').replace(/[^\d.+-]/g, '');
    const parsed = parseFloat(sanitized);
    if (!Number.isFinite(parsed)) {
        return null;
    }
    return parsed;
}

function normalizePowerProductFlag(value) {
    if (value === undefined || value === null) {
        return false;
    }
    if (typeof value === 'boolean') {
        return value;
    }
    const normalized = String(value).trim().toLowerCase();
    if (!normalized) {
        return false;
    }
    const clean = normalized.replace(/[^a-z0-9]/g, '');
    if (['yes', 'y', 'true', '1', 'power', 'powerproduct', 'powerproducts'].includes(clean)) {
        return true;
    }
    if (['no', 'n', 'false', '0'].includes(clean)) {
        return false;
    }
    // Heuristic: if the text contains "power" anywhere (e.g., "Power Product Yes" or "POWER PRODUCTS"), treat as power product
    if (normalized.includes('power')) {
        return true;
    }
    return false;
}

function parseSalesDate(value) {
    if (value === undefined || value === null || value === '') {
        return null;
    }
    if (value instanceof Date && !Number.isNaN(value.getTime())) {
        return value;
    }
    if (typeof value === 'number' && Number.isFinite(value)) {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const parsedDate = new Date(excelEpoch.getTime() + value * 86400000);
        return Number.isNaN(parsedDate.getTime()) ? null : parsedDate;
    }

    const str = String(value).trim();
    if (!str) {
        return null;
    }

    const monthYearMatch = str.match(/^(\d{1,2})[\.\/-](\d{4})$/);
    if (monthYearMatch) {
        const month = parseInt(monthYearMatch[1], 10) - 1;
        const year = parseInt(monthYearMatch[2], 10);
        if (month >= 0 && month <= 11 && year > 1900) {
            const parsed = new Date(Date.UTC(year, month, 1));
            return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
    }

    const isoCandidate = new Date(str);
    if (!Number.isNaN(isoCandidate.getTime())) {
        return isoCandidate;
    }

    const match = str.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
    if (match) {
        const day = parseInt(match[1], 10);
        const month = parseInt(match[2], 10) - 1;
        let year = parseInt(match[3], 10);
        if (year < 100) {
            year += year > 70 ? 1900 : 2000;
        }
        const parsed = new Date(year, month, day);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
    }

    return null;
}

function formatDateKey(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function calculateWesternEasterSunday(year) {
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    return new Date(year, month, day);
}

function getSouthAfricanPublicHolidays(year) {
    if (SOUTH_AFRICA_HOLIDAY_CACHE.has(year)) {
        return SOUTH_AFRICA_HOLIDAY_CACHE.get(year);
    }
    const holidays = new Set();
    const addHoliday = (date) => {
        holidays.add(formatDateKey(date));
        if (date.getDay() === 0) {
            const observed = new Date(date);
            observed.setDate(observed.getDate() + 1);
            holidays.add(formatDateKey(observed));
        }
    };

    const fixedHolidays = [
        [0, 1],
        [2, 21],
        [3, 27],
        [4, 1],
        [5, 16],
        [7, 9],
        [8, 24],
        [11, 16],
        [11, 25],
        [11, 26]
    ];
    fixedHolidays.forEach(([month, day]) => addHoliday(new Date(year, month, day)));

    const easterSunday = calculateWesternEasterSunday(year);
    const goodFriday = new Date(easterSunday);
    goodFriday.setDate(goodFriday.getDate() - 2);
    addHoliday(goodFriday);
    const familyDay = new Date(easterSunday);
    familyDay.setDate(familyDay.getDate() + 1);
    addHoliday(familyDay);

    SOUTH_AFRICA_HOLIDAY_CACHE.set(year, holidays);
    return holidays;
}

function isSouthAfricanPublicHoliday(date) {
    return getSouthAfricanPublicHolidays(date.getFullYear()).has(formatDateKey(date));
}

function calculateRemainingWorkingDays(fromDate, toDate) {
    if (!(fromDate instanceof Date) || Number.isNaN(fromDate.getTime())) {
        return 0;
    }
    if (!(toDate instanceof Date) || Number.isNaN(toDate.getTime())) {
        return 0;
    }
    const start = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
    const end = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
    if (start > end) {
        return 0;
    }
    let count = 0;
    const cursor = new Date(start);
    while (cursor <= end) {
        const day = cursor.getDay();
        if (day !== 0 && day !== 6 && !isSouthAfricanPublicHoliday(cursor)) {
            count += 1;
        }
        cursor.setDate(cursor.getDate() + 1);
    }
    return count;
}

function resolveSalesField(row, target) {
    if (!row || typeof row !== 'object') {
        return undefined;
    }
    const aliasList = SALES_FIELD_ALIASES[target];
    if (!aliasList || aliasList.length === 0) {
        return undefined;
    }

    const keyMap = {};
    Object.keys(row).forEach(key => {
        keyMap[key.trim().toLowerCase()] = key;
    });

    for (const alias of aliasList) {
        const normalizedKey = alias.toLowerCase();
        if (keyMap[normalizedKey] !== undefined) {
            return row[keyMap[normalizedKey]];
        }
    }
    return undefined;
}

function resolveCustomerField(row, target) {
    if (!row || typeof row !== 'object') {
        return undefined;
    }
    const aliasList = CUSTOMER_FIELD_ALIASES[target];
    if (!aliasList || aliasList.length === 0) {
        return undefined;
    }

    const keyMap = {};
    Object.keys(row).forEach(key => {
        const normalizedKey = key.trim().toLowerCase();
        keyMap[normalizedKey] = key;
        keyMap[normalizedKey.replace(/[\s_]+/g, '')] = key;
    });

    for (const alias of aliasList) {
        if (!alias) {
            continue;
        }
        const normalizedKey = alias.toLowerCase().trim();
        if (keyMap[normalizedKey] !== undefined) {
            return row[keyMap[normalizedKey]];
        }
        const sanitizedKey = normalizedKey.replace(/[\s_]+/g, '');
        if (keyMap[sanitizedKey] !== undefined) {
            return row[keyMap[sanitizedKey]];
        }
    }
    return undefined;
}

function resolveTargetField(row, target) {
    if (!row || typeof row !== 'object') {
        return undefined;
    }
    const aliasList = SALES_TARGET_FIELD_ALIASES[target];
    if (!aliasList || aliasList.length === 0) {
        return undefined;
    }

    const keyMap = {};
    Object.keys(row).forEach(key => {
        const normalizedKey = key.trim().toLowerCase();
        keyMap[normalizedKey] = key;
        keyMap[normalizedKey.replace(/[\s_]+/g, '')] = key;
    });

    for (const alias of aliasList) {
        const normalizedKey = alias.toLowerCase();
        if (keyMap[normalizedKey] !== undefined) {
            return row[keyMap[normalizedKey]];
        }
        const sanitizedKey = normalizedKey.replace(/[\s_]+/g, '');
        if (keyMap[sanitizedKey] !== undefined) {
            return row[keyMap[sanitizedKey]];
        }
    }
    return undefined;
}

function resolveFieldByAliases(row, aliases = []) {
    if (!row || typeof row !== 'object' || !Array.isArray(aliases)) {
        return undefined;
    }

    const keyMap = {};
    Object.keys(row).forEach(key => {
        const normalizedKey = key.trim().toLowerCase();
        keyMap[normalizedKey] = key;
        keyMap[normalizedKey.replace(/[\s_]+/g, '')] = key;
    });

    for (const alias of aliases) {
        if (!alias) {
            continue;
        }
        const normalizedKey = alias.toLowerCase();
        if (keyMap[normalizedKey] !== undefined) {
            return row[keyMap[normalizedKey]];
        }
        const sanitizedKey = normalizedKey.replace(/[\s_]+/g, '');
        if (keyMap[sanitizedKey] !== undefined) {
            return row[keyMap[sanitizedKey]];
        }
    }
    return undefined;
}

function mapTargetMetricKey(rawMetric, row) {
    const directMatch = rawMetric ? cleanSalesText(rawMetric).toLowerCase() : '';
    if (directMatch && TARGET_METRIC_ALIAS_LOOKUP[directMatch]) {
        return TARGET_METRIC_ALIAS_LOOKUP[directMatch];
    }

    if (!directMatch) {
        const rowKeys = Object.keys(row || {}).map(key => key.trim().toLowerCase());
        if (rowKeys.some(key => key.includes('order'))) {
            return 'orderLines';
        }
        if (rowKeys.some(key => key.includes('client') || key.includes('customer'))) {
            return 'activeClients';
        }
        if (rowKeys.some(key => key.includes('balance'))) {
            return 'customerBalance';
        }
        if (rowKeys.some(key => key.includes('new'))) {
            return 'newBusiness';
        }
    }

    return 'turnover';
}

function parseTargetValue(value, type) {
    if (value === undefined || value === null || value === '') {
        return null;
    }
    if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
    }
    const str = String(value).trim();
    if (!str) {
        return null;
    }

    if (type === 'percent' || str.includes('%')) {
        const percent = parseSalesPercentage(str);
        return Number.isFinite(percent) ? percent : null;
    }

    if (type === 'currency') {
        const currency = parseSalesCurrency(str);
        return Number.isFinite(currency) ? currency : null;
    }

    const numeric = parseSalesNumber(str);
    return Number.isFinite(numeric) ? numeric : null;
}

function deriveTargetDate(row) {
    const explicitDate = resolveTargetField(row, 'date');
    const parsedExplicit = parseSalesDate(explicitDate);
    if (parsedExplicit instanceof Date && !Number.isNaN(parsedExplicit.getTime())) {
        return parsedExplicit;
    }

    const yearRaw = resolveTargetField(row, 'year');
    const monthRaw = resolveTargetField(row, 'month');
    const year = Number.parseInt(yearRaw, 10);
    const month = Number.parseInt(monthRaw, 10);

    if (Number.isFinite(year) && Number.isFinite(month) && month >= 1 && month <= 12) {
        const date = new Date(Date.UTC(year, month - 1, 1));
        return Number.isNaN(date.getTime()) ? null : date;
    }

    return null;
}

function normalizeSalesTargets(data = []) {
    if (!Array.isArray(data) || data.length === 0) {
        return [];
    }
    const normalized = [];

    data.forEach(row => {
        if (!row || typeof row !== 'object') {
            return;
        }

        const baseDivision = cleanSalesText(resolveTargetField(row, 'division'));
        const baseRep = cleanSalesText(resolveTargetField(row, 'salesRep'));
        const baseGroup = cleanSalesText(resolveTargetField(row, 'salesGroup'));
        const baseGroupCode = cleanSalesText(resolveTargetField(row, 'salesGroupCode'));
        const combinedGroup = baseGroupCode && baseGroup
            ? `${baseGroupCode} - ${baseGroup}`
            : (baseGroup || baseGroupCode);
        const parsedDate = deriveTargetDate(row);

        const rawMetric = resolveTargetField(row, 'metric');
        if (rawMetric !== undefined && rawMetric !== null && String(rawMetric).trim() !== '') {
            const metricKey = mapTargetMetricKey(rawMetric, row);
            const spec = DASHBOARD_METRIC_SPECS[metricKey] || { type: 'number' };
            const targetValue = parseTargetValue(resolveTargetField(row, 'target'), spec.type);
            const actualValue = parseTargetValue(resolveTargetField(row, 'actual'), spec.type);
            if (Number.isFinite(targetValue) || Number.isFinite(actualValue)) {
                normalized.push({
                    raw: row,
                    metricKey,
                    targetValue,
                    actualValue,
                    type: spec.type || 'number',
                    division: baseDivision,
                    salesRep: baseRep,
                    salesGroup: combinedGroup,
                    salesGroupName: baseGroup,
                    salesGroupCode: baseGroupCode,
                    date: parsedDate
                });
            }
            return;
        }

        Object.entries(DASHBOARD_METRIC_SPECS).forEach(([metricKey, spec]) => {
            const value = resolveFieldByAliases(row, spec.aliases || []);
            if (value === undefined || value === null || value === '') {
                return;
            }
            const targetValue = parseTargetValue(value, spec.type);
            if (!Number.isFinite(targetValue)) {
                return;
            }

            normalized.push({
                raw: row,
                metricKey,
                targetValue,
                actualValue: null,
                type: spec.type || 'number',
                division: baseDivision,
                salesRep: baseRep,
                salesGroup: combinedGroup,
                salesGroupName: baseGroup,
                salesGroupCode: baseGroupCode,
                date: parsedDate
            });
        });
    });

    return normalized;
}

function buildEmptyTargetSummary() {
    const summary = {};
    Object.entries(DASHBOARD_METRIC_SPECS).forEach(([key, spec]) => {
        summary[key] = {
            target: null,
            actualFromTargets: null,
            type: spec.type,
            sourceCount: 0
        };
    });
    return summary;
}

function getDashboardTargetSummary(filters = {}) {
    const rawTargets = Array.isArray(masterData.targets) ? masterData.targets : [];
    if (!rawTargets.length) {
        return buildEmptyTargetSummary();
    }

    const normalizedTargets = normalizeSalesTargets(rawTargets);
    if (!normalizedTargets.length) {
        return buildEmptyTargetSummary();
    }

    const summary = buildEmptyTargetSummary();

    const dateFrom = filters.dateFrom instanceof Date ? filters.dateFrom : null;
    const dateTo = filters.dateTo instanceof Date ? filters.dateTo : null;
    const divisionFilters = Array.isArray(filters.division)
        ? filters.division.filter(value => value !== '')
        : filters.division
            ? [filters.division]
            : [];
    const groupFilters = Array.isArray(filters.salesGroup)
        ? filters.salesGroup.filter(value => value !== '')
        : filters.salesGroup
            ? [filters.salesGroup]
            : [];
    const salesRepFilters = Array.isArray(filters.salesRep)
        ? filters.salesRep.filter(value => value !== '')
        : filters.salesRep
            ? [filters.salesRep]
            : [];
    const monthIndex = date => date instanceof Date && !Number.isNaN(date.getTime())
        ? (date.getUTCFullYear() * 12) + date.getUTCMonth()
        : null;
    const monthFrom = monthIndex(dateFrom);
    const monthTo = monthIndex(dateTo);

    normalizedTargets.forEach(entry => {
        if (!matchesMultiFilter(divisionFilters, entry.division)) {
            return;
        }
        if (!matchesMultiFilter(groupFilters, entry.salesGroup)) {
            return;
        }
        if (!matchesMultiFilter(salesRepFilters, entry.salesRep)) {
            return;
        }
        const entryMonth = monthIndex(entry.date);
        if (monthFrom !== null) {
            if (entryMonth === null || entryMonth < monthFrom) {
                return;
            }
        }
        if (monthTo !== null) {
            if (entryMonth === null || entryMonth > monthTo) {
                return;
            }
        }

        if (!summary[entry.metricKey]) {
            summary[entry.metricKey] = {
                target: null,
                actualFromTargets: null,
                type: entry.type || 'number',
                sourceCount: 0
            };
        }
        const bucket = summary[entry.metricKey];
        bucket.sourceCount += 1;

        if (Number.isFinite(entry.targetValue)) {
            if (bucket.type === 'percent') {
                bucket.target = bucket.target === null ? entry.targetValue : bucket.target + entry.targetValue;
            } else {
                bucket.target = (bucket.target || 0) + entry.targetValue;
            }
        }
        if (Number.isFinite(entry.actualValue)) {
            if (bucket.type === 'percent') {
                bucket.actualFromTargets = bucket.actualFromTargets === null ? entry.actualValue : bucket.actualFromTargets + entry.actualValue;
            } else {
                bucket.actualFromTargets = (bucket.actualFromTargets || 0) + entry.actualValue;
            }
        }
    });

    Object.entries(summary).forEach(([metricKey, bucket]) => {
        if (bucket.type === 'percent' && bucket.sourceCount > 0) {
            bucket.target = Number.isFinite(bucket.target) ? bucket.target / bucket.sourceCount : null;
            bucket.actualFromTargets = Number.isFinite(bucket.actualFromTargets) ? bucket.actualFromTargets / bucket.sourceCount : null;
        }
        if (bucket.type !== 'percent') {
            if (bucket.target === 0) {
                bucket.target = null;
            }
            if (bucket.actualFromTargets === 0) {
                bucket.actualFromTargets = null;
            }
        }
    });

    return summary;
}

function formatMetricValue(value, type) {
    if (!Number.isFinite(value)) {
        return 'N/A';
    }
    if (type === 'currency') {
        return formatSalesCurrency(value, { compact: true, decimals: 0 });
    }
    if (type === 'percent') {
        return `${value.toFixed(1)}%`;
    }
    return Math.round(value).toLocaleString('en-ZA');
}

function toggleCardDetails(sectionId, buttonEl) {
    const section = document.getElementById(sectionId);
    if (!section) {
        return;
    }
    const isHidden = section.style.display === 'none';
    section.style.display = isHidden ? 'block' : 'none';
    if (buttonEl) {
        buttonEl.textContent = isHidden ? 'Hide details â–¾' : 'View details â–¸';
    }
}

function updateMetricTargetDisplay({ metricKey, actualValue, targetBucket, textElementId, progressElementId }) {
    const spec = DASHBOARD_METRIC_SPECS[metricKey] || { label: metricKey, type: 'number' };
    const textEl = document.getElementById(textElementId);
    const progressEl = document.getElementById(progressElementId);

    const targetValue = targetBucket && Number.isFinite(targetBucket.target) ? targetBucket.target : null;

    if (textEl) {
        if (targetValue === null || targetValue === 0) {
            textEl.textContent = 'Targets pending upload';
        } else {
            const ratio = targetValue ? (actualValue / targetValue) * 100 : 0;
            textEl.textContent = `${formatMetricValue(actualValue, spec.type)} vs target ${formatMetricValue(targetValue, spec.type)} (${Math.round(ratio)}%)`;
        }
    }

    if (progressEl) {
        let ratioPercent = 0;
        if (targetValue && targetValue !== 0) {
            ratioPercent = Math.max(0, Math.min(200, (actualValue / targetValue) * 100));
        }
        progressEl.style.width = `${ratioPercent}%`;
        progressEl.style.background = ratioPercent >= 100 ? 'rgba(16,185,129,0.9)' : 'rgba(248,113,113,0.9)';
    }

    const ratio = targetValue && targetValue !== 0 ? actualValue / targetValue : null;
    return {
        metricKey,
        actual: actualValue,
        target: targetValue,
        ratio,
        type: spec.type,
        hasTarget: targetValue !== null && targetValue !== 0
    };
}

function renderDashboardRecommendations(metricStatuses, summary) {
    const recommendationsEl = document.getElementById('dashboardRecommendations');
    if (!recommendationsEl) {
        return;
    }

    if (!metricStatuses || metricStatuses.length === 0) {
        recommendationsEl.innerHTML = '<h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">ğŸ¯ Sales Actions</h3><p style="margin:0;color:#6b7280;font-size:14px">Upload the latest sales file and targets to activate direct guidance.</p>';
        return;
    }

    const insights = [];

    metricStatuses.forEach(status => {
        const spec = DASHBOARD_METRIC_SPECS[status.metricKey] || { label: status.metricKey };
        if (!status.hasTarget) {
            insights.push({
                priority: 7,
                metric: spec.label,
                message: `Set a ${spec.label.toLowerCase()} target so reps can track progress.`
            });
            return;
        }

        if (!Number.isFinite(status.ratio)) {
            insights.push({
                priority: 5,
                metric: spec.label,
                message: `${spec.label} target data incompleteâ€”double-check the uploaded file.`
            });
            return;
        }

        const ratioPercent = status.ratio * 100;
        if (ratioPercent >= 110) {
            insights.push({
                priority: 4,
                metric: spec.label,
                message: `${spec.label} tracking ${Math.round(ratioPercent)}% of goal. Lift the target or shift effort to the next revenue lever.`
            });
        } else if (ratioPercent >= 95) {
            insights.push({
                priority: 3,
                metric: spec.label,
                message: `${spec.label} sitting at ${Math.round(ratioPercent)}% of targetâ€”keep daily execution steady.`
            });
        } else {
            insights.push({
                priority: 6,
                metric: spec.label,
                message: `${spec.label} sitting at ${Math.round(ratioPercent)}% of target. Launch a sales push to close the gap.`
            });
        }
    });

    const uniqueMessages = [];
    const seen = new Set();
    insights
        .sort((a, b) => b.priority - a.priority)
        .forEach(entry => {
            const key = `${entry.metric}-${entry.message}`;
            if (!seen.has(key)) {
                uniqueMessages.push(entry);
                seen.add(key);
            }
        });

    if (uniqueMessages.length === 0) {
        recommendationsEl.innerHTML = '<h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">ğŸ¯ Sales Actions</h3><p style="margin:0;color:#6b7280;font-size:14px">Targets still pendingâ€”upload them to unlock automated sales moves.</p>';
        return;
    }

    const dateLabel = summary && summary.dateInfo ? summary.dateInfo.rangeLabel : '';
    recommendationsEl.innerHTML = `
        <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:18px;font-weight:600">ğŸ¯ Sales Actions</h3>
        ${dateLabel ? `<p style="margin:0 0 12px 0;color:#6b7280;font-size:13px">Signals from sales coverage ${escapeHtml(dateLabel)}.</p>` : ''}
        ${uniqueMessages.slice(0, 5).map(entry => `<div style="margin-bottom:10px;font-size:14px;color:#1f2937"><span style="color:#059669">â€¢</span> ${escapeHtml(entry.message)}</div>`).join('')}
    `;
}

function describeActiveDashboardFilters(filters) {
    if (!filters || typeof filters !== 'object') {
        return 'all data';
    }
    const fragments = [];
    if (Array.isArray(filters.division) && filters.division.length > 0) {
        fragments.push(`Division: ${filters.division.join(', ')}`);
    }
    if (Array.isArray(filters.salesGroup) && filters.salesGroup.length > 0) {
        fragments.push(`Sales Group: ${filters.salesGroup.join(', ')}`);
    }
    if (filters.salesRep) {
        fragments.push(`Rep: ${filters.salesRep}`);
    }
    if (filters.performance) {
        const label = filters.performance === 'high' ? 'High performers' : filters.performance === 'medium' ? 'Mid performers' : 'Low performers';
        fragments.push(label);
    }
    if (filters.turnover) {
        fragments.push(`Turnover band: ${filters.turnover}`);
    }
    if (filters.dateFrom || filters.dateTo) {
        const rawFrom = filters.dateFrom ? parseSalesDate(filters.dateFrom) : null;
        const rawTo = filters.dateTo ? parseSalesDate(filters.dateTo) : null;
        const from = rawFrom instanceof Date && !Number.isNaN(rawFrom.getTime())
            ? formatSalesDateLabel(rawFrom, { mode: 'human' })
            : (filters.dateFrom || 'start');
        const to = rawTo instanceof Date && !Number.isNaN(rawTo.getTime())
            ? formatSalesDateLabel(rawTo, { mode: 'human' })
            : (filters.dateTo || 'today');
        fragments.push(`Dates: ${from} â†’ ${to}`);
    }
    return fragments.length > 0 ? fragments.join(' Â· ') : 'all data';
}

function renderDashboardAlerts(summary, targets, options = {}) {
    const alertsEl = document.getElementById('dashboardAlertsMessage');
    if (!alertsEl) {
        return;
    }

    const filterLabel = options.filterLabel || 'all data';
    const safeFilterLabel = escapeHtml(filterLabel);
    const today = options.today instanceof Date && !Number.isNaN(options.today.getTime()) ? options.today : new Date();
    const currentSnapshot = options.currentSnapshot || null;
    const forecastSummary = options.forecastSummary || null;

    if (!options.hasData || !summary) {
        alertsEl.innerHTML = `<p style="margin:0;color:#6b7280">No current sales loaded for <strong>${safeFilterLabel}</strong>. Drop in the latest file or adjust filters to unlock live sales callouts.</p>`;
        return;
    }

    const lines = [];
    const dateInfo = summary.dateInfo || {};
    const recentMonths = Array.isArray(dateInfo.recentMonths) ? dateInfo.recentMonths.filter(month => Number.isFinite(month.turnover)) : [];
    const asOfDate = currentSnapshot && currentSnapshot.dataThrough instanceof Date && !Number.isNaN(currentSnapshot.dataThrough.getTime())
        ? currentSnapshot.dataThrough
        : (dateInfo.maxDate instanceof Date && !Number.isNaN(dateInfo.maxDate.getTime()) ? dateInfo.maxDate : today);
    const asOfLabel = formatSalesDateLabel(asOfDate, { mode: 'human' });

    if (currentSnapshot) {
        if (currentSnapshot.turnover > 0) {
            const projectedLabel = currentSnapshot.projectedTotal > 0 && currentSnapshot.daysElapsed < currentSnapshot.daysInMonth
                ? `Tracking toward ${formatSalesCurrency(currentSnapshot.projectedTotal, { compact: true, decimals: 0 })}`
                : 'Pace holds against full-month delivery';
            lines.push(`<strong>${escapeHtml(currentSnapshot.label)} Pace:</strong> ${formatSalesCurrency(currentSnapshot.turnover, { compact: true, decimals: 0 })} booked from ${currentSnapshot.deals.toLocaleString()} deal${currentSnapshot.deals === 1 ? '' : 's'} as of ${asOfLabel}. ${projectedLabel}. Keep the pipeline moving daily (${currentSnapshot.daysElapsed}/${currentSnapshot.daysInMonth} workdays gone).`);
        } else {
            const monthName = escapeHtml(currentSnapshot.label || 'Current Month');
            const lastPosted = currentSnapshot.latestDataDate instanceof Date && !Number.isNaN(currentSnapshot.latestDataDate.getTime())
                ? ` Last booking captured ${formatSalesDateLabel(currentSnapshot.latestDataDate, { mode: 'human' })}.`
                : '';
            lines.push(`<strong>${monthName} Kick-off:</strong> No sales booked yet for ${safeFilterLabel}.${lastPosted} Prioritise closing the first deal to set the pace.`);
        }
    }

    if (recentMonths.length >= 2) {
        const last = recentMonths[recentMonths.length - 1];
        const prior = recentMonths[recentMonths.length - 2];
        if (prior && Number.isFinite(prior.turnover) && prior.turnover > 0) {
            let comparisonValue = last.turnover;
            let isProjected = false;
            if (currentSnapshot && last && last.label === currentSnapshot.label && currentSnapshot.projectedTotal > 0) {
                comparisonValue = currentSnapshot.projectedTotal;
                isProjected = currentSnapshot.daysElapsed < currentSnapshot.daysInMonth;
            }
            const delta = ((comparisonValue - prior.turnover) / prior.turnover) * 100;
            if (delta <= -8) {
                const qualifier = isProjected ? 'projected' : 'recorded';
                lines.push(`<strong>MoM Turnover Dip:</strong> ${formatSalesCurrency(comparisonValue, { compact: true, decimals: 0 })} ${qualifier} for ${escapeHtml(last.label || 'last month')} is ${Math.abs(delta).toFixed(1)}% below ${escapeHtml(prior.label || 'prior month')}. Run recovery calls across ${safeFilterLabel}.`);
            } else if (delta >= 8) {
                const qualifier = isProjected ? 'projected' : 'recorded';
                lines.push(`<strong>MoM Surge:</strong> ${formatSalesCurrency(comparisonValue, { compact: true, decimals: 0 })} ${qualifier} is up ${delta.toFixed(1)}% vs prior month. Double down on the plays working in ${safeFilterLabel}.`);
            }
        }
    }

    if (Number.isFinite(summary.totalTurnover) && targets && targets.turnover && Number.isFinite(targets.turnover.target) && targets.turnover.target > 0) {
        const gap = summary.totalTurnover - targets.turnover.target;
        const gapPct = (summary.totalTurnover / targets.turnover.target) * 100;
        if (gapPct < 92) {
            lines.push(`<strong>Target Gap:</strong> Sitting at ${gapPct.toFixed(1)}% of the turnover plan. Need ${formatSalesCurrency(Math.abs(gap), { compact: true, decimals: 0 })} more for ${safeFilterLabel}. Prioritise late-stage deals.`);
        } else if (gap > 0) {
            lines.push(`<strong>Above Target:</strong> ${safeFilterLabel} is ${formatSalesCurrency(gap, { compact: true, decimals: 0 })} ahead of plan. Lock renewals and upsell while confidence is high.`);
        }
    }

    if (Number.isFinite(summary.avgDealSize) && summary.avgDealSize < 5000) {
        lines.push(`<strong>Deal Size Watch:</strong> Average ticket is ${formatSalesCurrency(summary.avgDealSize)}. Bundle or cross-sell to grow deal value in ${safeFilterLabel}.`);
    }

    const activeClients = Number.isFinite(options.activeClientsTotal) ? options.activeClientsTotal : null;
    const activeClientsTarget = Number.isFinite(options.activeClientsTarget) ? options.activeClientsTarget : null;
    if (activeClients !== null && activeClientsTarget && activeClientsTarget > 0) {
        const activeGapPct = (activeClients / activeClientsTarget) * 100;
        if (activeGapPct < 80) {
            lines.push(`<strong>Client Coverage:</strong> ${activeClients.toLocaleString()} of ${activeClientsTarget.toLocaleString()} target actives live (${activeGapPct.toFixed(1)}%). Trigger reactivation sequences for ${safeFilterLabel}.`);
        } else if (activeGapPct >= 105) {
            lines.push(`<strong>Coverage Win:</strong> ${activeClients.toLocaleString()} active clients (${activeGapPct.toFixed(1)}% of goal). Ask for referrals while engagement is hot.`);
        }
    }

    const totalTurnover = Number.isFinite(summary.totalTurnover) ? summary.totalTurnover : 0;
    const newBusinessTurnover = Number.isFinite(options.newBusinessTurnover) ? options.newBusinessTurnover : null;
    if (newBusinessTurnover !== null && totalTurnover > 0) {
        const newBizShare = (newBusinessTurnover / totalTurnover) * 100;
        if (newBizShare < 22) {
            lines.push(`<strong>New Biz Lag:</strong> ${newBizShare.toFixed(1)}% of revenue landed in the last 30 days. Refill prospecting lists to protect future months.`);
        } else if (newBizShare >= 45) {
            lines.push(`<strong>Fresh Momentum:</strong> ${newBizShare.toFixed(1)}% of revenue is fresh last-30-day sales. Amplify the campaigns delivering.`);
        }
    }

    const last30ActiveCustomers = Number.isFinite(options.last30ActiveCustomers) ? options.last30ActiveCustomers : null;
    if (last30ActiveCustomers !== null) {
        if (last30ActiveCustomers === 0) {
            lines.push('<strong>Customer Reactivation:</strong> No customers have purchased in the last 30 days. Trigger outreach to re-open dormant accounts.');
        } else if (last30ActiveCustomers <= 5) {
            lines.push(`<strong>Low Engagement:</strong> Only ${last30ActiveCustomers.toLocaleString()} customer${last30ActiveCustomers === 1 ? '' : 's'} purchased in the last 30 days. Line up follow-up calls to widen coverage.`);
        }
    }

    if (Number.isFinite(summary.avgGrossMargin) && summary.avgGrossMargin < 18) {
        lines.push(`<strong>Margin Pressure:</strong> Margin at ${summary.avgGrossMargin.toFixed(1)}%. Tighten discounts and reprice low-yield SKUs.`);
    }

    const topDivision = Array.isArray(summary.topDivisions) && summary.topDivisions.length > 0 ? summary.topDivisions[0] : null;
    if (topDivision && Number.isFinite(topDivision.turnover) && totalTurnover > 0) {
        const share = (topDivision.turnover / totalTurnover) * 100;
        const topDivisionName = escapeHtml(topDivision.name || 'Top division');
        if (share >= 55) {
            lines.push(`<strong>Concentration Risk:</strong> ${topDivisionName} drives ${share.toFixed(1)}% of sales. Protect the segment and build parallel wins.`);
        } else if (share <= 28) {
            lines.push(`<strong>Expansion Play:</strong> ${topDivisionName} only contributes ${share.toFixed(1)}%. Launch offers to grow this division.`);
        }
    }

    const topRep = Array.isArray(summary.topSalesReps) && summary.topSalesReps.length > 0 ? summary.topSalesReps[0] : null;
    if (topRep && Number.isFinite(topRep.turnover)) {
        lines.push(`<strong>Rep Spotlight:</strong> ${escapeHtml(topRep.name)} has ${formatSalesCurrency(topRep.turnover, { compact: true, decimals: 0 })} from ${topRep.deals} deals. Share their talk tracks across ${safeFilterLabel}.`);
    }

    const last30Deals = Number.isFinite(options.last30Deals) ? options.last30Deals : null;
    const activeRepCount = Number.isFinite(options.activeRepCount) ? options.activeRepCount : null;
    if (last30Deals !== null && activeRepCount) {
        const dealsPerRep = activeRepCount > 0 ? last30Deals / activeRepCount : 0;
        if (dealsPerRep < 3) {
            lines.push(`<strong>Activity Gap:</strong> ${last30Deals} deals in 30 days across ${activeRepCount} reps (${dealsPerRep.toFixed(1)} each). Reset daily call and demo targets.`);
        } else if (dealsPerRep > 7) {
            lines.push(`<strong>High Velocity:</strong> ${last30Deals} deals in 30 days (${dealsPerRep.toFixed(1)} per rep). Align fulfilment and onboarding capacity.`);
        }
    }

    if (forecastSummary && Number.isFinite(forecastSummary.forecast90) && forecastSummary.forecast90 > 0) {
        const monthlyOutlook = forecastSummary.forecast90 / 3;
        lines.push(`<strong>Forward Outlook:</strong> 90-day projection at ${formatSalesCurrency(forecastSummary.forecast90, { compact: true, decimals: 0 })} (~${formatSalesCurrency(monthlyOutlook, { compact: true, decimals: 0 })} per month, ${escapeHtml(forecastSummary.confidence)} confidence). Prep inventory, fulfilment, and headcount.`);
    } else if (forecastSummary && Number.isFinite(forecastSummary.forecast30) && forecastSummary.forecast30 > 0) {
        lines.push(`<strong>Forward Outlook:</strong> 30-day projection at ${formatSalesCurrency(forecastSummary.forecast30, { compact: true, decimals: 0 })}. Keep conversion checkpoints tight to land the forecast.`);
    }

    if (lines.length === 0) {
        lines.push(`Sales KPIs steady for <strong>${safeFilterLabel}</strong>. Maintain deal cadence and review pipeline coverage each stand-up.`);
    }

    alertsEl.innerHTML = `
        <ul style="margin:0;padding-left:18px;display:flex;flex-direction:column;gap:10px;color:#374151">
            ${lines.map(line => `<li style="margin:0">${line}</li>`).join('')}
        </ul>
        <p style="margin:14px 0 0 0;color:#9ca3af;font-size:12px">Active focus: ${safeFilterLabel} â€¢ Data through ${asOfLabel}</p>
    `;
}

function formatSalesCurrency(value, options = {}) {
    const amount = Number(value) || 0;
    const { compact = false, decimals = 2 } = options;
    if (compact) {
        const abs = Math.abs(amount);
        if (abs >= 1000000) {
            return `R${(amount / 1000000).toFixed(1)}M`;
        }
        if (abs >= 1000) {
            return `R${(amount / 1000).toFixed(1)}K`;
        }
        return `R${amount.toFixed(0)}`;
    }
    return `R${amount.toLocaleString('en-ZA', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    })}`;
}

function formatSalesDateLabel(date, options = {}) {
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
        return '';
    }
    const mode = options.mode || 'date';
    if (mode === 'month') {
        return date.toLocaleString('en-ZA', { month: 'short', year: 'numeric' });
    }
    if (mode === 'human') {
        return date.toLocaleDateString('en-ZA', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    return date.toISOString().slice(0, 10);
}

function escapeHtml(value) {
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function ensureDrilldownHost() {
    if (drilldownUiState.overlay) {
        return drilldownUiState;
    }

    const overlay = document.createElement('div');
    overlay.id = 'drilldownOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:24px;background:rgba(15,23,42,0.55);z-index:10000;opacity:0;transition:opacity 0.2s ease';
    overlay.innerHTML = `
        <div data-role="backdrop" style="position:absolute;inset:0"></div>
        <div data-role="dialog" role="dialog" aria-modal="true" aria-labelledby="drilldownTitle" style="position:relative;max-width:960px;width:100%;max-height:80vh;background:#ffffff;border-radius:16px;box-shadow:0 24px 68px rgba(15,23,42,0.35);padding:24px;display:flex;flex-direction:column;gap:16px">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px">
                <h3 id="drilldownTitle" style="margin:0;font-size:18px;font-weight:700;color:#0f172a">Detail View</h3>
                <button type="button" data-role="close" style="border:0;background:transparent;font-size:20px;line-height:1;color:#64748b;cursor:pointer;padding:4px 8px" aria-label="Close drill-down">&times;</button>
            </div>
            <div id="drilldownContent" style="overflow-y:auto;flex:1 1 auto;padding-right:8px"></div>
        </div>`;

    document.body.appendChild(overlay);

    const dialog = overlay.querySelector('[data-role="dialog"]');
    const contentEl = overlay.querySelector('#drilldownContent');
    const titleEl = overlay.querySelector('#drilldownTitle');
    const closeBtn = overlay.querySelector('[data-role="close"]');
    const backdrop = overlay.querySelector('[data-role="backdrop"]');

    const closeHandler = () => closeDrilldownPanel();
    if (closeBtn) {
        closeBtn.addEventListener('click', closeHandler);
    }
    if (backdrop) {
        backdrop.addEventListener('click', closeHandler);
    }
    overlay.addEventListener('click', event => {
        if (event.target === overlay) {
            closeDrilldownPanel();
        }
    });

    document.addEventListener('keydown', event => {
        if (event.key === 'Escape' && drilldownUiState.active) {
            closeDrilldownPanel();
        }
    });

    drilldownUiState.overlay = overlay;
    drilldownUiState.dialog = dialog;
    drilldownUiState.contentEl = contentEl;
    drilldownUiState.titleEl = titleEl;
    drilldownUiState.closeBtn = closeBtn;

    return drilldownUiState;
}

function openDrilldownPanel(config = {}) {
    const state = ensureDrilldownHost();
    const overlay = state.overlay;
    if (!overlay) {
        return;
    }

    const dialog = state.dialog;
    const titleEl = state.titleEl;
    const contentEl = state.contentEl;

    const title = config.title || 'Detail View';
    const content = config.content || '<p style="margin:0;color:#475569;font-size:14px">No additional details available.</p>';
    const maxWidth = Number.isFinite(config.maxWidth) ? Math.max(360, Math.min(1200, config.maxWidth)) : 960;

    if (titleEl) {
        titleEl.textContent = title;
    }
    if (contentEl) {
        contentEl.innerHTML = content;
    }
    if (dialog) {
        dialog.style.maxWidth = `${maxWidth}px`;
    }

    const activeElement = document.activeElement;
    drilldownUiState.lastFocus = activeElement && typeof activeElement.focus === 'function' ? activeElement : null;
    drilldownUiState.originalOverflow = document.body ? document.body.style.overflow : '';

    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden', 'false');
    requestAnimationFrame(() => {
        overlay.style.opacity = '1';
    });
    drilldownUiState.active = true;
    if (document.body) {
        document.body.style.overflow = 'hidden';
    }
    if (drilldownUiState.closeBtn && typeof drilldownUiState.closeBtn.focus === 'function') {
        drilldownUiState.closeBtn.focus();
    }
}

function closeDrilldownPanel() {
    const overlay = drilldownUiState.overlay;
    if (!overlay) {
        return;
    }

    overlay.style.opacity = '0';
    overlay.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
        if (!drilldownUiState.active && overlay) {
            overlay.style.display = 'none';
        }
    }, 200);

    drilldownUiState.active = false;
    if (document.body) {
        document.body.style.overflow = drilldownUiState.originalOverflow || '';
    }
    drilldownUiState.originalOverflow = '';

    const lastFocus = drilldownUiState.lastFocus;
    if (lastFocus && typeof lastFocus.focus === 'function') {
        try {
            lastFocus.focus();
        } catch (err) {
            console.warn('Unable to restore focus after closing drill-down', err);
        }
    }
    drilldownUiState.lastFocus = null;
}

function wireSalesDrilldowns(container, summary, normalized, targetSummary, options = {}) {
    setSalesDrilldownState(summary, normalized, targetSummary, options);

    if (!container) {
        return;
    }

    const interactiveNodes = container.querySelectorAll('[data-drilldown-action]');
    interactiveNodes.forEach(node => {
        if (node.getAttribute('data-drilldown-bound') === '1') {
            return;
        }
        node.setAttribute('data-drilldown-bound', '1');
        node.addEventListener('click', () => triggerSalesDrilldown(node));
        node.addEventListener('keydown', event => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                triggerSalesDrilldown(node);
            }
        });
    });
}

function wireSalesDashboardDrilldowns() {
    const mappings = [
        { selector: '[data-dashboard-drill="turnover"]', action: 'sales-metric', detail: { metricKey: 'turnover', metricLabel: 'Total Turnover' } },
        { selector: '[data-dashboard-drill="activeClients"]', action: 'sales-metric', detail: { metricKey: 'activeCustomersUnder1k12m', metricLabel: 'Active Clients <R1000 (12m)' } },
        { selector: '[data-dashboard-drill="orderLines"]', action: 'sales-metric', detail: { metricKey: 'orderLines', metricLabel: 'Order Lines' } }
    ];

    mappings.forEach(({ selector, action, detail }) => {
        const node = document.querySelector(selector);
        if (!node) {
            return;
        }
        if (node.getAttribute('data-drilldown-bound') === '1') {
            return;
        }
        node.setAttribute('data-drilldown-bound', '1');
        const trigger = () => {
            if (!salesDrilldownState.summary) {
                return;
            }
            openSalesDrilldown(action, Object.assign({}, detail));
        };
        node.addEventListener('click', trigger);
        node.addEventListener('keydown', event => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                trigger();
            }
        });
    });
}

function triggerSalesDrilldown(element) {
    if (!element) {
        return;
    }
    const action = element.getAttribute('data-drilldown-action');
    if (!action) {
        return;
    }
    const detail = Object.assign({}, element.dataset);
    delete detail.drilldownAction;
    openSalesDrilldown(action, detail);
}

function openSalesDrilldown(action, detail = {}) {
    const view = buildSalesDrilldownView(action, detail, salesDrilldownState);
    if (!view || !view.content) {
        return;
    }
    openDrilldownPanel({
        title: view.title || 'Sales Detail',
        content: view.content,
        maxWidth: view.maxWidth || 960
    });
}

function buildSalesDrilldownView(action, detail, state) {
    if (!state || !state.summary) {
        return null;
    }
    switch (action) {
        case 'sales-metric':
            return buildSalesMetricsOverview(state, detail);
        case 'sales-performance':
            return buildSalesPerformanceDetails(state);
        case 'sales-leaders':
            return buildSalesLeadersDetails(state);
        case 'sales-top-reps':
            return buildSalesTopRepsDetails(state);
        case 'sales-divisions':
            return buildSalesDivisionDetails(state);
        case 'sales-momentum':
            return buildSalesMomentumDetails(state);
        default:
            return buildSalesMetricsOverview(state, detail);
    }
}

function buildSalesMetricsOverview(state, detail = {}) {
    const summary = state.summary;
    if (!summary) {
        return null;
    }
    const highlightKey = detail.metricKey || null;
    const metricLabel = detail.metricLabel ? String(detail.metricLabel) : '';
    const viewLabel = state.options && typeof state.options.contextLabel === 'string'
        ? state.options.contextLabel
        : '';
    const rows = [
        { key: 'records', label: 'Records analysed', value: summary.totalRecords.toLocaleString('en-ZA'), note: 'Normalized sales rows feeding the dashboard.' },
        { key: 'turnover', label: 'Total turnover', value: formatSalesCurrency(summary.totalTurnover), note: 'Sum of turnover across all uploaded rows.' },
        { key: 'cost', label: 'Total cost', value: formatSalesCurrency(summary.totalCost), note: 'Direct cost associated to the sales data.' },
        { key: 'grossProfit', label: 'Gross profit', value: formatSalesCurrency(summary.totalGrossProfit), note: 'Turnover less cost before overheads.' },
        { key: 'avgDealSize', label: 'Average deal size', value: formatSalesCurrency(summary.avgDealSize), note: 'Mean turnover per recorded row.' },
        { key: 'highestDeal', label: 'Largest deal', value: formatSalesCurrency(summary.highestDeal), note: 'Highest single turnover value captured.' },
        { key: 'lowestDeal', label: 'Smallest deal', value: summary.lowestDeal > 0 ? formatSalesCurrency(summary.lowestDeal) : 'No positive turnover recorded', note: 'Lowest positive turnover available.' },
        { key: 'orderLines', label: 'Order lines', value: summary.totalOrderLines.toLocaleString('en-ZA'), note: 'Sum of order line counts or units.' },
        { key: 'reps', label: 'Active sales reps', value: summary.uniqueReps.toLocaleString('en-ZA'), note: 'Distinct sales representatives with turnover.' },
        { key: 'divisions', label: 'Reporting divisions', value: summary.uniqueDivisions.toLocaleString('en-ZA'), note: 'Divisions contributing to turnover.' },
        { key: 'customers', label: 'Unique customers', value: summary.uniqueCustomers.toLocaleString('en-ZA'), note: 'Distinct customers encountered in dataset.' },
        { key: 'activeCustomersUnder1k12m', label: 'Active <R1000 (12m)', value: Number(summary.activeUnder1k12m || 0).toLocaleString('en-ZA'), note: 'Customers who purchased in the last 12 months with total turnover under R1000.' }
    ];
    if (summary.targetAchievementAvg !== null) {
        rows.push({
            key: 'targetAchievement',
            label: 'Average target achievement',
            value: `${summary.targetAchievementAvg.toFixed(1)}%`,
            note: 'Mean of target achievement % present in sales records.'
        });
    }
    const turnoverBucket = state.targetSummary && state.targetSummary.turnover ? state.targetSummary.turnover : null;
    if (turnoverBucket && (Number.isFinite(turnoverBucket.target) || Number.isFinite(turnoverBucket.actualFromTargets))) {
        const targetText = Number.isFinite(turnoverBucket.target)
            ? formatSalesCurrency(turnoverBucket.target)
            : 'Target not set';
        const actualText = Number.isFinite(turnoverBucket.actualFromTargets)
            ? formatSalesCurrency(turnoverBucket.actualFromTargets)
            : 'Actuals not provided';
        const achievementText = Number.isFinite(turnoverBucket.target) && turnoverBucket.target !== 0 && Number.isFinite(summary.totalTurnover)
            ? `${((summary.totalTurnover / turnoverBucket.target) * 100).toFixed(1)}% of uploaded target`
            : 'No comparative target available';
        rows.push({
            key: 'turnoverTarget',
            label: 'Target comparison',
            value: targetText,
            note: `${achievementText}. Uploaded actuals: ${actualText}.`
        });
    }

    const rowsHtml = rows.map(row => {
        const isHighlight = highlightKey && row.key === highlightKey;
        const valueText = row.value === null || row.value === undefined ? '-' : String(row.value);
        const noteText = row.note ? String(row.note) : '';
        const noteHtml = noteText
            ? `<div style="font-size:12px;color:#64748b;margin-top:4px">${escapeHtml(noteText)}</div>`
            : '';
        return `
            <tr style="background:${isHighlight ? '#fef3c7' : '#ffffff'}">
                <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(row.label)}</th>
                <td style="padding:10px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a;font-weight:600">${escapeHtml(valueText)}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${noteHtml}</td>
            </tr>`;
    }).join('');

    const contextSuffix = viewLabel ? ` (${escapeHtml(viewLabel)} view)` : '';
    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <p style="margin:0;color:#475569;font-size:13px">KPI breakdown${contextSuffix}. Metrics reflect the currently loaded sales dataset.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:520px">
                    <tbody>${rowsHtml}</tbody>
                </table>
            </div>
        </div>`;

    const titleParts = [];
    if (metricLabel) {
        titleParts.push(`${metricLabel} Drill-down`);
    } else {
        titleParts.push('Sales Metrics Overview');
    }
    if (viewLabel) {
        titleParts.push(`${viewLabel} view`);
    }

    return {
        title: titleParts.join(' Â· '),
        content,
        maxWidth: 900
    };
}

function buildSalesPerformanceDetails(state) {
    const summary = state.summary;
    const normalized = Array.isArray(state.normalized) ? state.normalized : [];
    const deals = normalized.filter(entry => Number.isFinite(entry.turnover) && entry.turnover > 0 && !isExcludedFromTopDeals(entry));
    const sortedDeals = deals.slice().sort((a, b) => b.turnover - a.turnover);
    const topDeals = sortedDeals.slice(0, 15);
    const smallestDeals = sortedDeals.slice(-10).reverse();

    const buildDealRow = (deal, index) => {
        const labelCustomer = deal.customer || deal.customerDisplay || 'Unassigned Customer';
        const labelRep = deal.salesRep || 'Unassigned';
        const labelDivision = deal.division || 'Unassigned';
        const dateLabel = deal.date instanceof Date && !Number.isNaN(deal.date.getTime())
            ? formatSalesDateLabel(deal.date, { mode: 'human' })
            : '-';
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(labelCustomer)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(labelRep)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(labelDivision)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#059669;text-align:right;font-weight:600">${formatSalesCurrency(deal.turnover)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(dateLabel)}</td>
            </tr>`;
    };

    const topDealsRows = topDeals.length > 0
        ? topDeals.map((deal, index) => buildDealRow(deal, index)).join('')
        : '<tr><td colspan="6" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No positive turnover available.</td></tr>';

    const bottomDealsRows = smallestDeals.length > 0
        ? smallestDeals.map((deal, index) => buildDealRow(deal, index)).join('')
        : '<tr><td colspan="6" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No positive turnover available.</td></tr>';

    const dateInfo = summary.dateInfo || {};
    const stats = [
        { label: 'Average deal', value: formatSalesCurrency(summary.avgDealSize) },
        { label: 'Largest deal', value: formatSalesCurrency(summary.highestDeal) },
        { label: 'Smallest positive deal', value: summary.lowestDeal > 0 ? formatSalesCurrency(summary.lowestDeal) : 'No positive turnover' },
        { label: 'Average gross margin', value: summary.avgGrossMargin !== null ? `${summary.avgGrossMargin.toFixed(1)}%` : 'Not provided' },
        { label: 'Turnover last 30 days', value: formatSalesCurrency(dateInfo.last30DaysTurnover || 0) },
        { label: 'Deals last 30 days', value: Number(dateInfo.last30DaysDeals || 0).toLocaleString('en-ZA') }
    ];

    const statsHtml = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px">
            ${stats.map(stat => `
                <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px">
                    <div style="font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">${escapeHtml(stat.label)}</div>
                    <div style="font-size:18px;font-weight:700;color:#0f172a">${escapeHtml(String(stat.value))}</div>
                </div>
            `).join('')}
        </div>`;

    const recentMonths = Array.isArray(dateInfo.recentMonths) ? dateInfo.recentMonths : [];
    const monthRows = recentMonths.length > 0
        ? recentMonths.map(month => {
            const turnoverText = formatSalesCurrency(month.turnover || 0);
            const dealsText = Number(month.deals || 0).toLocaleString('en-ZA');
            return `
                <tr>
                    <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(month.label)}</td>
                    <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#059669;text-align:right;font-weight:600">${turnoverText}</td>
                    <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(dealsText)}</td>
                </tr>`;
        }).join('')
        : '<tr><td colspan="3" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No recent monthly trend data captured.</td></tr>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <div style="font-size:12px;color:#475569;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px">ICO Exports are included in totals but hidden from the Top/Bottom deal tables.</div>
            ${statsHtml}
            <div>
                <h4 style="margin:0 0 8px 0;font-size:15px;color:#0f172a;font-weight:600">Largest deals</h4>
                <div style="overflow-x:auto">
                    <table style="border-collapse:collapse;width:100%;min-width:640px">
                        <thead>
                            <tr style="background:#f1f5f9">
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Customer</th>
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Sales Rep</th>
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Division</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Date</th>
                            </tr>
                        </thead>
                        <tbody>${topDealsRows}</tbody>
                    </table>
                </div>
            </div>
            <div>
                <h4 style="margin:8px 0 8px 0;font-size:15px;color:#0f172a;font-weight:600">Smallest positive deals</h4>
                <div style="overflow-x:auto">
                    <table style="border-collapse:collapse;width:100%;min-width:640px">
                        <thead>
                            <tr style="background:#f1f5f9">
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Customer</th>
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Sales Rep</th>
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Division</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Date</th>
                            </tr>
                        </thead>
                        <tbody>${bottomDealsRows}</tbody>
                    </table>
                </div>
            </div>
            <div>
                <h4 style="margin:8px 0 8px 0;font-size:15px;color:#0f172a;font-weight:600">Recent momentum</h4>
                <div style="overflow-x:auto">
                    <table style="border-collapse:collapse;width:100%;min-width:420px">
                        <thead>
                            <tr style="background:#f1f5f9">
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Month</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Deals</th>
                            </tr>
                        </thead>
                        <tbody>${monthRows}</tbody>
                    </table>
                </div>
            </div>
        </div>`;

    return {
        title: 'Performance Pulse Â· Drill-down',
        content,
        maxWidth: 1000
    };
}

function buildSalesLeadersDetails(state) {
    const summary = state.summary;
    if (!summary) {
        return null;
    }
    const totalTurnover = summary.totalTurnover || 0;
    const repRows = summary.topSalesReps.slice(0, 15).map((rep, index) => {
        const share = totalTurnover ? ((rep.turnover / totalTurnover) * 100).toFixed(1) : '0.0';
        const divisions = Array.isArray(rep.divisions) && rep.divisions.length > 0
            ? rep.divisions.map(escapeHtml).join(', ')
            : 'â€”';
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(rep.name)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${rep.deals}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#059669;text-align:right;font-weight:600">${formatSalesCurrency(rep.turnover)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(share)}%</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${divisions}</td>
            </tr>`;
    }).join('') || '<tr><td colspan="6" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No sales representative data available.</td></tr>';

    const divisionRows = summary.topDivisions.slice(0, 12).map((division, index) => {
        const share = totalTurnover ? ((division.turnover / totalTurnover) * 100).toFixed(1) : '0.0';
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(division.name)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${division.deals}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#059669;text-align:right;font-weight:600">${formatSalesCurrency(division.turnover)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(share)}%</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${division.reps}</td>
            </tr>`;
    }).join('') || '<tr><td colspan="6" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No division data available.</td></tr>';

    const dateInfo = summary.dateInfo || {};
    const contextLines = [
        dateInfo.rangeLabel ? `Data period: ${dateInfo.rangeLabel}` : null,
        `Turnover per rep: ${formatSalesCurrency(summary.turnoverPerRep, { decimals: 0 })}`,
        `Turnover per division: ${formatSalesCurrency(summary.turnoverPerDivision, { decimals: 0 })}`
    ].filter(Boolean);

    const contextHtml = contextLines.length > 0
        ? `<p style="margin:0;color:#475569;font-size:13px">${contextLines.map(line => escapeHtml(line)).join(' â€¢ ')}</p>`
        : '';

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            ${contextHtml}
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px">
                <div style="background:#ffffff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 2px 6px rgba(15,23,42,0.08);overflow:hidden">
                    <div style="padding:12px 16px;border-bottom:1px solid #e2e8f0;font-weight:600;color:#0f172a;font-size:14px">Top sales reps</div>
                    <div style="overflow-x:auto">
                        <table style="border-collapse:collapse;width:100%;min-width:560px">
                            <thead>
                                <tr style="background:#f1f5f9">
                                    <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                                    <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Sales Rep</th>
                                    <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Deals</th>
                                    <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                                    <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Share</th>
                                    <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Divisions</th>
                                </tr>
                            </thead>
                            <tbody>${repRows}</tbody>
                        </table>
                    </div>
                </div>
                <div style="background:#ffffff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 2px 6px rgba(15,23,42,0.08);overflow:hidden">
                    <div style="padding:12px 16px;border-bottom:1px solid #e2e8f0;font-weight:600;color:#0f172a;font-size:14px">Top divisions</div>
                    <div style="overflow-x:auto">
                        <table style="border-collapse:collapse;width:100%;min-width:520px">
                            <thead>
                                <tr style="background:#f1f5f9">
                                    <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                                    <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Division</th>
                                    <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Deals</th>
                                    <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                                    <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Share</th>
                                    <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Active reps</th>
                                </tr>
                            </thead>
                            <tbody>${divisionRows}</tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>`;

    return {
        title: 'Leaders & Period Â· Drill-down',
        content,
        maxWidth: 980
    };
}

function buildSalesTopRepsDetails(state) {
    const summary = state.summary;
    if (!summary) {
        return null;
    }
    const totalTurnover = summary.totalTurnover || 0;
    const rows = summary.topSalesReps.slice(0, 25).map((rep, index) => {
        const share = totalTurnover ? ((rep.turnover / totalTurnover) * 100).toFixed(1) : '0.0';
        const customers = Number(rep.customers || 0).toLocaleString('en-ZA');
        const divisions = Array.isArray(rep.divisions) && rep.divisions.length > 0
            ? rep.divisions.map(escapeHtml).join(', ')
            : 'â€”';
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(rep.name)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${rep.deals}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${customers}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#059669;text-align:right;font-weight:600">${formatSalesCurrency(rep.turnover)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(share)}%</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${divisions}</td>
            </tr>`;
    }).join('') || '<tr><td colspan="7" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No sales representative data available.</td></tr>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <p style="margin:0;color:#475569;font-size:13px">Turnover ranking for the leading sales reps across the loaded dataset.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:680px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Sales Rep</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Deals</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Customers</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Share</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Divisions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;

    return {
        title: 'Top Sales Reps Â· Drill-down',
        content,
        maxWidth: 960
    };
}

function buildSalesDivisionDetails(state) {
    const summary = state.summary;
    if (!summary) {
        return null;
    }
    const totalTurnover = summary.totalTurnover || 0;
    const rows = summary.topDivisions.slice(0, 20).map((division, index) => {
        const share = totalTurnover ? ((division.turnover / summary.totalTurnover) * 100).toFixed(1) : '0.0';
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(division.name)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${division.deals}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${division.reps}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#059669;text-align:right;font-weight:600">${formatSalesCurrency(division.turnover)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(share)}%</td>
            </tr>`;
    }).join('') || '<tr><td colspan="6" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No division data available.</td></tr>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <p style="margin:0;color:#475569;font-size:13px">Division performance split by turnover, deal volume, and participating reps.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:600px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Division</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Deals</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Active reps</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Share</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;

    return {
        title: 'Division Turnover Â· Drill-down',
        content,
        maxWidth: 900
    };
}

function buildSalesMomentumDetails(state) {
    const summary = state.summary;
    if (!summary) {
        return null;
    }
    const dateInfo = summary.dateInfo || {};
    const recentMonths = Array.isArray(dateInfo.recentMonths) ? dateInfo.recentMonths : [];
    const monthRows = recentMonths.length > 0
        ? recentMonths.map(month => {
            const turnoverText = formatSalesCurrency(month.turnover || 0);
            const dealsText = Number(month.deals || 0).toLocaleString('en-ZA');
            return `
                <tr>
                    <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(month.label)}</td>
                    <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#059669;text-align:right;font-weight:600">${turnoverText}</td>
                    <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(dealsText)}</td>
                </tr>`;
        }).join('')
        : '<tr><td colspan="3" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No month-on-month history available.</td></tr>';

    const insightLines = [];
    if (summary.topSalesReps && summary.topSalesReps[0]) {
        const leadingRep = summary.topSalesReps[0];
        const repName = leadingRep.name ? escapeHtml(leadingRep.name) : 'Top rep';
        insightLines.push(`${repName} leads with ${formatSalesCurrency(leadingRep.turnover)} across ${leadingRep.deals} deals.`);
    }
    if (summary.topDivisions && summary.topDivisions[0]) {
        const leadingDivision = summary.topDivisions[0];
        const share = summary.totalTurnover ? ((leadingDivision.turnover / summary.totalTurnover) * 100).toFixed(1) : '0.0';
        const divisionName = leadingDivision.name ? escapeHtml(leadingDivision.name) : 'Top division';
        insightLines.push(`${divisionName} division contributes ${formatSalesCurrency(leadingDivision.turnover)} (${share}%).`);
    }
    if (dateInfo.last30DaysTurnover) {
        insightLines.push(`Last 30 days delivered ${formatSalesCurrency(dateInfo.last30DaysTurnover)} over ${Number(dateInfo.last30DaysDeals || 0).toLocaleString('en-ZA')} deals.`);
    }
    if (dateInfo.last30DaysCustomers) {
        insightLines.push(`${Number(dateInfo.last30DaysCustomers).toLocaleString('en-ZA')} customers placed orders in the last 30 days.`);
    }

    const insightHtml = insightLines.length > 0
        ? `<ul style="margin:0;padding-left:18px;color:#475569;font-size:13px">${insightLines.map(line => `<li>${escapeHtml(line)}</li>`).join('')}</ul>`
        : '<p style="margin:0;color:#6b7280;font-size:13px">No additional momentum highlights computed.</p>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
                ${[
                    { label: 'Avg turnover per rep', value: formatSalesCurrency(summary.turnoverPerRep, { decimals: 0 }) },
                    { label: 'Avg turnover per division', value: formatSalesCurrency(summary.turnoverPerDivision, { decimals: 0 }) },
                    { label: 'Order lines analysed', value: summary.totalOrderLines.toLocaleString('en-ZA') },
                    { label: 'Deals (30 days)', value: Number(dateInfo.last30DaysDeals || 0).toLocaleString('en-ZA') },
                    { label: 'Active customers (30 days)', value: Number(dateInfo.last30DaysCustomers || 0).toLocaleString('en-ZA') },
                    { label: 'Turnover (30 days)', value: formatSalesCurrency(dateInfo.last30DaysTurnover || 0) }
                ].map(metric => `
                    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px">
                        <div style="font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">${escapeHtml(metric.label)}</div>
                        <div style="font-size:18px;font-weight:700;color:#0f172a">${escapeHtml(String(metric.value))}</div>
                    </div>
                `).join('')}
            </div>
            <div>
                <h4 style="margin:0 0 8px 0;font-size:15px;color:#0f172a;font-weight:600">Monthly cadence</h4>
                <div style="overflow-x:auto">
                    <table style="border-collapse:collapse;width:100%;min-width:420px">
                        <thead>
                            <tr style="background:#f1f5f9">
                                <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Month</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Turnover</th>
                                <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Deals</th>
                            </tr>
                        </thead>
                        <tbody>${monthRows}</tbody>
                    </table>
                </div>
            </div>
            <div>
                <h4 style="margin:0 0 8px 0;font-size:15px;color:#0f172a;font-weight:600">Momentum callouts</h4>
                ${insightHtml}
            </div>
        </div>`;

    return {
        title: 'Momentum Â· Drill-down',
        content,
        maxWidth: 900
    };
}

function getSalesTurnover(item) {
    if (!item) {
        return 0;
    }
    if (typeof item === 'number') {
        return item;
    }
    if (item.turnover !== undefined) {
        return Number(item.turnover) || 0;
    }
    return parseSalesCurrency(resolveSalesField(item, 'turnover'));
}

function isExcludedFromTopDeals(entry = {}) {
    const group = (entry.salesGroup || entry.salesGroupName || '').toLowerCase();
    const division = (entry.division || '').toLowerCase();
    const customer = (entry.customer || entry.customerName || '').toLowerCase();
    const rep = (entry.salesRep || entry.salesRepName || '').toLowerCase();
    return group.includes('ico export') || division.includes('ico export') || customer.includes('ico export') || rep.includes('ico export');
}

function getSalesDateInfo(data = []) {
    let minDate = null;
    let maxDate = null;
    let last30DaysTurnover = 0;
    let last30DaysDeals = 0;
    const last30DaysCustomers = new Set();
    const monthlyBuckets = new Map();
    const today = new Date();
    const last30Threshold = new Date(today.getTime() - 29 * 86400000);

    data.forEach(entry => {
        if (!(entry.date instanceof Date) || Number.isNaN(entry.date.getTime())) {
            return;
        }
        if (!minDate || entry.date < minDate) {
            minDate = entry.date;
        }
        if (!maxDate || entry.date > maxDate) {
            maxDate = entry.date;
        }

        const monthKey = `${entry.date.getFullYear()}-${String(entry.date.getMonth() + 1).padStart(2, '0')}`;
        if (!monthlyBuckets.has(monthKey)) {
            monthlyBuckets.set(monthKey, { turnover: 0, deals: 0, date: new Date(entry.date.getFullYear(), entry.date.getMonth(), 1) });
        }
        const bucket = monthlyBuckets.get(monthKey);
        bucket.turnover += entry.turnover;
        bucket.deals += 1;

        if (entry.date >= last30Threshold) {
            last30DaysTurnover += entry.turnover;
            last30DaysDeals += 1;
            const customerKey = entry.customerId || entry.customer || entry.customerDisplay || `row-${entry.rowIndex}`;
            if (customerKey) {
                last30DaysCustomers.add(customerKey);
            }
        }
    });

    const rangeLabel = minDate && maxDate
        ? `${formatSalesDateLabel(minDate, { mode: 'human' })} â†’ ${formatSalesDateLabel(maxDate, { mode: 'human' })}`
        : 'No date data';

    const recentMonths = Array.from(monthlyBuckets.values())
        .sort((a, b) => a.date - b.date)
        .slice(-6)
        .map(bucket => ({
            label: formatSalesDateLabel(bucket.date, { mode: 'month' }),
            turnover: bucket.turnover,
            deals: bucket.deals
        }));

    return {
        minDate,
        maxDate,
        rangeLabel,
        recentMonths,
        last30DaysTurnover,
        last30DaysDeals,
        last30DaysCustomers: last30DaysCustomers.size
    };
}

function normalizeSalesData(data = []) {
    if (!Array.isArray(data) || data.length === 0) {
        return [];
    }

    return data.map((row, rowIndex) => {
        const rawDivision = resolveSalesField(row, 'division');
        const rawGroup = resolveSalesField(row, 'salesGroup');
        const rawGroupCode = resolveSalesField(row, 'salesGroupCode');
        const rawBusinessCo = resolveSalesField(row, 'businessCo');
        const rawRep = resolveSalesField(row, 'salesRep');
        const rawCustomer = resolveSalesField(row, 'customer');
        const rawCustomerId = resolveFieldByAliases(row, SALES_FIELD_ALIASES.customerId || []);
        const rawDate = resolveSalesField(row, 'date');
        const rawUnits = resolveSalesField(row, 'units');
        const rawTarget = resolveSalesField(row, 'target');
        const rawCost = resolveSalesField(row, 'cost');
        const rawGrossProfit = resolveSalesField(row, 'grossProfit');
        const rawGrossMargin = resolveSalesField(row, 'grossMargin');
        const rawOrderLines = resolveSalesField(row, 'orderLines');
        const rawProductName = resolveFieldByAliases(row, SALES_FIELD_ALIASES.productName || []);
        const rawProductCode = resolveFieldByAliases(row, SALES_FIELD_ALIASES.productCode || []);
        const rawProductCategory = resolveFieldByAliases(row, SALES_FIELD_ALIASES.productCategory || []);
        const rawSalesSector2 = resolveFieldByAliases(row, SALES_FIELD_ALIASES.salesSector2 || []);
        const rawPowerProduct = resolveFieldByAliases(row, SALES_FIELD_ALIASES.powerProduct || []);

        const parsedDate = parseSalesDate(rawDate);
        const turnover = getSalesTurnover(row);

        const cleanProductName = cleanSalesText(rawProductName);
        const cleanProductCode = cleanSalesText(rawProductCode);
        const cleanProductCategory = cleanSalesText(rawProductCategory);
        const cleanSalesSector2 = cleanSalesText(rawSalesSector2) || cleanSalesText(rawDivision) || 'Unspecified';
        const productLabel = cleanProductCode && cleanProductName
            ? `${cleanProductCode} - ${cleanProductName}`
            : (cleanProductName || cleanProductCode || 'Unspecified Product');
        const powerProduct = normalizePowerProductFlag(rawPowerProduct);

        const cleanGroup = cleanSalesText(rawGroup);
        const cleanGroupCode = cleanSalesText(rawGroupCode);
        const groupDisplay = cleanGroupCode && cleanGroup
            ? `${cleanGroupCode} - ${cleanGroup}`
            : (cleanGroup || cleanGroupCode);
        const cleanCustomerId = cleanSalesText(rawCustomerId);
        const cleanCustomerName = cleanSalesText(rawCustomer);
        const customerLabel = cleanCustomerId && cleanCustomerName
            ? `${cleanCustomerId} - ${cleanCustomerName}`
            : (cleanCustomerName || cleanCustomerId || 'Unassigned Customer');

        return {
            raw: row,
            rowIndex,
            division: cleanSalesText(rawDivision) || 'Unassigned',
            salesGroup: groupDisplay,
            salesGroupName: cleanGroup,
            salesGroupCode: cleanGroupCode,
            businessCo: cleanSalesText(rawBusinessCo),
            salesRep: cleanSalesText(rawRep) || 'Unassigned',
            customerId: cleanCustomerId,
            customerName: cleanCustomerName,
            customerDisplay: customerLabel,
            customer: customerLabel,
            units: parseSalesNumber(rawUnits || rawOrderLines),
            turnover,
            targetAchievement: parseSalesPercentage(rawTarget),
            cost: parseSalesCurrency(rawCost),
            grossProfit: parseSalesCurrency(rawGrossProfit),
            grossMargin: parseSalesPercentage(rawGrossMargin),
            orderLines: parseSalesNumber(rawOrderLines),
            productName: cleanProductName,
            productCode: cleanProductCode,
            productLabel,
            productCategory: cleanProductCategory,
            salesSector2: cleanSalesSector2,
            powerProduct,
            date: parsedDate,
            dateKey: parsedDate ? parsedDate.toISOString().slice(0, 10) : '',
            monthKey: parsedDate ? `${parsedDate.getFullYear()}-${String(parsedDate.getMonth() + 1).padStart(2, '0')}` : ''
        };
    });
}

function getSalesMeta(normalized = []) {
    const divisions = new Set();
    const salesGroups = new Set();
    const businessCos = new Set();
    const salesReps = new Set();
    const customers = new Set();
    const products = new Set();
    const productCodes = new Set();
    const salesSectors = new Set();
    const powerFlags = new Set();
    let totalTurnover = 0;
    let totalUnits = 0;
    let totalCost = 0;
    let totalGrossProfit = 0;
    let totalOrderLines = 0;

    normalized.forEach(entry => {
        if (entry.division) {
            divisions.add(entry.division);
        }
        if (entry.salesGroup) {
            salesGroups.add(entry.salesGroup);
        }
        if (entry.businessCo) {
            businessCos.add(entry.businessCo);
        }
        if (entry.salesRep) {
            salesReps.add(entry.salesRep);
        }
        if (entry.customer) {
            customers.add(entry.customer);
        }
        if (entry.productLabel) {
            products.add(entry.productLabel);
        }
        if (entry.productCode) {
            productCodes.add(entry.productCode);
        }
        if (entry.salesSector2) {
            salesSectors.add(entry.salesSector2);
        }
        if (entry.powerProduct) {
            powerFlags.add('Yes');
        }
        totalTurnover += entry.turnover;
        totalUnits += entry.units;
        totalCost += entry.cost || 0;
        totalGrossProfit += entry.grossProfit || 0;
        totalOrderLines += entry.orderLines || entry.units || 0;
    });

    return {
        divisions: Array.from(divisions).sort(),
        salesGroups: Array.from(salesGroups).sort(),
        businessCos: Array.from(businessCos).sort(),
        salesReps: Array.from(salesReps).sort(),
        customers: Array.from(customers).sort(),
        products: Array.from(products).sort(),
        productCodes: Array.from(productCodes).sort(),
        salesSectors: Array.from(salesSectors).sort(),
        powerFlags: Array.from(powerFlags).sort(),
        dateInfo: getSalesDateInfo(normalized),
        totals: {
            turnover: totalTurnover,
            units: totalUnits,
            cost: totalCost,
            grossProfit: totalGrossProfit,
            orderLines: totalOrderLines
        }
    };
}

function normalizeProductData(data = []) {
    if (!Array.isArray(data) || data.length === 0) {
        return [];
    }

    return data.map((row, rowIndex) => {
        const rawDivision = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.division || []);
        const rawGroup = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.salesGroup || []);
        const rawRep = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.salesRep || []);
        const rawRepCode = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.repCode || []);
        const rawBusinessCo = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.businessCo || []);
        const rawProductName = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.productName || []);
        const rawProductCode = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.productCode || []);
        const rawProductCategory = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.productCategory || []);
        const rawTurnover = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.turnover || []);
        const rawGrossProfit = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.grossProfit || []);
        const rawGrossMargin = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.grossMargin || []);
        const rawUnits = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.units || []);
        const rawPowerProduct = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.powerProduct || []);
        const rawSalesSector2 = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.salesSector2 || []);
        const rawTarget = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.target || []);
        const rawTargetAchievement = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.targetAchievement || []);
        const rawStillNeeded = resolveFieldByAliases(row, PRODUCT_FIELD_ALIASES.stillNeeded || []);

        const turnover = rawTurnover !== undefined ? parseSalesCurrency(rawTurnover) : getSalesTurnover(row);
        const grossProfit = parseSalesCurrency(rawGrossProfit);
        const grossMargin = parseSalesPercentage(rawGrossMargin);
        const units = parseSalesNumber(rawUnits);
        const cleanProductName = cleanSalesText(rawProductName);
        const cleanProductCode = cleanSalesText(rawProductCode);
        const productLabel = cleanProductName || cleanProductCode || 'Unspecified Product';

        const cleanDivision = cleanSalesText(rawDivision) || 'Unassigned';
        const cleanGroup = cleanSalesText(rawGroup);
        const groupDisplay = cleanGroup || 'Unassigned Group';
        const powerProduct = normalizePowerProductFlag(rawPowerProduct);
        const salesSector2 = cleanSalesText(rawSalesSector2) || cleanDivision || 'Unspecified';

        return {
            raw: row,
            rowIndex,
            division: cleanDivision,
            salesGroup: groupDisplay,
            salesGroupName: cleanGroup,
            salesRep: cleanSalesText(rawRep) || 'Unassigned',
            repCode: cleanSalesText(rawRepCode),
            businessCo: cleanSalesText(rawBusinessCo),
            productName: cleanProductName,
            productCode: cleanProductCode,
            productLabel,
            productCategory: cleanSalesText(rawProductCategory),
            salesSector2,
            powerProduct,
            turnover,
            grossProfit,
            grossMargin,
            units,
            orderLines: units,
            targetAchievement: parseSalesPercentage(rawTargetAchievement),
            target: parseSalesCurrency(rawTarget),
            stillNeeded: parseSalesCurrency(rawStillNeeded)
        };
    });
}

function getProductMeta(normalized = []) {
    const divisions = new Set();
    const salesGroups = new Set();
    const salesReps = new Set();
    const products = new Set();
    const productCodes = new Set();
    const salesSectors = new Set();
    const powerFlags = new Set();
    let totalTurnover = 0;
    let totalGrossProfit = 0;
    let totalUnits = 0;

    normalized.forEach(entry => {
        if (entry.division) divisions.add(entry.division);
        if (entry.salesGroup) salesGroups.add(entry.salesGroup);
        if (entry.salesRep) salesReps.add(entry.salesRep);
        if (entry.productLabel) products.add(entry.productLabel);
        if (entry.productCode) productCodes.add(entry.productCode);
        if (entry.salesSector2) salesSectors.add(entry.salesSector2);
        if (entry.powerProduct) powerFlags.add('Yes');
        totalTurnover += entry.turnover || 0;
        totalGrossProfit += entry.grossProfit || 0;
        totalUnits += entry.units || 0;
    });

    return {
        divisions: Array.from(divisions).sort(),
        salesGroups: Array.from(salesGroups).sort(),
        salesReps: Array.from(salesReps).sort(),
        products: Array.from(products).sort(),
        productCodes: Array.from(productCodes).sort(),
        salesSectors: Array.from(salesSectors).sort(),
        powerFlags: Array.from(powerFlags).sort(),
        totals: {
            turnover: totalTurnover,
            grossProfit: totalGrossProfit,
            units: totalUnits
        }
    };
}

function summarizeSalesData(normalized = []) {
    if (!Array.isArray(normalized) || normalized.length === 0) {
        return {
            totalRecords: 0,
            totalTurnover: 0,
            totalUnits: 0,
            totalCost: 0,
            totalGrossProfit: 0,
            totalOrderLines: 0,
            avgDealSize: 0,
            highestDeal: 0,
            lowestDeal: 0,
            uniqueReps: 0,
            uniqueDivisions: 0,
            uniqueCustomers: 0,
            activeCustomersLast30Days: 0,
            activeUnder1k12m: 0,
            topSalesReps: [],
            topDivisions: [],
            topCustomersByRep: [],
            dateInfo: getSalesDateInfo([]),
            turnoverPerRep: 0,
            turnoverPerDivision: 0,
            targetAchievementAvg: null,
            avgGrossMargin: null
        };
    }

    const repMap = new Map();
    const divisionMap = new Map();
    const repCustomerMap = new Map();
    const customers = new Set();
    let totalTurnover = 0;
    let totalUnits = 0;
    let totalCost = 0;
    let totalGrossProfit = 0;
    let totalOrderLines = 0;
    let highestDeal = 0;
    let lowestDeal = Number.POSITIVE_INFINITY;
    let targetSum = 0;
    let targetCount = 0;
    let grossMarginSum = 0;
    let grossMarginCount = 0;

    normalized.forEach(entry => {
        const isRepExcluded = isExcludedFromTopDeals(entry);
        totalTurnover += entry.turnover;
        totalUnits += entry.units;
        totalCost += entry.cost || 0;
        totalGrossProfit += entry.grossProfit || 0;
        totalOrderLines += entry.orderLines || entry.units || 0;
        highestDeal = Math.max(highestDeal, entry.turnover);
        if (entry.turnover > 0) {
            lowestDeal = Math.min(lowestDeal, entry.turnover);
        }

        if (!isRepExcluded) {
            const repKey = entry.salesRep || 'Unassigned';
            if (!repMap.has(repKey)) {
                repMap.set(repKey, {
                    name: repKey,
                    turnover: 0,
                    deals: 0,
                    divisions: new Set(),
                    customers: new Set()
                });
            }
            const repStats = repMap.get(repKey);
            repStats.turnover += entry.turnover;
            repStats.deals += 1;
            if (entry.division) {
                repStats.divisions.add(entry.division);
            }
            if (entry.customer) {
                repStats.customers.add(entry.customer);
            }

            if (!repCustomerMap.has(repKey)) {
                repCustomerMap.set(repKey, new Map());
            }
            const customerKey = entry.customerId || entry.customer || `${repKey}-${entry.rowIndex}`;
            if (!repCustomerMap.get(repKey).has(customerKey)) {
                repCustomerMap.get(repKey).set(customerKey, {
                    name: entry.customerDisplay || entry.customer || 'Unassigned Customer',
                    turnover: 0
                });
            }
            const customerStats = repCustomerMap.get(repKey).get(customerKey);
            customerStats.turnover += entry.turnover;
        }

        const divisionKey = entry.division || 'Unassigned';
        if (!divisionMap.has(divisionKey)) {
            divisionMap.set(divisionKey, {
                name: divisionKey,
                turnover: 0,
                deals: 0,
                reps: new Set()
            });
        }
        const divisionStats = divisionMap.get(divisionKey);
        divisionStats.turnover += entry.turnover;
        divisionStats.deals += 1;
        if (entry.salesRep && !isRepExcluded) {
            divisionStats.reps.add(entry.salesRep);
        }

        if (entry.customer) {
            customers.add(entry.customer);
        }

        if (Number.isFinite(entry.targetAchievement)) {
            targetSum += entry.targetAchievement;
            targetCount += 1;
        }

        if (Number.isFinite(entry.grossMargin)) {
            grossMarginSum += entry.grossMargin;
            grossMarginCount += 1;
        }
    });

    if (lowestDeal === Number.POSITIVE_INFINITY) {
        lowestDeal = 0;
    }

    const topSalesReps = Array.from(repMap.values())
        .map(stat => ({
            name: stat.name,
            turnover: stat.turnover,
            deals: stat.deals,
            divisions: Array.from(stat.divisions),
            customers: stat.customers.size
        }))
        .sort((a, b) => b.turnover - a.turnover);

    const topDivisions = Array.from(divisionMap.values())
        .map(stat => ({
            name: stat.name,
            turnover: stat.turnover,
            deals: stat.deals,
            reps: stat.reps.size
        }))
        .sort((a, b) => b.turnover - a.turnover);

    const topCustomersByRep = [];
    repCustomerMap.forEach((customerMap, repName) => {
        customerMap.forEach(customerStat => {
            topCustomersByRep.push({
                rep: repName,
                customer: customerStat.name,
                turnover: customerStat.turnover
            });
        });
    });

    topCustomersByRep.sort((a, b) => b.turnover - a.turnover);

    const dateInfo = getSalesDateInfo(normalized);
    const referenceDate = dateInfo.maxDate instanceof Date && !Number.isNaN(dateInfo.maxDate.getTime())
        ? dateInfo.maxDate
        : new Date();
    const twelveMonthsAgo = new Date(referenceDate.getTime() - 365 * DAY_IN_MS);
    const customerTotals12m = new Map();
    normalized.forEach(entry => {
        const entryDate = entry.date instanceof Date && !Number.isNaN(entry.date.getTime()) ? entry.date : null;
        if (!entryDate || entryDate < twelveMonthsAgo) {
            return;
        }
        const customerKey = entry.customerId || entry.customer || `row-${entry.rowIndex}`;
        const turnover = Number.isFinite(entry.turnover) ? Math.max(entry.turnover, 0) : 0;
        customerTotals12m.set(customerKey, (customerTotals12m.get(customerKey) || 0) + turnover);
    });
    const activeUnder1k12m = Array.from(customerTotals12m.values()).filter(total => total > 0 && total < 1000).length;

    return {
        totalRecords: normalized.length,
        totalTurnover,
        totalUnits,
        totalCost,
        totalGrossProfit,
        totalOrderLines,
        avgDealSize: normalized.length ? totalTurnover / normalized.length : 0,
        highestDeal,
        lowestDeal,
        uniqueReps: repMap.size,
        uniqueDivisions: divisionMap.size,
        uniqueCustomers: customers.size,
        activeCustomersLast30Days: dateInfo.last30DaysCustomers || 0,
        activeUnder1k12m,
        topSalesReps,
        topDivisions,
        topCustomersByRep,
        dateInfo,
        turnoverPerRep: repMap.size ? totalTurnover / repMap.size : 0,
        turnoverPerDivision: divisionMap.size ? totalTurnover / divisionMap.size : 0,
        targetAchievementAvg: targetCount ? targetSum / targetCount : null,
        avgGrossMargin: grossMarginCount ? grossMarginSum / grossMarginCount : null
    };
}

function parseCustomerPeriodToMonthKey(value) {
    if (value === undefined || value === null) {
        return '';
    }
    const raw = String(value).trim();
    if (!raw) {
        return '';
    }

    const dotMatch = raw.match(/^(\d{1,2})[\.\/-](\d{4})$/);
    if (dotMatch) {
        const month = parseInt(dotMatch[1], 10);
        const year = parseInt(dotMatch[2], 10);
        if (Number.isFinite(month) && Number.isFinite(year) && month >= 1 && month <= 12) {
            return `${year}-${String(month).padStart(2, '0')}`;
        }
    }

    const isoMatch = raw.match(/^(\d{4})[-\/]?(\d{2})(?:[-\/]\d{2})?$/);
    if (isoMatch) {
        const year = parseInt(isoMatch[1], 10);
        const month = parseInt(isoMatch[2], 10);
        if (Number.isFinite(month) && Number.isFinite(year) && month >= 1 && month <= 12) {
            return `${year}-${String(month).padStart(2, '0')}`;
        }
    }

    const parsedDate = parseSalesDate(raw);
    if (parsedDate instanceof Date && !Number.isNaN(parsedDate.getTime())) {
        return `${parsedDate.getFullYear()}-${String(parsedDate.getMonth() + 1).padStart(2, '0')}`;
    }

    return '';
}

function normalizeCustomerData(data = []) {
    if (!Array.isArray(data) || data.length === 0) {
        return [];
    }

    return data.map((row, rowIndex) => {
        const customerIdRaw = resolveCustomerField(row, 'customerId');
        const customerNameRaw = resolveCustomerField(row, 'customerName');
        const statusRaw = resolveCustomerField(row, 'customerStatus');
        const salesRepRaw = resolveCustomerField(row, 'salesRep');
        const salesAreaRaw = resolveCustomerField(row, 'salesArea');
        const salesTerritoryRaw = resolveCustomerField(row, 'salesTerritory');
        const divisionRaw = resolveCustomerField(row, 'salesDivision');
        const groupCodeRaw = resolveCustomerField(row, 'salesGroupCode');
        const groupNameRaw = resolveCustomerField(row, 'salesGroupName');
        const businessCodeRaw = resolveCustomerField(row, 'businessCode');
        const orgUnitRaw = resolveCustomerField(row, 'orgUnit');
        const emailRaw = resolveCustomerField(row, 'email');
        const phoneRaw = resolveCustomerField(row, 'phone');
        const lastOrderRaw = resolveCustomerField(row, 'lastOrderDate');
        const periodRaw = resolveCustomerField(row, 'period');
        const orderCountRaw = resolveCustomerField(row, 'orderCount');

        const customerId = cleanSalesText(customerIdRaw);
        const customerName = cleanSalesText(customerNameRaw);
        const status = cleanSalesText(statusRaw) || 'Unspecified';
        const salesRep = cleanSalesText(salesRepRaw) || 'Unassigned';
        const salesArea = cleanSalesText(salesAreaRaw);
        const salesTerritory = cleanSalesText(salesTerritoryRaw);
        const division = cleanSalesText(divisionRaw) || 'Unassigned';
        const salesGroupCode = cleanSalesText(groupCodeRaw);
        const salesGroupName = cleanSalesText(groupNameRaw);
        const salesGroupDisplay = salesGroupCode && salesGroupName
            ? `${salesGroupCode} - ${salesGroupName}`
            : (salesGroupName || salesGroupCode || 'Unassigned');
        const businessCode = cleanSalesText(businessCodeRaw);
        const orgUnit = cleanSalesText(orgUnitRaw);
        const email = cleanSalesText(emailRaw);
        const phone = cleanSalesText(phoneRaw);
        const orderCount = parseSalesNumber(orderCountRaw);

        let lastOrderDate = parseSalesDate(lastOrderRaw);
        if (!(lastOrderDate instanceof Date) || Number.isNaN(lastOrderDate.getTime())) {
            lastOrderDate = parseSalesDate(periodRaw);
        }
        const period = cleanSalesText(periodRaw);
        const monthKey = lastOrderDate instanceof Date && !Number.isNaN(lastOrderDate.getTime())
            ? `${lastOrderDate.getFullYear()}-${String(lastOrderDate.getMonth() + 1).padStart(2, '0')}`
            : parseCustomerPeriodToMonthKey(period || customerId);

        const lastOrderDateKey = lastOrderDate instanceof Date && !Number.isNaN(lastOrderDate.getTime())
            ? lastOrderDate.toISOString().slice(0, 10)
            : '';

        const customerLabel = customerName || customerId || `Customer ${rowIndex + 1}`;

        return {
            raw: row,
            rowIndex,
            customerId,
            customerName,
            customerLabel,
            customerKey: customerId || customerLabel,
            status,
            salesRep,
            salesArea,
            salesTerritory,
            division,
            salesGroupCode,
            salesGroupName,
            salesGroupDisplay,
            businessCode,
            orgUnit,
            email,
            phone,
            orderCount,
            lastOrderDate,
            lastOrderDateKey,
            monthKey,
            period,
            hasOrders: Number.isFinite(orderCount) && orderCount > 0
        };
    });
}

function getCustomerMeta(normalized = []) {
    const divisions = new Set();
    const salesGroups = new Set();
    const businessCodes = new Set();
    const salesReps = new Set();
    const statuses = new Set();
    const territories = new Set();
    let minDate = null;
    let maxDate = null;

    normalized.forEach(entry => {
        if (entry.division) {
            divisions.add(entry.division);
        }
        if (entry.salesGroupDisplay) {
            salesGroups.add(entry.salesGroupDisplay);
        }
        if (entry.businessCode) {
            businessCodes.add(entry.businessCode);
        }
        if (entry.salesRep) {
            salesReps.add(entry.salesRep);
        }
        if (entry.status) {
            statuses.add(entry.status);
        }
        if (entry.salesTerritory) {
            territories.add(entry.salesTerritory);
        }
        if (entry.lastOrderDate instanceof Date && !Number.isNaN(entry.lastOrderDate.getTime())) {
            if (!minDate || entry.lastOrderDate < minDate) {
                minDate = entry.lastOrderDate;
            }
            if (!maxDate || entry.lastOrderDate > maxDate) {
                maxDate = entry.lastOrderDate;
            }
        }
    });

    return {
        divisions: Array.from(divisions).sort(),
        salesGroups: Array.from(salesGroups).sort(),
        businessCodes: Array.from(businessCodes).sort(),
        salesReps: Array.from(salesReps).sort(),
        statuses: Array.from(statuses).sort(),
        territories: Array.from(territories).sort(),
        dateInfo: {
            minDate,
            maxDate
        }
    };
}

function summarizeCustomerData(normalized = []) {
    if (!Array.isArray(normalized) || normalized.length === 0) {
        return {
            totalRows: 0,
            uniqueCustomers: 0,
            ordersTotal: 0,
            avgOrdersPerCustomer: 0,
            customersWithOrders: 0,
            zeroOrderCustomers: 0,
            dormantCustomers: 0,
            statusBreakdown: [],
            salesRepRanking: [],
            territoryRanking: [],
            divisionRanking: [],
            groupRanking: [],
            recentActivity: [],
            topCustomersByOrders: [],
            dateRangeLabel: 'No order history',
            minDate: null,
            maxDate: null
        };
    }

    const uniqueCustomers = new Map();
    const statusMap = new Map();
    const salesRepMap = new Map();
    const territoryMap = new Map();
    const divisionMap = new Map();
    const groupMap = new Map();
    let ordersTotal = 0;
    let minDate = null;
    let maxDate = null;

    normalized.forEach(entry => {
        const customerKey = entry.customerKey || `row-${entry.rowIndex}`;
        if (!uniqueCustomers.has(customerKey)) {
            uniqueCustomers.set(customerKey, {
                id: entry.customerId,
                name: entry.customerLabel,
                orders: 0,
                reps: new Set(),
                statuses: new Set(),
                territories: new Set(),
                division: entry.division,
                salesGroup: entry.salesGroupDisplay,
                lastOrderDate: entry.lastOrderDate instanceof Date && !Number.isNaN(entry.lastOrderDate.getTime())
                    ? entry.lastOrderDate
                    : null,
                firstOrderDate: entry.lastOrderDate instanceof Date && !Number.isNaN(entry.lastOrderDate.getTime())
                    ? entry.lastOrderDate
                    : null,
                previousOrderDate: null,
                orderDates: new Set()
            });
        }

        const customerRecord = uniqueCustomers.get(customerKey);
        customerRecord.reps.add(entry.salesRep);
        if (entry.status) {
            customerRecord.statuses.add(entry.status);
        }
        if (entry.salesTerritory) {
            customerRecord.territories.add(entry.salesTerritory);
        }
        if (entry.lastOrderDate instanceof Date && !Number.isNaN(entry.lastOrderDate.getTime())) {
            if (!customerRecord.firstOrderDate || entry.lastOrderDate < customerRecord.firstOrderDate) {
                customerRecord.firstOrderDate = entry.lastOrderDate;
            }
            if (!customerRecord.lastOrderDate || entry.lastOrderDate > customerRecord.lastOrderDate) {
                customerRecord.previousOrderDate = customerRecord.lastOrderDate;
                customerRecord.lastOrderDate = entry.lastOrderDate;
            } else if (!customerRecord.previousOrderDate || entry.lastOrderDate > customerRecord.previousOrderDate) {
                customerRecord.previousOrderDate = entry.lastOrderDate;
            }
            customerRecord.orderDates.add(entry.lastOrderDate.toISOString().slice(0, 10));
        }

        const orders = Number.isFinite(entry.orderCount) ? entry.orderCount : 0;
        if (orders > 0) {
            customerRecord.orders += orders;
        }
        ordersTotal += orders;

        const statusKey = entry.status || 'Unspecified';
        statusMap.set(statusKey, (statusMap.get(statusKey) || 0) + 1);

        const repKey = entry.salesRep || 'Unassigned';
        if (!salesRepMap.has(repKey)) {
            salesRepMap.set(repKey, {
                name: repKey,
                customers: new Set(),
                orders: 0,
                statuses: new Map(),
                territories: new Set()
            });
        }
        const repStats = salesRepMap.get(repKey);
        repStats.customers.add(customerKey);
        if (orders > 0) {
            repStats.orders += orders;
        }
        repStats.territories.add(entry.salesTerritory || 'Unassigned');
        repStats.statuses.set(statusKey, (repStats.statuses.get(statusKey) || 0) + 1);

        const territoryKey = entry.salesTerritory || 'Unassigned';
        if (!territoryMap.has(territoryKey)) {
            territoryMap.set(territoryKey, {
                name: territoryKey,
                customers: new Set(),
                orders: 0
            });
        }
        const territoryStats = territoryMap.get(territoryKey);
        territoryStats.customers.add(customerKey);
        if (orders > 0) {
            territoryStats.orders += orders;
        }

        const divisionKey = entry.division || 'Unassigned';
        if (!divisionMap.has(divisionKey)) {
            divisionMap.set(divisionKey, {
                name: divisionKey,
                customers: new Set(),
                orders: 0
            });
        }
        const divisionStats = divisionMap.get(divisionKey);
        divisionStats.customers.add(customerKey);
        if (orders > 0) {
            divisionStats.orders += orders;
        }

        const groupKey = entry.salesGroupDisplay || 'Unassigned';
        if (!groupMap.has(groupKey)) {
            groupMap.set(groupKey, {
                name: groupKey,
                customers: new Set(),
                orders: 0
            });
        }
        const groupStats = groupMap.get(groupKey);
        groupStats.customers.add(customerKey);
        if (orders > 0) {
            groupStats.orders += orders;
        }

        if (entry.lastOrderDate instanceof Date && !Number.isNaN(entry.lastOrderDate.getTime())) {
            if (!minDate || entry.lastOrderDate < minDate) {
                minDate = entry.lastOrderDate;
            }
            if (!maxDate || entry.lastOrderDate > maxDate) {
                maxDate = entry.lastOrderDate;
            }
        }
    });

    const uniqueCustomerRecords = Array.from(uniqueCustomers.values());
    const uniqueCustomersCount = uniqueCustomers.size;
    const customersWithOrders = uniqueCustomerRecords.filter(record => record.orders > 0).length;
    const zeroOrderCustomers = uniqueCustomersCount - customersWithOrders;

    const ninetyDaysAgo = new Date(Date.now() - 90 * DAY_IN_MS);
    const dormantCustomers = uniqueCustomerRecords.filter(record => !record.lastOrderDate || record.lastOrderDate < ninetyDaysAgo).length;

    const referenceDate = maxDate || new Date();
    const thirtyDaysAgo = new Date(referenceDate.getTime() - 29 * DAY_IN_MS);
    const twelveMonthsAgo = new Date(referenceDate.getTime() - 365 * DAY_IN_MS);

    let activeCustomers30 = 0;
    let newCustomers30 = 0;
    let reactivatedCustomers30 = 0;
    let existingCustomers12 = 0;
    let lostCustomers12 = 0;
    let gapCustomers30To365 = 0;

    const newCustomersDetail = [];
    const reactivatedCustomersDetail = [];
    const atRiskCustomersDetail = [];
    const lostCustomersDetail = [];

    uniqueCustomerRecords.forEach(record => {
        const dates = Array.from(record.orderDates || [])
            .map(dateStr => {
                const parsed = new Date(dateStr);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
            })
            .filter(Boolean)
            .sort((a, b) => a - b);

        const last = record.lastOrderDate instanceof Date && !Number.isNaN(record.lastOrderDate.getTime())
            ? record.lastOrderDate
            : null;
        const hasOrders = record.orders > 0 && dates.length > 0;
        const hasHistoricalBefore30 = dates.some(date => date < thirtyDaysAgo);
        const hasHistoricalBefore12 = dates.some(date => date < twelveMonthsAgo);
        const hasRecentBefore12 = dates.some(date => date >= twelveMonthsAgo && (!last || date < last));

        const isActive = hasOrders && last && last >= thirtyDaysAgo;
        if (isActive) {
            activeCustomers30 += 1;
        }

        const isNew = isActive && !hasHistoricalBefore30;
        if (isNew) {
            newCustomers30 += 1;
            newCustomersDetail.push({
                name: record.name,
                rep: Array.from(record.reps)[0] || 'Unassigned',
                lastOrderDate: last,
                daysSince: last ? Math.round((referenceDate - last) / DAY_IN_MS) : null
            });
        }

        const isLost = !hasOrders || !last || last < twelveMonthsAgo;
        if (isLost) {
            lostCustomers12 += 1;
            lostCustomersDetail.push({
                name: record.name,
                rep: Array.from(record.reps)[0] || 'Unassigned',
                lastOrderDate: last,
                daysSince: last ? Math.round((referenceDate - last) / DAY_IN_MS) : null
            });
        }

        const hadLongGap = hasHistoricalBefore12 && !hasRecentBefore12;
        const isReactivated = isActive && hadLongGap;
        if (isReactivated) {
            reactivatedCustomers30 += 1;
            reactivatedCustomersDetail.push({
                name: record.name,
                rep: Array.from(record.reps)[0] || 'Unassigned',
                lastOrderDate: last,
                daysSince: last ? Math.round((referenceDate - last) / DAY_IN_MS) : null
            });
        }

        const isExisting = hasOrders && !isNew && !isReactivated && !isLost;
        if (isExisting) {
            existingCustomers12 += 1;
        }

        if (!isLost && !isActive && last && last < thirtyDaysAgo) {
            gapCustomers30To365 += 1;
            atRiskCustomersDetail.push({
                name: record.name,
                rep: Array.from(record.reps)[0] || 'Unassigned',
                lastOrderDate: last,
                daysSince: Math.round((referenceDate - last) / DAY_IN_MS)
            });
        }
    });

    const customerBalance = (existingCustomers12 + newCustomers30 + reactivatedCustomers30) - lostCustomers12;

    const sortByDaysDesc = (arr) => arr.sort((a, b) => (b.daysSince || 0) - (a.daysSince || 0));
    const sortByRecent = (arr) => arr.sort((a, b) => {
        const aTime = a.lastOrderDate ? a.lastOrderDate.getTime() : 0;
        const bTime = b.lastOrderDate ? b.lastOrderDate.getTime() : 0;
        return bTime - aTime;
    });

    sortByRecent(newCustomersDetail);
    sortByRecent(reactivatedCustomersDetail);
    sortByDaysDesc(atRiskCustomersDetail);
    sortByDaysDesc(lostCustomersDetail);

    const statusBreakdown = Array.from(statusMap.entries())
        .map(([status, count]) => ({
            status,
            count,
            share: uniqueCustomersCount ? (count / uniqueCustomersCount) * 100 : 0
        }))
        .sort((a, b) => b.count - a.count);

    const salesRepRanking = Array.from(salesRepMap.values())
        .map(rep => ({
            name: rep.name,
            customers: rep.customers.size,
            orders: rep.orders,
            topStatus: Array.from(rep.statuses.entries()).sort((a, b) => b[1] - a[1])[0]?.[0] || null,
            territories: Array.from(rep.territories).filter(Boolean)
        }))
        .sort((a, b) => b.customers - a.customers || b.orders - a.orders);

    const territoryRanking = Array.from(territoryMap.values())
        .map(item => ({
            name: item.name,
            customers: item.customers.size,
            orders: item.orders
        }))
        .sort((a, b) => b.customers - a.customers || b.orders - a.orders);

    const divisionRanking = Array.from(divisionMap.values())
        .map(item => ({
            name: item.name,
            customers: item.customers.size,
            orders: item.orders
        }))
        .sort((a, b) => b.customers - a.customers || b.orders - a.orders);

    const groupRanking = Array.from(groupMap.values())
        .map(item => ({
            name: item.name,
            customers: item.customers.size,
            orders: item.orders
        }))
        .sort((a, b) => b.customers - a.customers || b.orders - a.orders);

    const recentActivity = uniqueCustomerRecords
        .filter(record => record.lastOrderDate instanceof Date && !Number.isNaN(record.lastOrderDate.getTime()))
        .sort((a, b) => b.lastOrderDate - a.lastOrderDate)
        .slice(0, 5)
        .map(record => ({
            name: record.name,
            rep: Array.from(record.reps)[0] || 'Unassigned',
            date: record.lastOrderDate
        }));

    const topCustomersByOrders = uniqueCustomerRecords
        .filter(record => record.orders > 0)
        .sort((a, b) => b.orders - a.orders)
        .slice(0, 5);

    const dateRangeLabel = minDate && maxDate
        ? `${formatSalesDateLabel(minDate, { mode: 'human' })} â†’ ${formatSalesDateLabel(maxDate, { mode: 'human' })}`
        : 'No order history';

    return {
        totalRows: normalized.length,
        uniqueCustomers: uniqueCustomersCount,
        ordersTotal,
        avgOrdersPerCustomer: uniqueCustomersCount ? ordersTotal / uniqueCustomersCount : 0,
        customersWithOrders,
        zeroOrderCustomers,
        dormantCustomers,
        activeCustomers30,
        newCustomers30,
        reactivatedCustomers30,
        existingCustomers12,
        lostCustomers12,
        gapCustomers30To365,
        customerBalance,
        newCustomersDetail,
        reactivatedCustomersDetail,
        atRiskCustomersDetail,
        lostCustomersDetail,
        statusBreakdown,
        salesRepRanking,
        territoryRanking,
        divisionRanking,
        groupRanking,
        recentActivity,
        topCustomersByOrders,
        dateRangeLabel,
        minDate,
        maxDate
    };
}

function generateCustomerInsights(summary) {
    if (!summary || !summary.totalRows) {
        return [];
    }

    const insights = [];
    insights.push({
        title: 'Engagement Pulse',
        description: `${summary.activeCustomers30.toLocaleString('en-ZA')} customers purchased in the last 30 days while ${summary.gapCustomers30To365.toLocaleString('en-ZA')} are drifting (30â€“365 days since purchase).`
    });

    if (summary.newCustomers30 > 0) {
        insights.push({
            title: 'New Logos',
            description: `${summary.newCustomers30.toLocaleString('en-ZA')} brand-new customers landed in the last month.`
        });
    }

    if (summary.reactivatedCustomers30 > 0) {
        insights.push({
            title: 'Reactivated Accounts',
            description: `${summary.reactivatedCustomers30.toLocaleString('en-ZA')} dormant customers returned after 12+ months away. Double down on their journey.`
        });
    }

    if (summary.lostCustomers12 > 0) {
        insights.push({
            title: 'Lost Customers',
            description: `${summary.lostCustomers12.toLocaleString('en-ZA')} customers show no orders in the past year. Build a win-back list.`
        });
    }

    const balanceLabel = summary.customerBalance > 0
        ? `+${summary.customerBalance.toLocaleString('en-ZA')}`
        : summary.customerBalance.toLocaleString('en-ZA');
    insights.push({
        title: 'Net Balance',
        description: `Net customer balance sits at ${balanceLabel} (existing + new + reactivated minus lost).`
    });

    return insights.slice(0, 4);
}

function formatCustomerDate(date) {
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
        return '-';
    }
    return formatSalesDateLabel(date, { mode: 'human' });
}

function renderCustomerSummary(summary, options = {}) {
    if (!summary || !summary.totalRows) {
        return '<p style="margin:0;color:#6b7280;font-size:13px">No customer data available yet.</p>';
    }

    const badges = Array.isArray(options.filterBadges) && options.filterBadges.length > 0
        ? `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">${options.filterBadges.map(label => `<span style="background:#e0f2fe;color:#0369a1;padding:4px 8px;border-radius:999px;font-size:12px">${escapeHtml(label)}</span>`).join('')}</div>`
        : '';

    const contextLabel = options.contextLabel
        ? `<div style="margin-bottom:12px;color:#2563eb;font-size:13px;font-weight:600">${escapeHtml(options.contextLabel)} view</div>`
        : '';

    const balanceValue = summary.customerBalance;
    const balanceDisplay = balanceValue > 0
        ? `+${balanceValue.toLocaleString('en-ZA')}`
        : balanceValue.toLocaleString('en-ZA');

    const metricDefinitions = [
        { key: 'activeCustomers30', label: 'Active (30 days)', value: summary.activeCustomers30.toLocaleString('en-ZA'), accent: '#16a34a' },
        { key: 'newCustomers30', label: 'New customers (30 days)', value: summary.newCustomers30.toLocaleString('en-ZA'), accent: '#2563eb' },
        { key: 'reactivatedCustomers30', label: 'Reactivated (30 days)', value: summary.reactivatedCustomers30.toLocaleString('en-ZA'), accent: '#7c3aed' },
        { key: 'existingCustomers12', label: 'Existing (12 months)', value: summary.existingCustomers12.toLocaleString('en-ZA'), accent: '#0f172a' },
        { key: 'gapCustomers30To365', label: 'At risk (30-365 days)', value: summary.gapCustomers30To365.toLocaleString('en-ZA'), accent: '#f97316' },
        { key: 'lostCustomers12', label: 'Lost (>12 months)', value: summary.lostCustomers12.toLocaleString('en-ZA'), accent: '#dc2626' },
        { key: 'customerBalance', label: 'Customer balance', value: balanceDisplay, accent: balanceValue >= 0 ? '#0ea5e9' : '#b91c1c' }
    ];

    const metricCards = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:16px">
            ${metricDefinitions.map(metric => `
                <div data-drilldown-action="customer-metric" data-metric-key="${metric.key}" data-metric-label="${escapeHtml(metric.label)}" role="button" tabindex="0" style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(15,23,42,0.08);cursor:pointer;outline:none">
                    <div style="font-size:12px;color:#6b7280;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em">${metric.label}</div>
                    <div style="font-size:${metric.isText ? '14px' : '26px'};font-weight:700;color:${metric.accent}">${metric.value}</div>
                </div>
            `).join('')}
        </div>
    `;

    const recentActivity = summary.recentActivity.length > 0
        ? summary.recentActivity.map(item => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f3f4f6">
                <div>
                    <div style="font-weight:600;color:#1f2937;font-size:14px">${escapeHtml(item.name)}</div>
                    <div style="font-size:12px;color:#6b7280">Managed by ${escapeHtml(item.rep)}</div>
                </div>
                <div style="font-size:12px;color:#2563eb">${formatCustomerDate(item.date)}</div>
            </div>
        `).join('')
        : '<p style="margin:0;color:#6b7280;font-size:13px">No recent order activity captured.</p>';
    const buildCustomerList = (items, emptyText) => {
        if (!Array.isArray(items) || items.length === 0) {
            return `<p style="margin:0;color:#6b7280;font-size:13px">${escapeHtml(emptyText)}</p>`;
        }
        return items.slice(0, 5).map((customer, index) => {
            const repLabel = customer.rep ? escapeHtml(customer.rep) : 'Unassigned';
            const dateLabel = customer.lastOrderDate ? escapeHtml(formatCustomerDate(customer.lastOrderDate)) : 'No orders yet';
            const daysLabel = Number.isFinite(customer.daysSince)
                ? `${customer.daysSince} day${customer.daysSince === 1 ? '' : 's'} ago`
                : (customer.lastOrderDate ? 'No purchase history' : 'No orders recorded');
            const background = index === 0 ? '#eef2ff' : '#f9fafb';
            return `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:${background};border:1px solid #e5e7eb;margin-bottom:8px">
                    <div>
                        <div style="font-weight:600;color:#1f2937;font-size:14px">${escapeHtml(customer.name)}</div>
                        <div style="font-size:12px;color:#6b7280">${repLabel}</div>
                    </div>
                    <div style="text-align:right;font-size:12px;color:#2563eb;min-width:120px">
                        <div>${dateLabel}</div>
                        <div style="color:#6b7280">${escapeHtml(daysLabel)}</div>
                    </div>
                </div>`;
        }).join('');
    };

    const newCustomers = buildCustomerList(summary.newCustomersDetail, 'No new customers in the last 30 days.');
    const reactivatedCustomers = buildCustomerList(summary.reactivatedCustomersDetail, 'No reactivated customers yet.');
    const atRiskCustomers = buildCustomerList(summary.atRiskCustomersDetail, 'No customers in the 30-365 day gap.');
    const lostCustomers = buildCustomerList(summary.lostCustomersDetail, 'No customers have been lost yet.');

    return `
        ${contextLabel}
        ${badges}
        ${metricCards}
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px">
            <div data-drilldown-action="customer-new" role="button" tabindex="0" style="background:white;border-radius:12px;border:1px solid #e5e7eb;padding:16px;box-shadow:0 2px 8px rgba(15,23,42,0.06);cursor:pointer;outline:none">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px;font-weight:600">New Customers (30 days)</h4>
                ${newCustomers}
            </div>
            <div data-drilldown-action="customer-reactivated" role="button" tabindex="0" style="background:white;border-radius:12px;border:1px solid #e5e7eb;padding:16px;box-shadow:0 2px 8px rgba(15,23,42,0.06);cursor:pointer;outline:none">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px;font-weight:600">Reactivated Customers</h4>
                ${reactivatedCustomers}
            </div>
            <div data-drilldown-action="customer-at-risk" role="button" tabindex="0" style="background:white;border-radius:12px;border:1px solid #e5e7eb;padding:16px;box-shadow:0 2px 8px rgba(15,23,42,0.06);cursor:pointer;outline:none">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px;font-weight:600">At-Risk Customers (30-365 days)</h4>
                ${atRiskCustomers}
            </div>
            <div data-drilldown-action="customer-lost" role="button" tabindex="0" style="background:white;border-radius:12px;border:1px solid #e5e7eb;padding:16px;box-shadow:0 2px 8px rgba(15,23,42,0.06);cursor:pointer;outline:none">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px;font-weight:600">Lost Customers (>12 months)</h4>
                ${lostCustomers}
            </div>
            <div data-drilldown-action="customer-activity" role="button" tabindex="0" style="background:white;border-radius:12px;border:1px solid #e5e7eb;padding:16px;box-shadow:0 2px 8px rgba(15,23,42,0.06);cursor:pointer;outline:none">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px;font-weight:600">Recent Customer Activity</h4>
                ${recentActivity}
            </div>
        </div>
    `;
}

function renderCustomerInsights(insights = []) {
    if (!Array.isArray(insights) || insights.length === 0) {
        return '';
    }

    return `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px">
            ${insights.map((insight, index) => `
                <div data-drilldown-action="customer-insight" data-insight-index="${index}" role="button" tabindex="0" style="background:linear-gradient(135deg,#f8fafc,#ffffff);border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(15,23,42,0.04);cursor:pointer;outline:none">
                    <h4 style="margin:0 0 8px 0;color:#1f2937;font-size:15px;font-weight:600">${escapeHtml(insight.title)}</h4>
                    <p style="margin:0;color:#4b5563;font-size:13px;line-height:1.5">${escapeHtml(insight.description)}</p>
                </div>
            `).join('')}
        </div>
    `;
}

function wireCustomerDrilldowns(summaryContainer, insightsContainer, summary, dataset, options = {}, insights = []) {
    customerDrilldownState.summary = summary || null;
    customerDrilldownState.dataset = Array.isArray(dataset) ? dataset : [];
    customerDrilldownState.options = options && typeof options === 'object' ? options : {};
    customerDrilldownState.insights = Array.isArray(insights) ? insights : [];

    const containers = [];
    if (summaryContainer) containers.push(summaryContainer);
    if (insightsContainer) containers.push(insightsContainer);

    containers.forEach(container => {
        const nodes = container.querySelectorAll('[data-drilldown-action]');
        nodes.forEach(node => {
            if (node.getAttribute('data-drilldown-bound') === '1') {
                return;
            }
            node.setAttribute('data-drilldown-bound', '1');
            node.addEventListener('click', () => triggerCustomerDrilldown(node));
            node.addEventListener('keydown', event => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    triggerCustomerDrilldown(node);
                }
            });
        });
    });
}

function triggerCustomerDrilldown(element) {
    if (!element) {
        return;
    }
    const action = element.getAttribute('data-drilldown-action');
    if (!action) {
        return;
    }
    const detail = Object.assign({}, element.dataset);
    delete detail.drilldownAction;
    openCustomerDrilldown(action, detail);
}

function openCustomerDrilldown(action, detail = {}) {
    const view = buildCustomerDrilldownView(action, detail, customerDrilldownState);
    if (!view || !view.content) {
        return;
    }
    openDrilldownPanel({
        title: view.title || 'Customer Detail',
        content: view.content,
        maxWidth: view.maxWidth || 960
    });
}

function buildCustomerDrilldownView(action, detail, state) {
    if (!state || !state.summary) {
        return null;
    }
    switch (action) {
        case 'customer-metric':
            return buildCustomerMetricsOverview(state, detail);
        case 'customer-activity':
            return buildCustomerActivityDetails(state);
        case 'customer-new':
            return buildCustomerSegmentDetails(state, { segment: 'new' });
        case 'customer-reactivated':
            return buildCustomerSegmentDetails(state, { segment: 'reactivated' });
        case 'customer-at-risk':
            return buildCustomerSegmentDetails(state, { segment: 'at-risk' });
        case 'customer-lost':
            return buildCustomerSegmentDetails(state, { segment: 'lost' });
        case 'customer-status':
            return buildCustomerStatusDetails(state);
        case 'customer-status-chip':
            return buildCustomerStatusChipDetails(state, detail);
        case 'customer-reps':
            return buildCustomerRepsDetails(state);
        case 'customer-top-customers':
            return buildCustomerTopCustomersDetails(state);
        case 'customer-insight':
            return buildCustomerInsightDetails(state, detail);
        default:
            return buildCustomerMetricsOverview(state, detail);
    }
}

function buildCustomerMetricsOverview(state, detail = {}) {
    const summary = state.summary;
    if (!summary) {
        return null;
    }
    const highlightKey = detail.metricKey || null;
    const metricLabel = detail.metricLabel ? String(detail.metricLabel) : '';
    const viewLabel = state.options && typeof state.options.contextLabel === 'string'
        ? state.options.contextLabel
        : '';

    const rows = [
        { key: 'totalRows', label: 'Total normalized rows', value: summary.totalRows.toLocaleString('en-ZA'), note: 'Row count after customer data normalization.' },
        { key: 'uniqueCustomers', label: 'Unique customers', value: summary.uniqueCustomers.toLocaleString('en-ZA'), note: 'Distinct customer IDs or names detected.' },
        { key: 'activeCustomers30', label: 'Active customers (30 days)', value: summary.activeCustomers30.toLocaleString('en-ZA'), note: 'Orders captured in the last 30 days.' },
        { key: 'newCustomers30', label: 'New customers (30 days)', value: summary.newCustomers30.toLocaleString('en-ZA'), note: 'First-ever orders recorded in the last month.' },
        { key: 'reactivatedCustomers30', label: 'Reactivated customers', value: summary.reactivatedCustomers30.toLocaleString('en-ZA'), note: 'Customers returning after 12+ months away.' },
        { key: 'existingCustomers12', label: 'Existing customers (12 months)', value: summary.existingCustomers12.toLocaleString('en-ZA'), note: 'Customers with activity within the last year.' },
        { key: 'gapCustomers30To365', label: 'At risk (30-365 days)', value: summary.gapCustomers30To365.toLocaleString('en-ZA'), note: 'Customers drifting away with 30-365 days since last order.' },
        { key: 'lostCustomers12', label: 'Lost customers (>12 months)', value: summary.lostCustomers12.toLocaleString('en-ZA'), note: 'No purchases captured in the last 12 months.' },
        { key: 'dormantCustomers', label: 'Dormant (>90 days)', value: summary.dormantCustomers.toLocaleString('en-ZA'), note: 'Customers without orders in the last 90 days.' },
        { key: 'zeroOrderCustomers', label: 'No recorded orders', value: summary.zeroOrderCustomers.toLocaleString('en-ZA'), note: 'Customers present but without any order history.' },
        { key: 'ordersTotal', label: 'Total orders', value: summary.ordersTotal.toLocaleString('en-ZA'), note: 'Aggregated order volume from the dataset.' },
        { key: 'avgOrdersPerCustomer', label: 'Avg orders per customer', value: summary.avgOrdersPerCustomer.toFixed(1), note: 'Average order volume across the customer base.' },
        { key: 'customerBalance', label: 'Customer balance', value: summary.customerBalance.toLocaleString('en-ZA'), note: 'Existing + new + reactivated minus lost customers.' },
        { key: 'dateRange', label: 'Order date range', value: summary.dateRangeLabel, note: 'Span between earliest and latest order dates.' }
    ];

    const topStatus = summary.statusBreakdown && summary.statusBreakdown[0]
        ? `${summary.statusBreakdown[0].status} customers represent ${summary.statusBreakdown[0].share.toFixed(1)}% of the base.`
        : null;
    if (topStatus) {
        rows.push({
            key: 'topStatus',
            label: 'Dominant status',
            value: summary.statusBreakdown[0].status,
            note: topStatus
        });
    }

    const rowsHtml = rows.map(row => {
        const isHighlight = highlightKey && row.key === highlightKey;
        const valueText = row.value === null || row.value === undefined ? '-' : String(row.value);
        const noteText = row.note ? String(row.note) : '';
        const noteHtml = noteText
            ? `<div style="font-size:12px;color:#64748b;margin-top:4px">${escapeHtml(noteText)}</div>`
            : '';
        return `
            <tr style="background:${isHighlight ? '#dbeafe' : '#ffffff'}">
                <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(row.label)}</th>
                <td style="padding:10px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a;font-weight:600">${escapeHtml(valueText)}</td>
                <td style="padding:10px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${noteHtml}</td>
            </tr>`;
    }).join('');

    const contextSuffix = viewLabel ? ` (${escapeHtml(viewLabel)} view)` : '';
    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <p style="margin:0;color:#475569;font-size:13px">Customer KPI breakdown${contextSuffix}. Metrics reflect the filtered dataset.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:520px">
                    <tbody>${rowsHtml}</tbody>
                </table>
            </div>
        </div>`;

    const titleParts = metricLabel ? [`${metricLabel} Drill-down`] : ['Customer Metrics Overview'];
    if (viewLabel) {
        titleParts.push(`${viewLabel} view`);
    }

    return {
        title: titleParts.join(' Â· '),
        content,
        maxWidth: 900
    };
}

function buildCustomerSegmentDetails(state, options = {}) {
    const summary = state.summary;
    if (!summary) {
        return null;
    }

    const segment = options.segment || 'new';
    let items = [];
    let title = 'Customer Segment Â· Drill-down';
    let description = '';

    switch (segment) {
        case 'new':
            items = summary.newCustomersDetail || [];
            title = 'New Customers Â· Drill-down';
            description = 'Customers whose first recorded purchase is within the last 30 days.';
            break;
        case 'reactivated':
            items = summary.reactivatedCustomersDetail || [];
            title = 'Reactivated Customers Â· Drill-down';
            description = 'Dormant customers who returned after 12+ months away with a fresh order in the last 30 days.';
            break;
        case 'at-risk':
            items = summary.atRiskCustomersDetail || [];
            title = 'At-Risk Customers Â· Drill-down';
            description = 'Customers with 30â€“365 days since last purchase. Prioritise nudges before they lapse.';
            break;
        case 'lost':
            items = summary.lostCustomersDetail || [];
            title = 'Lost Customers Â· Drill-down';
            description = 'Customers with no purchase for 12+ months. Build win-back campaigns.';
            break;
        default:
            items = summary.newCustomersDetail || [];
            description = 'Customers recently activated in the dataset.';
            break;
    }

    const limited = items.slice(0, 100);
    if (limited.length === 0) {
        return {
            title,
            content: `<p style="margin:0;color:#6b7280;font-size:13px">No customers fall into this segment yet.</p>`,
            maxWidth: 640
        };
    }

    const rows = limited.map((customer, index) => {
        const repLabel = customer.rep ? escapeHtml(customer.rep) : 'Unassigned';
        const lastOrder = customer.lastOrderDate ? formatCustomerDate(customer.lastOrderDate) : 'No orders recorded';
        const daysLabel = Number.isFinite(customer.daysSince)
            ? `${customer.daysSince} day${customer.daysSince === 1 ? '' : 's'} ago`
            : (customer.lastOrderDate ? 'No purchase history' : 'No orders recorded');
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(customer.name)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${repLabel}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(lastOrder)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(daysLabel)}</td>
            </tr>`;
    }).join('');

    const overflowNote = items.length > limited.length
        ? `<p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px">Showing first ${limited.length} of ${items.length.toLocaleString('en-ZA')} customers. Refine filters to narrow the list.</p>`
        : '';

    const content = `
        <div style="display:flex;flex-direction:column;gap:12px">
            <p style="margin:0;color:#475569;font-size:13px">${escapeHtml(description)}</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:580px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Customer</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Owner</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Last order</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Days since</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            ${overflowNote}
        </div>`;

    return {
        title,
        content,
        maxWidth: 840
    };
}

function buildCustomerRepsDetails(state) {
    const summary = state.summary;
    if (!summary || !Array.isArray(summary.salesRepRanking)) {
        return null;
    }
    const rows = summary.salesRepRanking.slice(0, 20).map((rep, index) => {
        const territory = Array.isArray(rep.territories) && rep.territories.length > 0
            ? rep.territories.map(escapeHtml).join(', ')
            : 'â€”';
        const topStatus = rep.topStatus ? escapeHtml(rep.topStatus) : 'â€”';
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(rep.name)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${rep.customers.toLocaleString('en-ZA')}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${rep.orders.toLocaleString('en-ZA')}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${topStatus}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${territory}</td>
            </tr>`;
    }).join('') || '<tr><td colspan="6" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No sales representative allocations available.</td></tr>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <p style="margin:0;color:#475569;font-size:13px">Ranking of the busiest sales representatives by customers and orders managed.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:640px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Sales Rep</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Customers</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Orders</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Top status</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Territories</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;

    return {
        title: 'Top Sales Reps Â· Drill-down',
        content,
        maxWidth: 960
    };
}

function buildCustomerStatusDetails(state) {
    const summary = state.summary;
    if (!summary || !Array.isArray(summary.statusBreakdown)) {
        return null;
    }
    const rows = summary.statusBreakdown.map(item => `
        <tr>
            <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(item.status)}</td>
            <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${item.count.toLocaleString('en-ZA')}</td>
            <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${item.share.toFixed(1)}%</td>
        </tr>`).join('') || '<tr><td colspan="3" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No customer status information available.</td></tr>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <p style="margin:0;color:#475569;font-size:13px">Distribution of customers across captured lifecycle statuses.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:420px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Status</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Customers</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Share</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;

    return {
        title: 'Status Breakdown Â· Drill-down',
        content,
        maxWidth: 720
    };
}

function buildCustomerStatusChipDetails(state, detail = {}) {
    const summary = state.summary;
    const dataset = state.dataset;
    const status = detail && detail.status ? String(detail.status) : '';
    if (!summary || !Array.isArray(dataset) || !status) {
        return null;
    }

    const filtered = dataset.filter(entry => (entry.status || 'Unspecified') === status);
    const limited = filtered.slice(0, 50);
    const rows = limited.map((entry, index) => {
        const orderCount = Number.isFinite(entry.orderCount) ? entry.orderCount : 0;
        const lastOrderRaw = formatCustomerDate(entry.lastOrderDate) || (entry.period ? String(entry.period) : '-');
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(entry.customerLabel)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.salesRep || 'Unassigned')}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.division || 'Unassigned')}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${orderCount.toLocaleString('en-ZA')}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(lastOrderRaw || '-')}</td>
            </tr>`;
    }).join('') || '<tr><td colspan="6" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No customers captured with this status.</td></tr>';

    const overflowNote = filtered.length > limited.length
        ? `<p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px">Showing first ${limited.length} of ${filtered.length.toLocaleString('en-ZA')} customers with status "${escapeHtml(status)}". Refine filters to narrow the list.</p>`
        : '';

    const content = `
        <div style="display:flex;flex-direction:column;gap:12px">
            <p style="margin:0;color:#475569;font-size:13px">Customers currently flagged as "${escapeHtml(status)}".</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:700px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Customer</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Sales Rep</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Division</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Orders</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Last order</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            ${overflowNote}
        </div>`;

    return {
        title: `Status Â· ${status}`,
        content,
        maxWidth: 980
    };
}

function buildCustomerActivityDetails(state) {
    const summary = state.summary;
    if (!summary || !Array.isArray(summary.recentActivity)) {
        return null;
    }
    const rows = summary.recentActivity.map(entry => {
        const dateLabel = formatCustomerDate(entry.date) || '-';
        return `
            <tr>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(entry.name)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.rep)}</td>
                <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${escapeHtml(dateLabel)}</td>
            </tr>`;
    }).join('') || '<tr><td colspan="3" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No recent customer activity recorded.</td></tr>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:12px">
            <p style="margin:0;color:#475569;font-size:13px">Most recent customer touches based on the last order date captured.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:520px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Customer</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Sales Rep</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Last activity</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;

    return {
        title: 'Recent Customer Activity Â· Drill-down',
        content,
        maxWidth: 800
    };
}

function buildCustomerTopCustomersDetails(state) {
    const summary = state.summary;
    if (!summary || !Array.isArray(summary.topCustomersByOrders)) {
        return null;
    }
    const rows = summary.topCustomersByOrders.map((customer, index) => `
        <tr>
            <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#6b7280">${index + 1}</td>
            <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#0f172a">${escapeHtml(customer.name)}</td>
            <td style="padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569;text-align:right">${customer.orders.toLocaleString('en-ZA')}</td>
        </tr>`).join('') || '<tr><td colspan="3" style="padding:12px;color:#6b7280;text-align:center;font-size:13px">No order history recorded for customers.</td></tr>';

    const content = `
        <div style="display:flex;flex-direction:column;gap:12px">
            <p style="margin:0;color:#475569;font-size:13px">Customers sorted by order volume in the uploaded dataset.</p>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:420px">
                    <thead>
                        <tr style="background:#f1f5f9">
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">#</th>
                            <th style="padding:8px 12px;text-align:left;font-size:12px;color:#475569">Customer</th>
                            <th style="padding:8px 12px;text-align:right;font-size:12px;color:#475569">Orders</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;

    return {
        title: 'Top Customers Â· Drill-down',
        content,
        maxWidth: 720
    };
}

function buildCustomerInsightDetails(state, detail = {}) {
    const insights = state.insights || [];
    const index = detail && detail.insightIndex !== undefined
        ? parseInt(detail.insightIndex, 10)
        : -1;
    const insight = Number.isInteger(index) && index >= 0 && index < insights.length ? insights[index] : null;
    if (!insight) {
        return null;
    }

    const summary = state.summary;
    const contextLines = [];
    if (summary) {
        contextLines.push(`Total customers: ${summary.uniqueCustomers.toLocaleString('en-ZA')}`);
        contextLines.push(`Orders captured: ${summary.ordersTotal.toLocaleString('en-ZA')}`);
        contextLines.push(`Dormant accounts: ${summary.dormantCustomers.toLocaleString('en-ZA')}`);
    }

    const content = `
        <div style="display:flex;flex-direction:column;gap:16px">
            <div>
                <h4 style="margin:0 0 8px 0;color:#0f172a;font-size:16px;font-weight:700">${escapeHtml(insight.title)}</h4>
                <p style="margin:0;color:#475569;font-size:13px;line-height:1.5">${escapeHtml(insight.description)}</p>
            </div>
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px">
                <div style="font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Dataset context</div>
                <ul style="margin:0;padding-left:18px;color:#475569;font-size:13px">
                    ${contextLines.map(line => `<li>${escapeHtml(line)}</li>`).join('')}
                </ul>
            </div>
        </div>`;

    return {
        title: `${insight.title} Â· Insight`,
        content,
        maxWidth: 720
    };
}

function resetCustomerTableState(data = []) {
    const dataArray = Array.isArray(data) ? data : [];
    customerTableState.currentData = dataArray;
    customerTableState.totalRows = dataArray.length;
    customerTableState.visibleRows = dataArray.length > 0
        ? Math.min(CUSTOMER_TABLE_DEFAULT_ROWS, dataArray.length)
        : CUSTOMER_TABLE_DEFAULT_ROWS;
}

function renderCustomerTable(data = []) {
    const headerEl = document.getElementById('customerTableHeader');
    const bodyEl = document.getElementById('customerTableBody');
    const countEl = document.getElementById('customerTableCount');
    const loadMoreBtn = document.getElementById('customerTableLoadMore');

    if (!headerEl || !bodyEl) {
        return;
    }

    if (!Array.isArray(data) || data.length === 0) {
        headerEl.innerHTML = '';
        bodyEl.innerHTML = '';
        if (countEl) {
            countEl.textContent = '';
        }
        if (loadMoreBtn) {
            loadMoreBtn.style.display = 'none';
        }
        return;
    }

    customerTableState.currentData = data;
    customerTableState.totalRows = data.length;
    customerTableState.visibleRows = Math.min(customerTableState.visibleRows, customerTableState.totalRows);

    headerEl.innerHTML = `
        <tr style="background:#f1f5f9">
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Customer ID</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Customer Name</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Status</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Sales Rep</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Territory</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Division</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Sales Group</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Business Code</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:right;font-size:12px;color:#475569;text-transform:uppercase">Orders</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Last Order</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Email</th>
            <th style="padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:12px;color:#475569;text-transform:uppercase">Phone</th>
        </tr>
    `;

    const rows = data.slice(0, customerTableState.visibleRows).map((entry, index) => `
        <tr style="background:${index % 2 === 0 ? '#ffffff' : '#f8fafc'}">
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#1f2937">${escapeHtml(entry.customerId || '-')}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:13px;color:#1f2937;font-weight:600">${escapeHtml(entry.customerLabel)}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#2563eb">${escapeHtml(entry.status)}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#334155">${escapeHtml(entry.salesRep)}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.salesTerritory || '-')}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.division || '-')}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.salesGroupDisplay || '-')}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.businessCode || '-')}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#1f2937;text-align:right;font-weight:600">${Number.isFinite(entry.orderCount) ? entry.orderCount.toLocaleString('en-ZA') : '0'}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${formatCustomerDate(entry.lastOrderDate)}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.email || '-')}</td>
            <td style="padding:10px;border-bottom:1px solid #e2e8f0;font-size:12px;color:#475569">${escapeHtml(entry.phone || '-')}</td>
        </tr>
    `).join('');

    bodyEl.innerHTML = rows;

    if (countEl) {
        const showing = Math.min(customerTableState.visibleRows, customerTableState.totalRows);
        countEl.textContent = `Showing ${showing.toLocaleString('en-ZA')} of ${customerTableState.totalRows.toLocaleString('en-ZA')} customer rows`;
    }

    if (loadMoreBtn) {
        loadMoreBtn.style.display = customerTableState.visibleRows < customerTableState.totalRows ? 'inline-flex' : 'none';
    }
}

function loadMoreCustomerRows() {
    if (!Array.isArray(customerTableState.currentData) || customerTableState.currentData.length === 0) {
        return;
    }
    if (customerTableState.visibleRows >= customerTableState.totalRows) {
        return;
    }
    customerTableState.visibleRows = Math.min(
        customerTableState.totalRows,
        customerTableState.visibleRows + CUSTOMER_TABLE_INCREMENT
    );
    renderCustomerTable(customerTableState.currentData);
}

function calculateSalesForecast(normalized = [], summary = null) {
    if (!Array.isArray(normalized) || normalized.length === 0) {
        return {
            forecast30: 0,
            forecast90: 0,
            avgDaily: 0,
            basisDays: 0,
            momentumFactor: 1,
            confidence: 'Low'
        };
    }

    const dateInfo = summary && summary.dateInfo ? summary.dateInfo : getSalesDateInfo(normalized);
    const monthlyTotals = new Map();
    let totalTurnover = 0;
    normalized.forEach(entry => {
        const entryDate = entry.date instanceof Date && !Number.isNaN(entry.date.getTime()) ? entry.date : null;
        const turnover = Number.isFinite(entry.turnover) ? entry.turnover : 0;
        if (!entryDate) {
            return;
        }
        totalTurnover += turnover;
        const monthKey = `${entryDate.getFullYear()}-${String(entryDate.getMonth() + 1).padStart(2, '0')}`;
        monthlyTotals.set(monthKey, (monthlyTotals.get(monthKey) || 0) + turnover);
    });

    if (monthlyTotals.size === 0) {
        return {
            forecast30: 0,
            forecast90: 0,
            avgDaily: 0,
            basisDays: 0,
            momentumFactor: 1,
            confidence: 'Low'
        };
    }

    const orderedMonths = Array.from(monthlyTotals.entries())
        .map(([key, value]) => ({ key, value }))
        .sort((a, b) => a.key.localeCompare(b.key));

    const coverageMonths = orderedMonths.length;
    const avgMonthly = coverageMonths ? totalTurnover / coverageMonths : 0;
    const avgDaily = avgMonthly / 30;

    let momentumFactor = 1;
    if (orderedMonths.length >= 2) {
        const latest = orderedMonths[orderedMonths.length - 1].value;
        const prior = orderedMonths[orderedMonths.length - 2].value;
        if (prior > 0) {
            const delta = (latest - prior) / prior;
            momentumFactor = 1 + Math.max(-0.3, Math.min(0.3, delta));
        }
    }
    if (!Number.isFinite(momentumFactor) || momentumFactor <= 0) {
        momentumFactor = 1;
    }

    const forecast30 = avgMonthly * momentumFactor;
    const forecast90 = avgMonthly * 3 * momentumFactor;
    const basisDays = coverageMonths * 30;
    const confidence = coverageMonths >= 6 ? 'High' : coverageMonths >= 3 ? 'Medium' : 'Low';

    return {
        forecast30,
        forecast90,
        avgDaily,
        basisDays,
        momentumFactor,
        confidence
    };
}

function calculateDealVelocity(normalized = [], summary = null) {
    if (!Array.isArray(normalized) || normalized.length === 0) {
        return {
            dealsPerWeek: 0,
            avgCycleDays: 0,
            firstToQuote: 0,
            quoteToClose: 0,
            sampleSize: 0,
            coverageDays: 0
        };
    }

    const dateInfo = summary && summary.dateInfo ? summary.dateInfo : getSalesDateInfo(normalized);
    const minDate = dateInfo && dateInfo.minDate instanceof Date && !Number.isNaN(dateInfo.minDate.getTime())
        ? dateInfo.minDate
        : null;
    const maxDate = dateInfo && dateInfo.maxDate instanceof Date && !Number.isNaN(dateInfo.maxDate.getTime())
        ? dateInfo.maxDate
        : null;

    const spanDays = minDate && maxDate ? Math.max(1, Math.round((maxDate - minDate) / DAY_IN_MS) + 1) : Math.max(1, normalized.length);
    const weeksSpan = spanDays / 7;
    const dealsPerWeek = weeksSpan > 0 ? normalized.length / weeksSpan : normalized.length;

    const customerMap = new Map();
    normalized.forEach(entry => {
        if (!(entry.date instanceof Date) || Number.isNaN(entry.date.getTime())) {
            return;
        }
        const key = entry.customer ? `cust:${entry.customer}` : `row:${entry.rowIndex}`;
        if (!customerMap.has(key)) {
            customerMap.set(key, []);
        }
        customerMap.get(key).push(entry.date);
    });

    let cycleTotal = 0;
    let stageFirstToQuote = 0;
    let stageQuoteToClose = 0;
    let sampleCount = 0;

    customerMap.forEach(dates => {
        if (!Array.isArray(dates) || dates.length === 0) {
            return;
        }
        dates.sort((a, b) => a - b);
        const first = dates[0];
        const last = dates[dates.length - 1];
        let cycleDays = Math.max(1, Math.round((last - first) / DAY_IN_MS));

        if (dates.length === 1) {
            cycleDays = 5;
            stageFirstToQuote += 2;
            stageQuoteToClose += 3;
        } else {
            const quoteDate = dates[Math.floor(dates.length / 2)];
            const firstToQuote = Math.max(1, Math.round((quoteDate - first) / DAY_IN_MS));
            const quoteToClose = Math.max(1, Math.round((last - quoteDate) / DAY_IN_MS));
            stageFirstToQuote += firstToQuote;
            stageQuoteToClose += quoteToClose;
        }

        cycleTotal += cycleDays;
        sampleCount += 1;
    });

    if (sampleCount === 0) {
        return {
            dealsPerWeek,
            avgCycleDays: normalized.length > 0 ? 5 : 0,
            firstToQuote: normalized.length > 0 ? 2 : 0,
            quoteToClose: normalized.length > 0 ? 3 : 0,
            sampleSize: 0,
            coverageDays: spanDays
        };
    }

    return {
        dealsPerWeek,
        avgCycleDays: cycleTotal / sampleCount,
        firstToQuote: stageFirstToQuote / sampleCount,
        quoteToClose: stageQuoteToClose / sampleCount,
        sampleSize: sampleCount,
        coverageDays: spanDays
    };
}

function calculateMarginIntelligence(normalized = [], options = {}) {
    const threshold = Number.isFinite(options.threshold) ? options.threshold : 10;

    if (!Array.isArray(normalized) || normalized.length === 0) {
        return {
            threshold,
            count: 0,
            share: 0,
            topDeals: [],
            topReps: [],
            topDivisions: []
        };
    }

    const lowMarginDeals = [];
    const repHotspots = new Map();
    const divisionHotspots = new Map();

    const ensureHotspot = (map, key) => {
        if (!map.has(key)) {
            map.set(key, { name: key || 'Unassigned', count: 0, turnover: 0 });
        }
        return map.get(key);
    };

    normalized.forEach(entry => {
        if (!Number.isFinite(entry.grossMargin)) {
            return;
        }
        if (entry.turnover <= 0) {
            return;
        }
        if (entry.grossMargin < threshold) {
            lowMarginDeals.push(entry);
            const repHotspot = ensureHotspot(repHotspots, entry.salesRep || 'Unassigned');
            repHotspot.count += 1;
            repHotspot.turnover += entry.turnover;

            const divisionHotspot = ensureHotspot(divisionHotspots, entry.division || 'Unassigned');
            divisionHotspot.count += 1;
            divisionHotspot.turnover += entry.turnover;
        }
    });

    lowMarginDeals.sort((a, b) => (a.grossMargin || 0) - (b.grossMargin || 0));

    const topDeals = lowMarginDeals.slice(0, 5).map(entry => ({
        rep: entry.salesRep || 'Unassigned',
        division: entry.division || 'Unassigned',
        margin: Number.isFinite(entry.grossMargin) ? entry.grossMargin : null,
        turnover: entry.turnover,
        customer: entry.customer || 'N/A'
    }));

    const topReps = Array.from(repHotspots.values())
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

    const topDivisions = Array.from(divisionHotspots.values())
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

    const share = normalized.length ? (lowMarginDeals.length / normalized.length) * 100 : 0;

    return {
        threshold,
        count: lowMarginDeals.length,
        share,
        topDeals,
        topReps,
        topDivisions
    };
}

function renderMarginIntelligence(data) {
    if (!data || data.count === 0) {
        return '<p style="margin:0;color:#6b7280;font-size:13px">All analysed deals are above the configured margin threshold.</p>';
    }

    const dealRows = data.topDeals.map(deal => `
        <div style="display:flex;flex-direction:column;padding:8px;border-radius:8px;background:#f9fafb;margin-bottom:6px;border:1px solid #eef2f7">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <span style="font-weight:600;color:#1f2937">${escapeHtml(deal.customer)}</span>
                <span style="font-weight:700;color:#ef4444">${Number.isFinite(deal.margin) ? deal.margin.toFixed(1) : 'N/A'}%</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:#6b7280">
                <span>${escapeHtml(deal.rep)}</span>
                <span>${escapeHtml(deal.division)}</span>
                <span>${formatSalesCurrency(deal.turnover)}</span>
            </div>
        </div>
    `).join('');

    const repRows = data.topReps.length > 0 ? `
        <div style="margin-top:10px">
            <div style="font-size:12px;font-weight:600;color:#059669;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Rep Hotspots</div>
            ${data.topReps.map(rep => `
                <div style="display:flex;justify-content:space-between;font-size:12px;color:#374151;margin-bottom:4px">
                    <span>${escapeHtml(rep.name)}</span>
                    <span>${rep.count} deals Â· ${formatSalesCurrency(rep.turnover)}</span>
                </div>
            `).join('')}
        </div>
    ` : '';

    const divisionRows = data.topDivisions.length > 0 ? `
        <div style="margin-top:10px">
            <div style="font-size:12px;font-weight:600;color:#3b82f6;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Division Watchlist</div>
            ${data.topDivisions.map(div => `
                <div style="display:flex;justify-content:space-between;font-size:12px;color:#374151;margin-bottom:4px">
                    <span>${escapeHtml(div.name)}</span>
                    <span>${div.count} deals Â· ${formatSalesCurrency(div.turnover)}</span>
                </div>
            `).join('')}
        </div>
    ` : '';

    return `${dealRows}${repRows}${divisionRows}` || '<p style="margin:0;color:#6b7280;font-size:13px">No margin anomalies detected.</p>';
}

function calculatePerformanceTrends(normalized = [], summary = null) {
    if (!Array.isArray(normalized) || normalized.length === 0) {
        return {
            reps: { gainers: [], decliners: [] },
            divisions: { gainers: [], decliners: [] }
        };
    }

    const dateInfo = summary && summary.dateInfo ? summary.dateInfo : getSalesDateInfo(normalized);
    const referenceDate = dateInfo && dateInfo.maxDate instanceof Date && !Number.isNaN(dateInfo.maxDate.getTime())
        ? new Date(dateInfo.maxDate)
        : new Date();

    const last7Start = new Date(referenceDate.getTime() - 6 * DAY_IN_MS);
    const prev7Start = new Date(last7Start.getTime() - 7 * DAY_IN_MS);
    const last30Start = new Date(referenceDate.getTime() - 29 * DAY_IN_MS);
    const prev30Start = new Date(last30Start.getTime() - 30 * DAY_IN_MS);

    const ensureBucket = (map, key) => {
        if (!map.has(key)) {
            map.set(key, {
                name: key || 'Unassigned',
                last7: 0,
                prev7: 0,
                last30: 0,
                prev30: 0
            });
        }
        return map.get(key);
    };

    const repStats = new Map();
    const divisionStats = new Map();

    normalized.forEach(entry => {
        if (!(entry.date instanceof Date) || Number.isNaN(entry.date.getTime())) {
            return;
        }
        const date = entry.date;
        const repBucket = ensureBucket(repStats, entry.salesRep || 'Unassigned');
        const divisionBucket = ensureBucket(divisionStats, entry.division || 'Unassigned');

        if (date >= last7Start) {
            repBucket.last7 += entry.turnover;
            divisionBucket.last7 += entry.turnover;
        } else if (date >= prev7Start) {
            repBucket.prev7 += entry.turnover;
            divisionBucket.prev7 += entry.turnover;
        }

        if (date >= last30Start) {
            repBucket.last30 += entry.turnover;
            divisionBucket.last30 += entry.turnover;
        } else if (date >= prev30Start) {
            repBucket.prev30 += entry.turnover;
            divisionBucket.prev30 += entry.turnover;
        }
    });

    const computeGrowth = (current, previous) => {
        if (previous > 0) {
            return ((current - previous) / previous) * 100;
        }
        return current > 0 ? 100 : 0;
    };

    const toMomentum = map => Array.from(map.values()).map(item => ({
        name: item.name,
        growth7: computeGrowth(item.last7, item.prev7),
        growth30: computeGrowth(item.last30, item.prev30),
        last7: item.last7,
        last30: item.last30
    }));

    const repMomentum = toMomentum(repStats)
        .filter(item => Number.isFinite(item.growth30) && (item.last7 > 0 || item.last30 > 0));
    const divisionMomentum = toMomentum(divisionStats)
        .filter(item => Number.isFinite(item.growth30) && (item.last7 > 0 || item.last30 > 0));

    const gainers = arr => arr
        .filter(item => item.growth30 >= 0)
        .sort((a, b) => b.growth30 - a.growth30)
        .slice(0, 3);

    const decliners = arr => arr
        .filter(item => item.growth30 < 0)
        .sort((a, b) => a.growth30 - b.growth30)
        .slice(0, 3);

    return {
        reps: {
            gainers: gainers(repMomentum),
            decliners: decliners(repMomentum)
        },
        divisions: {
            gainers: gainers(divisionMomentum),
            decliners: decliners(divisionMomentum)
        }
    };
}

function renderPerformanceTrends(trends) {
    if (!trends) {
        return '<p style="margin:0;color:#6b7280;font-size:13px">Trend data unavailable.</p>';
    }

    const formatRow = (item, accent) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #e5e7eb">
            <div style="font-weight:600;color:#1f2937">${escapeHtml(item.name)}</div>
            <div style="font-size:12px;color:${accent}">
                ${item.growth30 >= 0 ? '+' : ''}${item.growth30.toFixed(1)}% (30d)
                <span style="color:#9ca3af;margin-left:6px">${item.growth7 >= 0 ? '+' : ''}${item.growth7.toFixed(1)}% (7d)</span>
            </div>
        </div>
    `;

    const repGainers = trends.reps && trends.reps.gainers && trends.reps.gainers.length > 0
        ? trends.reps.gainers.map(item => formatRow(item, '#059669')).join('')
        : '<p style="margin:0;color:#6b7280;font-size:12px">No reps accelerating in the last 30 days.</p>';

    const repDecliners = trends.reps && trends.reps.decliners && trends.reps.decliners.length > 0
        ? trends.reps.decliners.map(item => formatRow(item, '#ef4444')).join('')
        : '<p style="margin:0;color:#6b7280;font-size:12px">No reps slowing down in the last 30 days.</p>';

    const divisionGainers = trends.divisions && trends.divisions.gainers && trends.divisions.gainers.length > 0
        ? trends.divisions.gainers.map(item => formatRow(item, '#3b82f6')).join('')
        : '<p style="margin:0;color:#6b7280;font-size:12px">No divisions accelerating in the last 30 days.</p>';

    const divisionDecliners = trends.divisions && trends.divisions.decliners && trends.divisions.decliners.length > 0
        ? trends.divisions.decliners.map(item => formatRow(item, '#f97316')).join('')
        : '<p style="margin:0;color:#6b7280;font-size:12px">No divisions slowing down in the last 30 days.</p>';

    return `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
            <div>
                <div style="font-size:12px;font-weight:700;color:#059669;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Reps Rising</div>
                ${repGainers}
            </div>
            <div>
                <div style="font-size:12px;font-weight:700;color:#ef4444;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Reps At Risk</div>
                ${repDecliners}
            </div>
        </div>
        <div style="margin-top:16px">
            <div style="font-size:12px;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px">Division Momentum</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                <div>${divisionGainers}</div>
                <div>${divisionDecliners}</div>
            </div>
        </div>
    `;
}

function calculateConversionFunnel(normalized = []) {
    if (!Array.isArray(normalized) || normalized.length === 0) {
        return {
            leads: 0,
            quotes: 0,
            orders: 0,
            leadToQuote: 0,
            quoteToOrder: 0,
            overall: 0
        };
    }

    const customerSet = new Set();
    let quoteCount = 0;
    let orderCount = 0;

    normalized.forEach(entry => {
        const customerKey = entry.customer ? `cust:${entry.customer}` : `row:${entry.rowIndex}`;
        customerSet.add(customerKey);
        if (entry.turnover > 0) {
            quoteCount += 1;
        }
        if (entry.turnover > 1000) {
            orderCount += 1;
        }
    });

    let leads = customerSet.size || normalized.length;
    let quotes = Math.min(quoteCount, leads);
    if (quotes === 0 && leads > 0) {
        quotes = Math.ceil(leads * 0.6);
    }
    let orders = Math.min(orderCount, quotes);
    if (orders === 0 && quotes > 0) {
        orders = Math.ceil(quotes * 0.5);
    }

    const leadToQuote = leads ? (quotes / leads) * 100 : 0;
    const quoteToOrder = quotes ? (orders / quotes) * 100 : 0;
    const overall = leads ? (orders / leads) * 100 : 0;

    return {
        leads,
        quotes,
        orders,
        leadToQuote,
        quoteToOrder,
        overall
    };
}

function renderConversionFunnel(funnel) {
    if (!funnel || funnel.leads === 0) {
        return '<p style="margin:0;color:#6b7280;font-size:13px">Not enough data to model the funnel yet.</p>';
    }

    const quoteWidth = funnel.leads ? Math.max(8, Math.min(100, (funnel.quotes / funnel.leads) * 100)) : 0;
    const orderWidth = funnel.leads ? Math.max(6, Math.min(100, (funnel.orders / funnel.leads) * 100)) : 0;

    const formatStage = (label, value, width, color) => `
        <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;font-size:12px;color:#374151;margin-bottom:4px">
                <span style="font-weight:600">${label}</span>
                <span>${value.toLocaleString('en-ZA')}</span>
            </div>
            <div style="height:12px;background:#e5e7eb;border-radius:8px;overflow:hidden">
                <div style="height:100%;width:${width}%;background:${color};transition:width 0.3s ease"></div>
            </div>
        </div>
    `;

    return `
        ${formatStage('Leads', funnel.leads, 100, '#c7d2fe')}
        ${formatStage('Quotes', funnel.quotes, quoteWidth, '#93c5fd')}
        ${formatStage('Orders', funnel.orders, orderWidth, '#34d399')}
        <div style="font-size:12px;color:#6b7280;margin-top:8px">
            Lead â†’ Quote: ${funnel.leadToQuote.toFixed(1)}% Â· Quote â†’ Order: ${funnel.quoteToOrder.toFixed(1)}% Â· Overall: ${funnel.overall.toFixed(1)}%
        </div>
    `;
}

function renderSalesInsights(summary, options = {}) {
    const contextLabel = options.contextLabel ? `${escapeHtml(options.contextLabel)} ` : '';
    const topRep = summary.topSalesReps[0];
    const topDivision = summary.topDivisions[0];
    const lowestDeal = summary.lowestDeal || 0;
    const avgMarginDisplay = Number.isFinite(summary.avgGrossMargin) ? `${summary.avgGrossMargin.toFixed(1)}%` : 'N/A';
    const totalOrderLines = summary.totalOrderLines || 0;
    const targetSummary = options.targetSummary || null;
    const turnoverTargetBucket = targetSummary && targetSummary.turnover ? targetSummary.turnover : null;
    const turnoverTargetValue = turnoverTargetBucket && Number.isFinite(turnoverTargetBucket.target) ? turnoverTargetBucket.target : null;
    let turnoverTargetText = null;
    if (Number.isFinite(turnoverTargetValue) && turnoverTargetValue > 0) {
        const ratio = turnoverTargetValue !== 0 ? (summary.totalTurnover / turnoverTargetValue) * 100 : null;
        const safeRatio = Number.isFinite(ratio) ? Math.max(0, Math.min(999, Math.round(ratio))) : null;
        const ratioText = safeRatio !== null ? ` (${safeRatio}% of target)` : '';
        turnoverTargetText = `Target ${formatSalesCurrency(turnoverTargetValue, { compact: true, decimals: 0 })}${ratioText}`;
    }

    const metricsTiles = [
        {
            key: 'records',
            label: 'Records Analysed',
            value: Number(summary.totalRecords || 0).toLocaleString(),
            accent: 'linear-gradient(135deg,rgba(16,185,129,0.96),rgba(5,150,105,0.95))'
        },
        {
            key: 'turnover',
            label: 'Total Turnover',
            value: formatSalesCurrency(summary.totalTurnover, { compact: true, decimals: 0 }),
            accent: 'linear-gradient(135deg,rgba(34,197,94,0.97),rgba(22,163,74,0.97))',
            sub: turnoverTargetText
        },
        {
            key: 'cost',
            label: 'Total Cost',
            value: formatSalesCurrency(summary.totalCost, { compact: true, decimals: 0 }),
            accent: 'linear-gradient(135deg,rgba(14,165,233,0.95),rgba(37,99,235,0.95))'
        },
        {
            key: 'grossProfit',
            label: 'Gross Profit',
            value: formatSalesCurrency(summary.totalGrossProfit, { compact: true, decimals: 0 }),
            accent: 'linear-gradient(135deg,rgba(236,72,153,0.95),rgba(168,85,247,0.95))'
        },
        {
            key: 'reps',
            label: 'Active Sales Reps',
            value: Number(summary.uniqueReps || 0).toLocaleString(),
            accent: 'linear-gradient(135deg,rgba(59,130,246,0.95),rgba(37,99,235,0.95))'
        },
        {
            key: 'divisions',
            label: 'Reporting Divisions',
            value: Number(summary.uniqueDivisions || 0).toLocaleString(),
            accent: 'linear-gradient(135deg,rgba(20,184,166,0.95),rgba(13,148,136,0.95))'
        },
        {
            key: 'orderLines',
            label: 'Order Lines',
            value: totalOrderLines.toLocaleString(),
            accent: 'linear-gradient(135deg,rgba(249,115,22,0.95),rgba(245,158,11,0.95))'
        },
        {
            key: 'activeCustomers30',
            label: 'Active Customers (30 Days)',
            value: Number(summary.activeCustomersLast30Days || 0).toLocaleString(),
            accent: 'linear-gradient(135deg,rgba(99,102,241,0.95),rgba(79,70,229,0.95))'
        }
    ];
    const metricsHtml = metricsTiles.map(tile => `
        <div data-drilldown-action="sales-metric" data-metric-key="${tile.key}" data-metric-label="${escapeHtml(tile.label)}" style="flex:1 1 170px;background:${tile.accent};border-radius:12px;padding:14px 16px;display:flex;flex-direction:column;gap:6px;min-height:86px;color:#fff;box-shadow:0 6px 18px rgba(15,23,42,0.25);border:1px solid rgba(255,255,255,0.18);cursor:pointer;transition:transform 0.2s ease" role="button" tabindex="0" aria-label="${escapeHtml(tile.label)} drilldown">
            <div style="font-size:20px;font-weight:800;line-height:1.2">${tile.value}</div>
            <div style="font-size:12px;font-weight:600;opacity:0.85;line-height:1.3">${tile.label}</div>
            ${tile.sub ? `<div style="font-size:11px;opacity:0.8;line-height:1.3">${tile.sub}</div>` : ''}
        </div>
    `).join('');

    return `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:20px">
            <div style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(5,150,105,0.3)">
                <h4 style="margin:0 0 16px 0;font-size:18px;font-weight:700">${contextLabel}Key Metrics</h4>
                <div style="display:flex;flex-wrap:wrap;gap:12px">${metricsHtml}</div>
            </div>
            <div data-drilldown-action="sales-performance" role="button" tabindex="0" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);color:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(59,130,246,0.3);cursor:pointer;outline:none">
                <h4 style="margin:0 0 16px 0;font-size:18px;font-weight:700">Performance Pulse</h4>
                <div style="margin-bottom:12px">
                    <div style="font-size:20px;font-weight:800;margin-bottom:4px">${formatSalesCurrency(summary.avgDealSize)}</div>
                    <div style="font-size:12px;opacity:0.9">Average Deal Size</div>
                </div>
                <div style="margin-bottom:12px">
                    <div style="font-size:18px;font-weight:700;margin-bottom:4px">${formatSalesCurrency(summary.highestDeal)}</div>
                    <div style="font-size:12px;opacity:0.9">Largest Deal</div>
                </div>
                <div>
                    <div style="font-size:16px;font-weight:700;margin-bottom:4px">${formatSalesCurrency(lowestDeal)}</div>
                    <div style="font-size:12px;opacity:0.9">Smallest Deal</div>
                </div>
                <div style="margin-top:12px">
                    <div style="font-size:18px;font-weight:700;margin-bottom:4px">${avgMarginDisplay}</div>
                    <div style="font-size:12px;opacity:0.9">Average Gross Margin</div>
                </div>
            </div>
            <div data-drilldown-action="sales-leaders" role="button" tabindex="0" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(139,92,246,0.3);cursor:pointer;outline:none">
                <h4 style="margin:0 0 16px 0;font-size:18px;font-weight:700">Leaders & Period</h4>
                <div style="margin-bottom:12px">
                    <div style="font-size:14px;font-weight:700;margin-bottom:6px">Data Period</div>
                    <div style="font-size:12px;opacity:0.9;line-height:1.3">${escapeHtml(summary.dateInfo.rangeLabel)}</div>
                </div>
                <div style="margin-bottom:12px">
                    <div style="font-size:16px;font-weight:700;margin-bottom:4px">${topRep ? escapeHtml(topRep.name) : 'N/A'}</div>
                    <div style="font-size:12px;opacity:0.9">Top Rep ${topRep ? `(${formatSalesCurrency(topRep.turnover)})` : ''}</div>
                </div>
                <div>
                    <div style="font-size:16px;font-weight:700;margin-bottom:4px">${topDivision ? escapeHtml(topDivision.name) : 'N/A'}</div>
                    <div style="font-size:12px;opacity:0.9">Top Division ${topDivision ? `(${formatSalesCurrency(topDivision.turnover)})` : ''}</div>
                </div>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:16px">
            <div data-drilldown-action="sales-top-reps" role="button" tabindex="0" style="background:white;padding:16px;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer;outline:none">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px">Top Sales Reps</h4>
                <div style="max-height:200px;overflow-y:auto">
                    ${summary.topSalesReps.length > 0 ? summary.topSalesReps.slice(0, 5).map((rep, idx) => `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:8px;border-radius:6px;background:${idx === 0 ? '#fef3c7' : '#f9fafb'};border-left:4px solid ${idx === 0 ? '#f59e0b' : '#e5e7eb'}">
                            <div style="flex:1">
                                <div style="font-weight:600;color:#1f2937;font-size:14px">${idx + 1}. ${escapeHtml(rep.name)}</div>
                                <div style="font-size:12px;color:#6b7280">${rep.deals} deals</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-weight:700;color:#059669;font-size:14px">${formatSalesCurrency(rep.turnover)}</div>
                                <div style="font-size:11px;color:#6b7280">${summary.totalTurnover ? ((rep.turnover / summary.totalTurnover) * 100).toFixed(1) : '0.0'}%</div>
                            </div>
                        </div>
                    `).join('') : '<p style="color:#6b7280;font-size:13px;text-align:center;padding:20px">No sales representative data detected</p>'}
                </div>
            </div>
            <div data-drilldown-action="sales-divisions" role="button" tabindex="0" style="background:white;padding:16px;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer;outline:none">
                <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px">Division Turnover</h4>
                ${summary.topDivisions.length > 0 ? summary.topDivisions.slice(0, 6).map(div => `
                    <div style="margin-bottom:8px">
                        <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                            <span style="color:#374151;font-size:13px">${escapeHtml(div.name)}</span>
                            <span style="font-weight:600;color:#3b82f6;font-size:13px">${formatSalesCurrency(div.turnover)}</span>
                        </div>
                        <div style="background:#e5e7eb;height:4px;border-radius:2px;overflow:hidden">
                            <div style="background:#3b82f6;height:100%;width:${summary.totalTurnover ? (div.turnover / summary.totalTurnover) * 100 : 0}%;transition:width 0.3s ease"></div>
                        </div>
                    </div>
                `).join('') : '<p style="color:#6b7280;font-size:13px;text-align:center">No division data detected</p>'}
            </div>
        </div>
        <div data-drilldown-action="sales-momentum" role="button" tabindex="0" style="background:linear-gradient(135deg,#f3f4f6,#ffffff);padding:16px;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer;outline:none">
            <h4 style="margin:0 0 12px 0;color:#1f2937;font-size:16px">Momentum</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;font-size:12px;color:#6b7280">
                <div style="text-align:center">
                    <div style="font-size:20px;font-weight:800;color:#059669;margin-bottom:4px">${formatSalesCurrency(summary.turnoverPerRep, { decimals: 0 })}</div>
                    <div>Avg Turnover / Rep</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:20px;font-weight:800;color:#3b82f6;margin-bottom:4px">${formatSalesCurrency(summary.turnoverPerDivision, { decimals: 0 })}</div>
                    <div>Avg Turnover / Division</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:20px;font-weight:800;color:#8b5cf6;margin-bottom:4px">${summary.dateInfo.last30DaysDeals}</div>
                    <div>Deals (30 days)</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:20px;font-weight:800;color:#0ea5e9;margin-bottom:4px">${Number(summary.dateInfo.last30DaysCustomers || 0).toLocaleString()}</div>
                    <div>Active Customers (30 days)</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:20px;font-weight:800;color:#ef4444;margin-bottom:4px">${formatSalesCurrency(summary.dateInfo.last30DaysTurnover)}</div>
                    <div>Turnover (30 days)</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:20px;font-weight:800;color:#f97316;margin-bottom:4px">${totalOrderLines.toLocaleString()}</div>
                    <div>Total Order Lines</div>
                </div>
            </div>
        </div>`;
}

function resetSalesTableState(data = []) {
    const dataArray = Array.isArray(data) ? data : [];
    salesTableState.currentData = dataArray;
    salesTableState.totalRows = dataArray.length;
    salesTableState.visibleRows = dataArray.length > 0 ? Math.min(SALES_TABLE_DEFAULT_ROWS, dataArray.length) : SALES_TABLE_DEFAULT_ROWS;
}

function renderSalesTable(normalized = []) {
    const tableHeader = document.getElementById('salesTableHeader');
    const tableBody = document.getElementById('salesTableBody');
    const actionsContainer = document.getElementById('salesTableActions');
    const loadMoreButton = document.getElementById('salesTableLoadMore');
    const countLabel = document.getElementById('salesTableCount');

    if (!Array.isArray(normalized) || normalized.length === 0) {
        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';
        if (actionsContainer) {
            actionsContainer.style.display = 'none';
        }
        return;
    }

    salesTableState.currentData = normalized;
    salesTableState.totalRows = normalized.length;
    salesTableState.visibleRows = Math.min(salesTableState.visibleRows, salesTableState.totalRows);

    const firstRow = normalized[0]?.raw || {};
    const headers = Object.keys(firstRow);

    tableHeader.innerHTML = headers.map(header => `
        <th style="padding:12px;text-align:left;border-bottom:1px solid #e5e7eb;font-weight:600">${escapeHtml(header)}</th>
    `).join('');

    const rowsToRender = normalized.slice(0, salesTableState.visibleRows);
    tableBody.innerHTML = rowsToRender.map((entry, idx) => {
        const row = entry.raw || {};
        return `
            <tr style="border-bottom:1px solid #f3f4f6;${idx % 2 === 0 ? 'background:#f9fafb' : ''}">
                ${headers.map(header => {
                    const keyLower = header.trim().toLowerCase();
                    const cellRaw = row[header];
                    let cellValue = cellRaw === undefined || cellRaw === null ? '' : cellRaw;

                    if (typeof cellValue === 'number' && Number.isFinite(cellValue)) {
                        if (SALES_CURRENCY_KEYWORDS.some(keyword => keyLower.includes(keyword))) {
                            cellValue = formatSalesCurrency(cellValue);
                        }
                    } else if (typeof cellValue === 'string') {
                        if (SALES_CURRENCY_KEYWORDS.some(keyword => keyLower.includes(keyword))) {
                            const numeric = parseSalesCurrency(cellValue);
                            cellValue = numeric ? formatSalesCurrency(numeric) : cellValue;
                        } else if (SALES_PERCENT_KEYWORDS.some(keyword => keyLower.includes(keyword))) {
                            const percent = parseSalesPercentage(cellValue);
                            cellValue = percent !== null ? `${percent.toFixed(1)}%` : cellValue;
                        }
                    }

                    return `<td style="padding:8px 12px;border-bottom:1px solid #e5e7eb;font-size:13px">${escapeHtml(cellValue)}</td>`;
                }).join('')}
            </tr>
        `;
    }).join('');

    if (actionsContainer) {
        if (salesTableState.totalRows > 0) {
            actionsContainer.style.display = 'flex';
        } else {
            actionsContainer.style.display = 'none';
        }
    }
    if (loadMoreButton) {
        loadMoreButton.style.display = salesTableState.visibleRows < salesTableState.totalRows ? 'inline-flex' : 'none';
    }
    if (countLabel) {
        const showing = Math.min(salesTableState.visibleRows, salesTableState.totalRows);
        countLabel.textContent = salesTableState.totalRows > 0
            ? `Showing ${showing.toLocaleString('en-ZA')} of ${salesTableState.totalRows.toLocaleString('en-ZA')} rows`
            : '';
    }
}

function renderSalesView(normalized = [], options = {}) {
    const salesDataDiv = document.getElementById('salesData');
    const noSalesDataP = document.getElementById('noSalesData');

    resetSalesTableState(normalized);

    if (!Array.isArray(normalized) || normalized.length === 0) {
        setSalesDrilldownState(null, [], null, {});
        if (salesDataDiv) {
            salesDataDiv.style.display = 'none';
        }
        if (noSalesDataP) {
            noSalesDataP.style.display = 'block';
            noSalesDataP.textContent = options.emptyMessage || 'No sales data available.';
        }
        const summaryDiv = document.getElementById('salesSummary');
        if (summaryDiv) {
            summaryDiv.innerHTML = '';
        }
        renderSalesTable([]);
        return;
    }

    if (noSalesDataP) {
        noSalesDataP.style.display = 'none';
    }
    if (salesDataDiv) {
        salesDataDiv.style.display = 'block';
    }

    const summary = summarizeSalesData(normalized);
    const summaryDiv = document.getElementById('salesSummary');
    if (summaryDiv) {
        let targetFilters = {};
        if (options && typeof options === 'object' && options.targetFilters && typeof options.targetFilters === 'object') {
            const candidate = options.targetFilters;
            const sanitized = {};
            if (Array.isArray(candidate.division) && candidate.division.length > 0) {
                sanitized.division = candidate.division.slice();
            }
            if (Array.isArray(candidate.salesGroup) && candidate.salesGroup.length > 0) {
                sanitized.salesGroup = candidate.salesGroup.slice();
            }
            if (candidate.salesRep) {
                sanitized.salesRep = candidate.salesRep;
            }
            if (candidate.dateFrom instanceof Date && !Number.isNaN(candidate.dateFrom.getTime())) {
                sanitized.dateFrom = candidate.dateFrom;
            }
            if (candidate.dateTo instanceof Date && !Number.isNaN(candidate.dateTo.getTime())) {
                sanitized.dateTo = candidate.dateTo;
            }
            targetFilters = sanitized;
        }
        const targetSummary = getDashboardTargetSummary(targetFilters);
        const insightOptions = Object.assign({}, options, { targetSummary });
        summaryDiv.innerHTML = renderSalesInsights(summary, insightOptions);
        wireSalesDrilldowns(summaryDiv, summary, normalized, targetSummary, insightOptions);
    }

    renderSalesTable(normalized);
}

function loadMoreSalesRows() {
    if (!Array.isArray(salesTableState.currentData) || salesTableState.currentData.length === 0) {
        return;
    }
    if (salesTableState.visibleRows >= salesTableState.totalRows) {
        return;
    }
    salesTableState.visibleRows = Math.min(
        salesTableState.totalRows,
        salesTableState.visibleRows + SALES_TABLE_INCREMENT
    );
    renderSalesTable(salesTableState.currentData);
}

function loadMoreProductRows() {
    if (!Array.isArray(productTableState.rows) || productTableState.rows.length === 0) {
        return;
    }
    if (productTableState.visibleRows >= productTableState.totalRows) {
        return;
    }
    productTableState.visibleRows = Math.min(
        productTableState.totalRows,
        productTableState.visibleRows + PRODUCT_TABLE_INCREMENT
    );
    renderProductView();
}

function exportProductRepCsv() {
    const rows = Array.isArray(productTableState.rows) ? productTableState.rows : [];
    if (rows.length === 0) {
        alert('No product performance data to export.');
        return;
    }

    const headers = ['Division', 'Sector', 'Rep Code', 'Sales Rep', 'Turnover', 'GP %', 'Units/Lines', 'Target (sum)', 'Remaining', '% Achieved'];
    const escapeCsv = (value) => {
        const val = value === undefined || value === null ? '' : String(value);
        if (/["]/g.test(val) || val.includes(',') || val.includes('\n')) {
            return `"${val.replace(/"/g, '""')}"`;
        }
        return val;
    };

    const lines = [headers.join(',')];
    rows.forEach(row => {
        const line = [
            row.division,
            row.sector,
            row.repCode,
            row.rep,
            row.turnover,
            row.margin !== null && row.margin !== undefined ? Number(row.margin).toFixed(2) : '',
            row.units,
            row.targetAmount,
            row.remaining,
            row.achievedPct !== null && row.achievedPct !== undefined ? Number(row.achievedPct).toFixed(2) : ''
        ].map(escapeCsv).join(',');
        lines.push(line);
    });

    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'product_performance_by_rep.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function ensureSalesDataNormalized() {
    const salesData = Array.isArray(masterData.sales) ? masterData.sales : [];

    if (salesData.length === 0) {
        salesNormalizationState.sourceRef = salesData;
        salesNormalizationState.normalized = [];
        salesNormalizationState.meta = {
            divisions: [],
            salesGroups: [],
            businessCos: [],
            salesReps: [],
            customers: [],
            products: [],
            productCodes: [],
            salesSectors: [],
            powerFlags: [],
            dateInfo: getSalesDateInfo([]),
            totals: {
                turnover: 0,
                units: 0,
                cost: 0,
                grossProfit: 0,
                orderLines: 0
            }
        };
        salesNormalizationState.cachedRevision = salesNormalizationState.cacheToken;
        return salesNormalizationState;
    }

    const cacheIsFresh = salesNormalizationState.sourceRef === salesData && salesNormalizationState.cachedRevision === salesNormalizationState.cacheToken;

    if (cacheIsFresh && salesNormalizationState.normalized.length === salesData.length) {
        return salesNormalizationState;
    }

    const normalized = normalizeSalesData(salesData);
    const meta = getSalesMeta(normalized);

    salesNormalizationState.sourceRef = salesData;
    salesNormalizationState.normalized = normalized;
    salesNormalizationState.meta = meta;
    salesNormalizationState.cachedRevision = salesNormalizationState.cacheToken;

    return salesNormalizationState;
}

function ensureProductDataNormalized() {
    const productData = Array.isArray(masterData.pricing) ? masterData.pricing : [];

    if (productData.length === 0) {
        productNormalizationState.sourceRef = productData;
        productNormalizationState.normalized = [];
        productNormalizationState.meta = {
            divisions: [],
            salesGroups: [],
            salesReps: [],
            products: [],
            productCodes: [],
            salesSectors: [],
            powerFlags: [],
            totals: {
                turnover: 0,
                grossProfit: 0,
                units: 0
            }
        };
        productNormalizationState.cachedRevision = productNormalizationState.cacheToken;
        return productNormalizationState;
    }

    const cacheIsFresh = productNormalizationState.sourceRef === productData
        && productNormalizationState.cachedRevision === productNormalizationState.cacheToken;

    if (cacheIsFresh && productNormalizationState.normalized.length === productData.length) {
        return productNormalizationState;
    }

    const normalized = normalizeProductData(productData);
    const meta = getProductMeta(normalized);

    productNormalizationState.sourceRef = productData;
    productNormalizationState.normalized = normalized;
    productNormalizationState.meta = meta;
    productNormalizationState.cachedRevision = productNormalizationState.cacheToken;

    return productNormalizationState;
}

function ensureCustomerDataNormalized() {
    const customerData = Array.isArray(masterData.customer) ? masterData.customer : [];

    if (customerData.length === 0) {
        customerNormalizationState.sourceRef = customerData;
        customerNormalizationState.normalized = [];
        customerNormalizationState.meta = {
            divisions: [],
            salesGroups: [],
            businessCodes: [],
            salesReps: [],
            statuses: [],
            territories: [],
            dateInfo: { minDate: null, maxDate: null }
        };
        customerNormalizationState.cachedRevision = customerNormalizationState.cacheToken;
        return customerNormalizationState;
    }

    const cacheIsFresh = customerNormalizationState.sourceRef === customerData
        && customerNormalizationState.cachedRevision === customerNormalizationState.cacheToken;

    if (cacheIsFresh && customerNormalizationState.normalized.length === customerData.length) {
        return customerNormalizationState;
    }

    const normalized = normalizeCustomerData(customerData);
    const meta = getCustomerMeta(normalized);

    customerNormalizationState.sourceRef = customerData;
    customerNormalizationState.normalized = normalized;
    customerNormalizationState.meta = meta;
    customerNormalizationState.cachedRevision = customerNormalizationState.cacheToken;

    return customerNormalizationState;
}

function parseCSV(text) {
if (!text || typeof text !== 'string') {
    console.error('Invalid text input to parseCSV:', typeof text);
    return [];
}
try {
const lines = text.split('\n').filter(line => line.trim());
if (lines.length === 0) {
    console.error('No valid lines found in CSV');
    return [];
}

console.log(`Parsing CSV with ${lines.length} lines`);
console.log('First line (header):', lines[0]);

const result = [];
const headerRow = [];
let field = '';
let inQuotes = false;

// Parse header row
const headerLine = lines[0];
for (let i = 0; i < headerLine.length; i++) {
const char = headerLine[i];
if (char === '"') {
if (inQuotes && headerLine[i + 1] === '"') {
field += '"';
i++;
} else {
inQuotes = !inQuotes;
}
} else if (char === ',' && !inQuotes) {
headerRow.push(field.trim());
field = '';
} else {
field += char;
}
}
headerRow.push(field.trim());

// Parse data rows
for (let lineIndex = 1; lineIndex < lines.length; lineIndex++) {
const line = lines[lineIndex];
if (!line.trim()) continue;

const row = [];
field = '';
inQuotes = false;

for (let i = 0; i < line.length; i++) {
const char = line[i];
if (char === '"') {
if (inQuotes && line[i + 1] === '"') {
field += '"';
i++;
} else {
inQuotes = !inQuotes;
}
} else if (char === ',' && !inQuotes) {
row.push(field.trim());
field = '';
} else {
field += char;
}
}
row.push(field.trim());

// Convert row to object using headers
const obj = {};
headerRow.forEach((header, index) => {
obj[header] = row[index] || '';
});
result.push(obj);
}
return result;
} catch (error) {
console.error('CSV parsing error:', error);
return [];
}
}

function uploadMasterData() {
const fileInput = document.getElementById('unifiedFileInput');
const dataType = document.getElementById('uploadDataType').value;
const statusDiv = document.getElementById('uploadStatus');

if (!fileInput.files[0]) {
statusDiv.textContent = 'âŒ Please select a file first!';
statusDiv.style.color = '#ef4444';
return;
}

const file = fileInput.files[0];
statusDiv.textContent = `ğŸ“¤ Uploading ${file.name}...`;
statusDiv.style.color = '#3b82f6';

const reader = new FileReader();
reader.onload = function(e) {
try {
let text = e.target.result;
if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
if (typeof XLSX === 'undefined') {
statusDiv.textContent = 'âŒ Excel file support not loaded. Please use CSV files.';
statusDiv.style.color = '#ef4444';
return;
}
const workbook = XLSX.read(e.target.result, {type: 'binary'});
const sheet = workbook.Sheets[workbook.SheetNames[0]];
text = XLSX.utils.sheet_to_csv(sheet);
}

const data = parseCSV(text);
if (data && data.length > 0) {
// Safe way to get upload mode
const uploadModeEl = document.querySelector('input[name="uploadMode"]:checked');
const uploadMode = uploadModeEl ? uploadModeEl.value : 'replace';

if (uploadMode === 'append' && masterData[dataType] && masterData[dataType].length > 0) {
// Append to existing data
const existingCount = masterData[dataType].length;
masterData[dataType] = masterData[dataType].concat(data);
const totalCount = masterData[dataType].length;
statusDiv.textContent = `âœ… Added ${data.length} new rows! Total: ${totalCount} rows (was ${existingCount})`;
} else {
// Replace existing data
const hadExisting = masterData[dataType] && masterData[dataType].length > 0;
masterData[dataType] = data;
statusDiv.textContent = hadExisting ? 
`ğŸ”„ Replaced existing data! Now ${data.length} rows of ${dataType} data` :
`âœ… Successfully uploaded ${data.length} rows of ${dataType} data!`;
}
                
                statusDiv.style.color = '#059669';
                
                // Refresh the relevant section display
                if (dataType === 'sales') {
                    invalidateSalesNormalizationState();
                    updateSalesDisplay();
                    updateSalesDashboard();
                    populateSalesFilters();
                    populateDashboardFilters();
                } else if (dataType === 'targets') {
                    updateSalesDashboard();
                } else if (dataType === 'customer') {
                    invalidateCustomerNormalizationState();
                    updateCustomerDisplay();
                    populateCustomerFilters();
                } else if (dataType === 'pricing') {
                    invalidateProductNormalizationState();
                    populatePricingFilters();
                    renderProductView();
                }
                
                // Update data count display
                updateDataCount();
                
                // Log success for debugging
                console.log(`Successfully loaded ${data.length} rows of ${dataType} data:`, data.slice(0, 3));
} else {
statusDiv.textContent = 'âš ï¸ No data found in file or invalid format!';
statusDiv.style.color = '#f59e0b';
}
setTimeout(() => statusDiv.textContent = '', 3000);
} catch (error) {
console.error('Upload error:', error);
statusDiv.textContent = `âŒ Error processing file: ${error.message || 'Unknown error'}`;
statusDiv.style.color = '#ef4444';
}
};

reader.onerror = function() {
statusDiv.textContent = 'âŒ Error reading file!';
statusDiv.style.color = '#ef4444';
};

if (file.name.endsWith('.csv')) {
reader.readAsText(file);
} else {
reader.readAsBinaryString(file);
}
}

function exportSelectedTemplate() {
const dataType = document.getElementById('uploadDataType').value;
const statusDiv = document.getElementById('uploadStatus');

statusDiv.textContent = `ğŸ“„ Generating ${dataType} template...`;
statusDiv.style.color = '#3b82f6';

if (templates[dataType]) {
if (typeof XLSX !== 'undefined') {
const ws = XLSX.utils.aoa_to_sheet([templates[dataType].split(',')]);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, dataType);
XLSX.writeFile(wb, `${dataType}_template.xlsx`);
} else {
const blob = new Blob([templates[dataType]], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `${dataType}_template.csv`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}
statusDiv.textContent = `âœ… ${dataType} template exported!`;
statusDiv.style.color = '#059669';
setTimeout(() => statusDiv.textContent = '', 3000);
}
}

function cleanupTempFiles() {
document.getElementById('unifiedFileInput').value = '';
document.getElementById('fileSelectedInfo').textContent = 'ğŸ“ No file chosen';
document.getElementById('uploadStatus').textContent = 'ğŸ§¹ Temporary files cleaned up!';
document.getElementById('uploadStatus').style.color = '#059669';
setTimeout(() => document.getElementById('uploadStatus').textContent = '', 2000);
}

// Data management functions
function updateDataCount() {
    const dataTypeEl = document.getElementById('uploadDataType');
    const countSpan = document.getElementById('dataCount');
    
    if (!dataTypeEl || !countSpan) {
        console.log('updateDataCount: Elements not ready yet');
        return; // Elements not ready yet
    }
    
    const dataType = dataTypeEl.value;
    console.log('updateDataCount: Checking dataType:', dataType, 'Data:', masterData[dataType] ? masterData[dataType].length : 'undefined');
    
    if (masterData[dataType] && masterData[dataType].length > 0) {
        countSpan.textContent = `ğŸ“Š ${masterData[dataType].length} rows of ${dataType} data loaded`;
        countSpan.style.color = '#059669';
    } else {
        countSpan.textContent = 'No data loaded';
        countSpan.style.color = '#6b7280';
    }
}

function viewCurrentData() {
    const dataType = document.getElementById('uploadDataType').value;
    const statusDiv = document.getElementById('uploadStatus');
    
    if (masterData[dataType] && masterData[dataType].length > 0) {
        const preview = masterData[dataType].slice(0, 3);
        const columns = Object.keys(preview[0]).join(', ');
        statusDiv.innerHTML = `
            <div style="text-align:left;background:white;padding:16px;border-radius:8px;border:1px solid #e5e7eb;margin:10px 0">
                <strong>ğŸ“‹ Current ${dataType} data (${masterData[dataType].length} rows):</strong><br>
                <small style="color:#6b7280">Columns: ${columns}</small><br><br>
                <strong>First 3 rows:</strong><br>
                ${preview.map(row => JSON.stringify(row)).join('<br>')}
                ${masterData[dataType].length > 3 ? `<br><em>... and ${masterData[dataType].length - 3} more rows</em>` : ''}
            </div>
        `;
        statusDiv.style.color = '#059669';
        setTimeout(() => statusDiv.innerHTML = '', 10000);
    } else {
        statusDiv.textContent = `â„¹ï¸ No ${dataType} data currently loaded`;
        statusDiv.style.color = '#6b7280';
        setTimeout(() => statusDiv.textContent = '', 3000);
    }
}

function clearCurrentData() {
    const dataType = document.getElementById('uploadDataType').value;
    const statusDiv = document.getElementById('uploadStatus');
    
    if (masterData[dataType] && masterData[dataType].length > 0) {
        const rowCount = masterData[dataType].length;
        masterData[dataType] = [];
        statusDiv.textContent = `ğŸ—‘ï¸ Cleared ${rowCount} rows of ${dataType} data`;
        statusDiv.style.color = '#ef4444';
        updateDataCount();
        
        // Refresh displays
        if (dataType === 'sales') {
            invalidateSalesNormalizationState();
            updateSalesDisplay();
            updateSalesDashboard();
            populateSalesFilters();
            populateDashboardFilters();
        } else if (dataType === 'targets') {
            updateSalesDashboard();
        } else if (dataType === 'customer') {
            invalidateCustomerNormalizationState();
            updateCustomerDisplay();
            populateCustomerFilters();
        } else if (dataType === 'pricing') {
            invalidateProductNormalizationState();
            populatePricingFilters();
            renderProductView();
        }
    } else {
        statusDiv.textContent = `â„¹ï¸ No ${dataType} data to clear`;
        statusDiv.style.color = '#6b7280';
    }
    setTimeout(() => statusDiv.textContent = '', 3000);
}

// Function to update sales display
function updateSalesDisplay() {
    const { normalized } = ensureSalesDataNormalized();
    renderSalesView(normalized, { contextLabel: 'Overall', emptyMessage: 'No sales data uploaded yet.' });
}

function updateCustomerDisplay(data = null, options = {}) {
    const { normalized } = ensureCustomerDataNormalized();
    const dataset = Array.isArray(data) ? data : normalized;

    const noDataEl = document.getElementById('customerNoData');
    const summaryEl = document.getElementById('customerSummary');
    const insightsEl = document.getElementById('customerInsights');
    const tableSectionEl = document.getElementById('customerTableSection');

    if (!Array.isArray(dataset) || dataset.length === 0) {
        customerDrilldownState.summary = null;
        customerDrilldownState.dataset = [];
        customerDrilldownState.options = {};
        customerDrilldownState.insights = [];
        if (noDataEl) {
            const hasAnyData = Array.isArray(normalized) && normalized.length > 0;
            noDataEl.textContent = hasAnyData
                ? options.emptyMessage || 'No customer records match the current filters.'
                : 'Upload customer data in Master Data section to view reports here.';
            noDataEl.style.display = 'block';
        }
        if (summaryEl) {
            summaryEl.style.display = 'none';
            summaryEl.innerHTML = '';
        }
        if (insightsEl) {
            insightsEl.style.display = 'none';
            insightsEl.innerHTML = '';
        }
        if (tableSectionEl) {
            tableSectionEl.style.display = 'none';
        }
        resetCustomerTableState([]);
        renderCustomerTable([]);
        return;
    }

    if (noDataEl) {
        noDataEl.style.display = 'none';
    }

    const summary = summarizeCustomerData(dataset);
    const insights = generateCustomerInsights(summary);

    if (summaryEl) {
        summaryEl.style.display = 'block';
        summaryEl.innerHTML = renderCustomerSummary(summary, options);
    }
    if (insightsEl) {
        insightsEl.style.display = insights.length > 0 ? 'block' : 'none';
        insightsEl.innerHTML = renderCustomerInsights(insights);
    }
    if (tableSectionEl) {
        tableSectionEl.style.display = 'block';
    }

    wireCustomerDrilldowns(summaryEl, insightsEl, summary, dataset, options, insights);

    resetCustomerTableState(dataset);
    renderCustomerTable(dataset);
}

// Filter functions

function getMultiSelectValues(selectElement) {
    if (!selectElement) {
        return [];
    }
    return Array.from(selectElement.options)
        .filter(option => option.selected && option.value !== '')
        .map(option => option.value);
}

function setMultiSelectOptions(selectElement, values = [], placeholder = '') {
    if (!selectElement) {
        return;
    }
    const previousSelections = getMultiSelectValues(selectElement);
    let html = '';
    if (placeholder) {
        html += `<option value="" disabled>${escapeHtml(placeholder)}</option>`;
    }
    values.forEach(value => {
        const safe = escapeHtml(value);
        html += `<option value="${safe}">${safe}</option>`;
    });
    selectElement.innerHTML = html;
    if (previousSelections.length > 0) {
        Array.from(selectElement.options).forEach(option => {
            if (previousSelections.includes(option.value)) {
                option.selected = true;
            }
        });
    }
    if (!Array.from(selectElement.options).some(option => option.selected)) {
        selectElement.selectedIndex = -1;
    }
}

function setSingleSelectOptions(selectElement, values = [], placeholder = '') {
    if (!selectElement) {
        return;
    }
    const previousValue = selectElement.value;
    let html = '';
    if (placeholder) {
        html += `<option value="">${escapeHtml(placeholder)}</option>`;
    }
    values.forEach(value => {
        const safe = escapeHtml(value);
        html += `<option value="${safe}">${safe}</option>`;
    });
    selectElement.innerHTML = html;
    if (previousValue && values.includes(previousValue)) {
        selectElement.value = previousValue;
    } else if (placeholder) {
        selectElement.value = '';
    }
}

function clearMultiSelect(selectElement) {
    if (!selectElement) {
        return;
    }
    Array.from(selectElement.options).forEach(option => {
        option.selected = false;
    });
    selectElement.selectedIndex = -1;
}

function matchesMultiFilter(selectedValues, candidate) {
    if (!Array.isArray(selectedValues) || selectedValues.length === 0) {
        return true;
    }
    const target = candidate !== undefined && candidate !== null ? candidate : '';
    return selectedValues.includes(target);
}

function syncGroupSlicerSelection(selectElement, value) {
    if (!selectElement) {
        return;
    }
    Array.from(selectElement.options).forEach(option => {
        option.selected = value ? option.value === value : false;
    });
    if (!value) {
        selectElement.selectedIndex = -1;
    }
}

function applyGroupSlicerSelection(value) {
    const normalizedValue = value || null;
    groupSlicerState.selectedGroup = normalizedValue;
    syncGroupSlicerSelection(document.getElementById('salesGroupFilter'), normalizedValue);
    syncGroupSlicerSelection(document.getElementById('dashboardGroupFilter'), normalizedValue);
    syncGroupSlicerSelection(document.getElementById('customerGroupFilter'), normalizedValue);
    applySalesFilters();
    applyCustomerFilters();
    applySalesDashboardFilters();
}

function renderGroupSlicer(groups = []) {
    const panel = document.getElementById('groupSlicerPanel');
    const buttonsEl = document.getElementById('groupSlicerButtons');
    if (!panel || !buttonsEl) {
        return;
    }
    const shouldShow = activeView === 'salesDashboard';
    if (!Array.isArray(groups) || groups.length === 0 || !shouldShow || !groupSlicerState.open) {
        panel.style.display = 'none';
        buttonsEl.innerHTML = '';
        return;
    }
    panel.style.display = 'block';
    const current = groupSlicerState.selectedGroup;
    const safeButtons = groups.slice(0, 80).map(group => {
        const safe = escapeHtml(group);
        const isActive = current === group;
        return `<button data-group="${safe}" class="${isActive ? 'active' : ''}">${safe}</button>`;
    }).join('');
    const allActive = !current;
    buttonsEl.innerHTML = `
        <button data-group="" class="${allActive ? 'active' : ''}" style="background:${allActive ? '#0ea5e9' : '#f1f5f9'};color:${allActive ? '#fff' : '#0f172a'}">All groups</button>
        ${safeButtons}`;
    buttonsEl.querySelectorAll('button').forEach(btn => {
        btn.onclick = () => applyGroupSlicerSelection(btn.getAttribute('data-group') || null);
    });
}

function populateSalesFilters() {
    const { normalized, meta } = ensureSalesDataNormalized();

    const divisionSelect = document.getElementById('salesDivisionFilter');
    const groupSelect = document.getElementById('salesGroupFilter');
    const businessCoSelect = document.getElementById('salesBusinessCoFilter');

    if (!normalized.length) {
        if (divisionSelect) {
            setMultiSelectOptions(divisionSelect, [], 'All Sales Divisions');
        }
        if (groupSelect) {
            setMultiSelectOptions(groupSelect, [], 'All Sales Groups (Code + Name)');
        }
        if (businessCoSelect) {
            setSingleSelectOptions(businessCoSelect, [], 'All CSC Names');
        }
        renderGroupSlicer([]);
        return;
    }

    setMultiSelectOptions(divisionSelect, meta.divisions, 'All Sales Divisions');
    setMultiSelectOptions(groupSelect, meta.salesGroups, 'All Sales Groups (Code + Name)');
    setSingleSelectOptions(businessCoSelect, meta.businessCos, 'All CSC Names');
    renderGroupSlicer(meta.salesGroups);
}

function populateCustomerFilters() {
    const { normalized, meta } = ensureCustomerDataNormalized();

    const divisionSelect = document.getElementById('customerDivisionFilter');
    const groupSelect = document.getElementById('customerGroupFilter');
    const businessCoSelect = document.getElementById('customerBusinessCoFilter');

    if (!normalized.length) {
        if (divisionSelect) {
            setMultiSelectOptions(divisionSelect, [], 'All Divisions');
        }
        if (groupSelect) {
            setMultiSelectOptions(groupSelect, [], 'All Groups');
        }
        if (businessCoSelect) {
            setMultiSelectOptions(businessCoSelect, [], 'All Business Co');
        }
        return;
    }

    setMultiSelectOptions(divisionSelect, meta.divisions, 'All Divisions');
    setMultiSelectOptions(groupSelect, meta.salesGroups, 'All Groups');
    setMultiSelectOptions(businessCoSelect, meta.businessCodes, 'All Business Co');
}

function populatePricingFilters() {
    const { normalized, meta } = ensureProductDataNormalized();

    const divisionSelect = document.getElementById('pricingDivisionFilter');
    const sectorSelect = document.getElementById('pricingSectorFilter');
    const repSelect = document.getElementById('pricingRepFilter');
    const powerSelect = document.getElementById('pricingPowerFilter');

    if (!normalized.length) {
        setMultiSelectOptions(divisionSelect, [], 'All Sales Sector 2');
        setMultiSelectOptions(sectorSelect, [], 'All Sales Areas');
        setMultiSelectOptions(repSelect, [], 'All Reps');
        if (powerSelect) {
            powerSelect.value = '';
        }
        return;
    }

    setMultiSelectOptions(divisionSelect, meta.salesSectors, 'All Sales Sector 2');
    setMultiSelectOptions(sectorSelect, meta.salesGroups, 'All Sales Areas');
    setMultiSelectOptions(repSelect, meta.salesReps, 'All Reps');
    if (powerSelect && !powerSelect.value) {
        powerSelect.value = '';
    }
}

function toggleGroupSlicerDropdown() {
    groupSlicerState.open = !groupSlicerState.open;
    renderGroupSlicer((salesNormalizationState.meta && Array.isArray(salesNormalizationState.meta.salesGroups)) ? salesNormalizationState.meta.salesGroups : []);
}

function filterProductDataset(dataset = [], filters = {}) {
    const search = (filters.productSearch || '').toLowerCase();
    return dataset.filter(entry => {
        // division filter represents Sales Sector 2
        if (!matchesMultiFilter(filters.division, entry.salesSector2)) {
            return false;
        }
        // sector filter represents Sales Area / sales group
        if (!matchesMultiFilter(filters.sector, entry.salesGroup)) {
            return false;
        }
        if (!matchesMultiFilter(filters.reps, entry.salesRep)) {
            return false;
        }
        if (filters.power === 'yes' && !entry.powerProduct) {
            return false;
        }
        if (filters.power === 'no' && entry.powerProduct) {
            return false;
        }
        if (search) {
            const name = (entry.productName || '').toLowerCase();
            const code = (entry.productCode || '').toLowerCase();
            if (!name.includes(search) && !code.includes(search)) {
                return false;
            }
        }
        return true;
    });
}

function buildProductAnalytics(dataset = []) {
    const productMap = new Map();
    const sectorMap = new Map();
    const repAggMap = new Map();
    let totalTurnover = 0;
    let totalGrossProfit = 0;
    let totalUnits = 0;
    let powerTurnover = 0;

    dataset.forEach(entry => {
        const productKey = `${(entry.productCode || '').toLowerCase()}|${(entry.productName || '').toLowerCase()}`;
        const label = entry.productLabel || entry.productName || entry.productCode || 'Unspecified Product';
        if (!productMap.has(productKey)) {
            productMap.set(productKey, {
                label,
                productName: entry.productName || label,
                productCode: entry.productCode || '',
                productCategory: entry.productCategory || '',
                salesSector: entry.salesSector2 || 'Unspecified',
                turnover: 0,
                grossProfit: 0,
                units: 0,
                orders: 0,
                powerProduct: false,
                repBreakdown: new Map(),
                divisions: new Set()
            });
        }

        const product = productMap.get(productKey);
        product.turnover += entry.turnover;
        product.grossProfit += entry.grossProfit || 0;
        product.units += entry.units || 0;
        product.orders += entry.orderLines || entry.units || 0;
        product.salesSector = entry.salesSector2 || product.salesSector;
        product.productCategory = entry.productCategory || product.productCategory;
        product.powerProduct = product.powerProduct || !!entry.powerProduct;
        if (entry.division) {
            product.divisions.add(entry.division);
        }

        const repKey = entry.salesRep || 'Unassigned';
        if (!product.repBreakdown.has(repKey)) {
            product.repBreakdown.set(repKey, {
                rep: repKey,
                repCode: entry.repCode || '',
                turnover: 0,
                grossProfit: 0,
                units: 0,
                targetAmount: 0,
                stillNeededAmount: 0,
                salesSector: entry.salesSector2 || product.salesSector,
                division: entry.division || ''
            });
        }
        const repStats = product.repBreakdown.get(repKey);
        repStats.turnover += entry.turnover;
        repStats.grossProfit += entry.grossProfit || 0;
        repStats.units += entry.units || 0;
        repStats.targetAmount += Number.isFinite(entry.target) ? entry.target : 0;
        repStats.stillNeededAmount += Number.isFinite(entry.stillNeeded) ? entry.stillNeeded : 0;
        repStats.salesSector = entry.salesSector2 || repStats.salesSector;
        if (entry.repCode && !repStats.repCode) {
            repStats.repCode = entry.repCode;
        }
        if (entry.division) {
            repStats.division = entry.division;
        }

        if (!repAggMap.has(repKey)) {
            repAggMap.set(repKey, {
                rep: repKey,
                repCode: entry.repCode || '',
                turnover: 0,
                grossProfit: 0,
                units: 0,
                targetAmount: 0,
                stillNeededAmount: 0,
                salesSector: entry.salesSector2 || product.salesSector,
                division: entry.division || ''
            });
        }
        const repAgg = repAggMap.get(repKey);
        repAgg.turnover += entry.turnover;
        repAgg.grossProfit += entry.grossProfit || 0;
        repAgg.units += entry.units || 0;
        repAgg.targetAmount += Number.isFinite(entry.target) ? entry.target : 0;
        repAgg.stillNeededAmount += Number.isFinite(entry.stillNeeded) ? entry.stillNeeded : 0;
        if (entry.repCode && !repAgg.repCode) {
            repAgg.repCode = entry.repCode;
        }
        if (entry.salesSector2 && !repAgg.salesSector) {
            repAgg.salesSector = entry.salesSector2;
        }
        if (entry.division && !repAgg.division) {
            repAgg.division = entry.division;
        }

        totalTurnover += entry.turnover;
        totalGrossProfit += entry.grossProfit || 0;
        totalUnits += entry.units || entry.orderLines || 0;
        if (entry.powerProduct) {
            powerTurnover += entry.turnover;
        }

        const sectorKey = entry.salesSector2 || 'Unspecified';
        if (!sectorMap.has(sectorKey)) {
            sectorMap.set(sectorKey, { turnover: 0, grossProfit: 0, units: 0 });
        }
        const sector = sectorMap.get(sectorKey);
        sector.turnover += entry.turnover;
        sector.grossProfit += entry.grossProfit || 0;
        sector.units += entry.units || 0;
    });

    const topProducts = Array.from(productMap.values())
        .map(p => Object.assign({}, p, {
            margin: p.turnover ? (p.grossProfit / p.turnover) * 100 : null,
            divisions: Array.from(p.divisions)
        }))
        .sort((a, b) => b.turnover - a.turnover);

    const powerProducts = topProducts.filter(p => p.powerProduct);

    const repProductRows = Array.from(repAggMap.values()).map(repStats => {
        const actualTurnover = repStats.turnover || 0;
        const targetFromFile = Number.isFinite(repStats.targetAmount) ? repStats.targetAmount : 0;
        const inferredTarget = targetFromFile || (Number.isFinite(repStats.stillNeededAmount) ? actualTurnover + repStats.stillNeededAmount : 0);
        const remaining = inferredTarget ? inferredTarget - actualTurnover : (Number.isFinite(repStats.stillNeededAmount) ? repStats.stillNeededAmount : 0);
        const achievedPct = inferredTarget ? (actualTurnover / inferredTarget) * 100 : null;
        return {
            rep: repStats.rep,
            repCode: repStats.repCode || 'â€”',
            sector: repStats.salesSector || 'Unspecified',
            division: repStats.division || 'Unassigned',
            turnover: repStats.turnover,
            grossProfit: repStats.grossProfit,
            margin: repStats.turnover ? (repStats.grossProfit / repStats.turnover) * 100 : null,
            units: repStats.units || 0,
            targetAmount: inferredTarget,
            remaining,
            achievedPct
        };
    });
    repProductRows.sort((a, b) => b.turnover - a.turnover);

    const totalTargetAmount = repProductRows.reduce((acc, row) => acc + (Number.isFinite(row.targetAmount) ? row.targetAmount : 0), 0);
    const totalRemaining = repProductRows.reduce((acc, row) => acc + (Number.isFinite(row.remaining) ? row.remaining : 0), 0);
    const overallAchievedPct = totalTargetAmount ? (totalTurnover / totalTargetAmount) * 100 : null;

    const prioritySectors = ['Metal', 'Cargo', 'Construction', 'Auto'];
    const sectorMix = Array.from(sectorMap.entries()).map(([name, stats]) => ({
        name,
        turnover: stats.turnover,
        grossProfit: stats.grossProfit,
        margin: stats.turnover ? (stats.grossProfit / stats.turnover) * 100 : null,
        units: stats.units
    })).sort((a, b) => {
        const aIndex = prioritySectors.findIndex(s => a.name.toLowerCase().includes(s.toLowerCase()));
        const bIndex = prioritySectors.findIndex(s => b.name.toLowerCase().includes(s.toLowerCase()));
        if (aIndex !== bIndex) {
            const safeA = aIndex === -1 ? prioritySectors.length : aIndex;
            const safeB = bIndex === -1 ? prioritySectors.length : bIndex;
            return safeA - safeB;
        }
        return b.turnover - a.turnover;
    });

    return {
        totalTurnover,
        totalGrossProfit,
        totalUnits,
        totalProducts: productMap.size,
        powerProductsCount: powerProducts.length,
        powerShare: totalTurnover > 0 ? (powerTurnover / totalTurnover) * 100 : null,
        topProducts,
        powerProducts,
        repProductRows,
        sectorMix,
        totalTargetAmount,
        totalRemaining,
        overallAchievedPct
    };
}

function renderProductView() {
    const contentEl = document.getElementById('pricingContent');
    if (!contentEl) {
        return;
    }

    const { normalized, meta } = ensureProductDataNormalized();

    if (!Array.isArray(normalized) || normalized.length === 0) {
        contentEl.innerHTML = '<p style="color:#6b7280;text-align:center;padding:28px">Upload pricing/product data in Master Data to see product performance, rep views, and power product insights.</p>';
        return;
    }

    const filtered = filterProductDataset(normalized, productFilterState).filter(entry => entry.powerProduct);
    if (filtered.length === 0) {
        contentEl.innerHTML = '<p style="color:#6b7280;text-align:center;padding:28px">No power products match the current filters. Upload or select entries flagged as power products to view results.</p>';
        return;
    }

    const analytics = buildProductAnalytics(filtered);
    const overallMargin = analytics.totalTurnover ? (analytics.totalGrossProfit / analytics.totalTurnover) * 100 : null;
    const summaryCards = [
        { label: 'Turnover (Power)', value: formatSalesCurrency(analytics.totalTurnover), accent: '#0ea5e9' },
        { label: 'Gross Profit', value: formatSalesCurrency(analytics.totalGrossProfit), accent: '#10b981' },
        { label: 'GP %', value: overallMargin !== null ? `${overallMargin.toFixed(1)}%` : 'â€”', accent: '#f59e0b' },
        { label: 'Target (Turnover)', value: analytics.totalTargetAmount ? formatSalesCurrency(analytics.totalTargetAmount) : 'â€”', accent: '#6366f1' },
        { label: 'Remaining', value: analytics.totalRemaining ? formatSalesCurrency(analytics.totalRemaining) : 'â€”', accent: '#ef4444' },
        { label: '% Achieved', value: analytics.overallAchievedPct !== null ? `${analytics.overallAchievedPct.toFixed(1)}%` : 'â€”', accent: '#0ea5e9' }
    ];

    const formatProductLine = (p) => {
        const margin = p.margin !== null ? `${p.margin.toFixed(1)}%` : 'â€”';
        const label = p.productName || p.label || 'Product';
        return `<li style="margin-bottom:10px">
            <div style="font-weight:700;color:#0f172a">${escapeHtml(label)}</div>
            <div style="color:#64748b;font-size:12px">${escapeHtml(p.salesSector || 'Unspecified')} Â· ${formatSalesCurrency(p.turnover)} Â· GP ${formatSalesCurrency(p.grossProfit)} (${margin})</div>
        </li>`;
    };

    const topProductsHtml = analytics.topProducts.slice(0, 6).map(formatProductLine).join('');
    const powerProductsHtml = analytics.powerProducts.slice(0, 6).map(formatProductLine).join('');

    const sectorRows = analytics.sectorMix.map(sector => {
        const margin = sector.margin !== null ? `${sector.margin.toFixed(1)}%` : 'â€”';
        return `<tr>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0">${escapeHtml(sector.name || 'Unspecified')}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;font-weight:600;color:#0f172a">${formatSalesCurrency(sector.turnover)}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;color:#059669;font-weight:600">${formatSalesCurrency(sector.grossProfit)}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;color:#475569">${margin}</td>
        </tr>`;
    }).join('');

    productTableState.rows = analytics.repProductRows;
    productTableState.totalRows = analytics.repProductRows.length;
    productTableState.visibleRows = Math.min(productTableState.visibleRows, productTableState.totalRows);

    const repRows = analytics.repProductRows.slice(0, productTableState.visibleRows).map(row => {
        const margin = row.margin !== null ? `${row.margin.toFixed(1)}%` : 'â€”';
        const remainingColor = row.remaining < 0 ? '#ef4444' : (row.remaining > 0 ? '#10b981' : '#475569');
        return `<tr>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0">${escapeHtml(row.division || 'Unassigned')}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0">${escapeHtml(row.sector || 'Unspecified')}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;color:#475569">${escapeHtml(row.repCode || 'â€”')}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0">${escapeHtml(row.rep)}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;font-weight:600;color:#0f172a">${formatSalesCurrency(row.turnover)}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;color:#475569">${margin}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;color:#475569">${(row.units || 0).toLocaleString('en-ZA')}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;color:#0f172a;font-weight:600">${Number.isFinite(row.targetAmount) ? formatSalesCurrency(row.targetAmount) : 'â€”'}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;font-weight:600;color:${remainingColor}">${Number.isFinite(row.remaining) ? formatSalesCurrency(row.remaining) : 'â€”'}</td>
            <td style="padding:8px 10px;border-bottom:1px solid #e2e8f0;text-align:right;color:#0ea5e9;font-weight:700">${row.achievedPct !== null && row.achievedPct !== undefined ? `${row.achievedPct.toFixed(1)}%` : 'â€”'}</td>
        </tr>`;
    }).join('');

    const pivotDivisionSelected = productFilterState.division[0] || '';
    const pivotGroupSelected = productFilterState.sector[0] || '';
    const pivotRepSelected = productFilterState.reps[0] || '';

    const pivotControlsHtml = `
        <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px">
            <div style="flex:1;min-width:180px">
                <label style="display:block;font-size:12px;color:#475569;margin-bottom:4px">Sales Sector 2</label>
                <select id="pivotDivisionSelect" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px">
                    <option value="">All Sales Sector 2</option>
                    ${(meta.salesSectors || []).map(sec => `<option value="${escapeHtml(sec)}" ${sec === pivotDivisionSelected ? 'selected' : ''}>${escapeHtml(sec)}</option>`).join('')}
                </select>
            </div>
            <div style="flex:1;min-width:180px">
                <label style="display:block;font-size:12px;color:#475569;margin-bottom:4px">Sales Area</label>
                <select id="pivotGroupSelect" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px">
                    <option value="">All Sales Areas</option>
                    ${(meta.salesGroups || []).map(sec => `<option value="${escapeHtml(sec)}" ${sec === pivotGroupSelected ? 'selected' : ''}>${escapeHtml(sec)}</option>`).join('')}
                </select>
            </div>
            <div style="flex:1;min-width:180px">
                <label style="display:block;font-size:12px;color:#475569;margin-bottom:4px">Sales Rep</label>
                <select id="pivotRepSelect" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px">
                    <option value="">All Reps</option>
                    ${(meta.salesReps || []).map(rep => `<option value="${escapeHtml(rep)}" ${rep === pivotRepSelected ? 'selected' : ''}>${escapeHtml(rep)}</option>`).join('')}
                </select>
            </div>
            <button onclick="applyProductPivot()" style="background:linear-gradient(135deg,#0ea5e9,#2563eb);color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:700;box-shadow:0 6px 18px rgba(37,99,235,0.18)">Pivot / Apply</button>
        </div>`;

    contentEl.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
            ${summaryCards.map(card => `
                <div style="position:relative;background:linear-gradient(135deg,${card.accent}1A,#ffffff);border:1px solid #e2e8f0;border-radius:12px;padding:14px;overflow:hidden">
                    <div style="font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">${escapeHtml(card.label)}</div>
                    <div style="font-size:20px;font-weight:800;color:#0f172a">${escapeHtml(String(card.value))}</div>
                </div>
            `).join('')}
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h4 style="margin:0;font-size:15px;color:#0f172a">Top products (turnover)</h4>
                    <span style="color:#64748b;font-size:12px">Showing ${Math.min(analytics.topProducts.length, 6)} of ${analytics.topProducts.length}</span>
                </div>
                <ul style="margin:0;padding-left:18px;color:#0f172a;font-size:13px">${topProductsHtml}</ul>
            </div>

            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h4 style="margin:0;font-size:15px;color:#0f172a">Power products spotlight</h4>
                    <span style="color:#64748b;font-size:12px">${analytics.powerProductsCount.toLocaleString('en-ZA')} flagged "Yes"</span>
                </div>
                ${powerProductsHtml ? `<ul style="margin:0;padding-left:18px;color:#0f172a;font-size:13px">${powerProductsHtml}</ul>` : '<p style="margin:0;color:#6b7280;font-size:13px">No products flagged "Yes" as power product yet.</p>'}
            </div>

            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h4 style="margin:0;font-size:15px;color:#0f172a">Division / Sector mix</h4>
                    <span style="color:#64748b;font-size:12px">Metal, Cargo, Construction, Auto highlighted</span>
                </div>
                <div style="overflow-x:auto">
                    <table style="border-collapse:collapse;width:100%">
                        <thead>
                            <tr style="background:#f8fafc;color:#475569;font-size:12px">
                                <th style="padding:8px 10px;text-align:left">Sector</th>
                                <th style="padding:8px 10px;text-align:right">Turnover</th>
                                <th style="padding:8px 10px;text-align:right">Gross Profit</th>
                                <th style="padding:8px 10px;text-align:right">GP %</th>
                            </tr>
                        </thead>
                        <tbody>${sectorRows}</tbody>
                    </table>
                </div>
            </div>
        </div>

        <div style="margin-top:4px">${pivotControlsHtml}</div>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px">
                <h4 style="margin:0;font-size:15px;color:#0f172a">Product performance by rep</h4>
                <span style="color:#64748b;font-size:12px">Showing ${Math.min(productTableState.visibleRows, productTableState.totalRows)} of ${productTableState.totalRows}</span>
            </div>
            <div style="overflow-x:auto">
                <table style="border-collapse:collapse;width:100%;min-width:720px">
                    <thead>
                        <tr style="background:#f8fafc;color:#475569;font-size:12px">
                            <th style="padding:8px 10px;text-align:left">Division</th>
                            <th style="padding:8px 10px;text-align:left">Sector</th>
                            <th style="padding:8px 10px;text-align:left">Rep Code</th>
                            <th style="padding:8px 10px;text-align:left">Sales Rep</th>
                            <th style="padding:8px 10px;text-align:right">Turnover</th>
                            <th style="padding:8px 10px;text-align:right">GP %</th>
                            <th style="padding:8px 10px;text-align:right">Units/Lines</th>
                            <th style="padding:8px 10px;text-align:right">Target (sum)</th>
                            <th style="padding:8px 10px;text-align:right">Remaining</th>
                            <th style="padding:8px 10px;text-align:right">% Achieved</th>
                        </tr>
                    </thead>
                    <tbody>${repRows}</tbody>
                </table>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px;flex-wrap:wrap">
                <button onclick="loadMoreProductRows()" style="background:#0ea5e9;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:700;${productTableState.visibleRows < productTableState.totalRows ? '' : 'display:none;'}">Load more</button>
                <button onclick="exportProductRepCsv()" style="background:#10b981;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:700">Export (CSV)</button>
            </div>
        </div>
    `;
}

function applySalesFilters() {
    const { normalized } = ensureSalesDataNormalized();
    if (!normalized.length) {
        renderSalesView([], { emptyMessage: 'No sales data available.' });
        return;
    }

    const dateFromValue = document.getElementById('salesDateFrom')?.value;
    const dateToValue = document.getElementById('salesDateTo')?.value;
    const divisionValues = getMultiSelectValues(document.getElementById('salesDivisionFilter'));
    const groupValues = getMultiSelectValues(document.getElementById('salesGroupFilter'));
    const businessCoValue = document.getElementById('salesBusinessCoFilter')?.value || '';

    groupSlicerState.selectedGroup = groupValues.length === 1 ? groupValues[0] : null;
    renderGroupSlicer((salesNormalizationState.meta && Array.isArray(salesNormalizationState.meta.salesGroups)) ? salesNormalizationState.meta.salesGroups : []);

    const dateFrom = dateFromValue ? new Date(dateFromValue) : null;
    const dateTo = dateToValue ? new Date(dateToValue) : null;

    const filtered = normalized.filter(entry => {
        if (dateFrom && (!entry.date || entry.date < dateFrom)) {
            return false;
        }
        if (dateTo && (!entry.date || entry.date > dateTo)) {
            return false;
        }
        if (!matchesMultiFilter(divisionValues, entry.division)) {
            return false;
        }
        if (!matchesMultiFilter(groupValues, entry.salesGroup)) {
            return false;
        }
        if (businessCoValue && entry.businessCo !== businessCoValue) {
            return false;
        }
        return true;
    });

    const targetFilters = {
        division: divisionValues,
        salesGroup: groupValues
    };
    if (dateFrom instanceof Date && !Number.isNaN(dateFrom.getTime())) {
        targetFilters.dateFrom = dateFrom;
    }
    if (dateTo instanceof Date && !Number.isNaN(dateTo.getTime())) {
        targetFilters.dateTo = dateTo;
    }

    renderSalesView(filtered, {
        contextLabel: 'Filtered',
        emptyMessage: 'No data matches the selected filters.',
        targetFilters
    });
}

function clearSalesFilters() {
    const dateFrom = document.getElementById('salesDateFrom');
    const dateTo = document.getElementById('salesDateTo');
    const divisionSelect = document.getElementById('salesDivisionFilter');
    const groupSelect = document.getElementById('salesGroupFilter');
    const businessCoSelect = document.getElementById('salesBusinessCoFilter');

    if (dateFrom) dateFrom.value = '';
    if (dateTo) dateTo.value = '';
    clearMultiSelect(divisionSelect);
    clearMultiSelect(groupSelect);
    if (businessCoSelect) {
        businessCoSelect.value = '';
    }

    updateSalesDisplay();
}

// Customer filter functions (similar structure)
function applyCustomerFilters() {
    const { normalized } = ensureCustomerDataNormalized();
    if (!normalized.length) {
        updateCustomerDisplay([]);
        return;
    }

    const dateFromValue = document.getElementById('customerDateFrom')?.value;
    const dateToValue = document.getElementById('customerDateTo')?.value;
    const divisionValues = getMultiSelectValues(document.getElementById('customerDivisionFilter'));
    const groupValues = getMultiSelectValues(document.getElementById('customerGroupFilter'));
    const businessCoValues = getMultiSelectValues(document.getElementById('customerBusinessCoFilter'));

    groupSlicerState.selectedGroup = groupValues.length === 1 ? groupValues[0] : groupSlicerState.selectedGroup;
    renderGroupSlicer((salesNormalizationState.meta && Array.isArray(salesNormalizationState.meta.salesGroups)) ? salesNormalizationState.meta.salesGroups : []);

    const parsedDateFrom = dateFromValue ? new Date(dateFromValue) : null;
    const dateFrom = parsedDateFrom instanceof Date && !Number.isNaN(parsedDateFrom.getTime())
        ? new Date(parsedDateFrom.getFullYear(), parsedDateFrom.getMonth(), parsedDateFrom.getDate())
        : null;
    const parsedDateTo = dateToValue ? new Date(dateToValue) : null;
    const inclusiveDateTo = parsedDateTo instanceof Date && !Number.isNaN(parsedDateTo.getTime())
        ? new Date(parsedDateTo.getFullYear(), parsedDateTo.getMonth(), parsedDateTo.getDate() + 1)
        : null;

    const filtered = normalized.filter(entry => {
        const entryDate = entry.lastOrderDate instanceof Date && !Number.isNaN(entry.lastOrderDate.getTime())
            ? entry.lastOrderDate
            : null;
        if (dateFrom && (!entryDate || entryDate < dateFrom)) {
            return false;
        }
        if (inclusiveDateTo && (!entryDate || entryDate >= inclusiveDateTo)) {
            return false;
        }
        if (!matchesMultiFilter(divisionValues, entry.division)) {
            return false;
        }
        if (!matchesMultiFilter(groupValues, entry.salesGroupDisplay)) {
            return false;
        }
        if (!matchesMultiFilter(businessCoValues, entry.businessCode)) {
            return false;
        }
        return true;
    });

    const badges = [];
    if (dateFromValue) {
        badges.push(`From ${dateFromValue}`);
    }
    if (dateToValue) {
        badges.push(`To ${dateToValue}`);
    }
    if (divisionValues.length > 0) {
        badges.push(`${divisionValues.length} division${divisionValues.length === 1 ? '' : 's'}`);
    }
    if (groupValues.length > 0) {
        badges.push(`${groupValues.length} group${groupValues.length === 1 ? '' : 's'}`);
    }
    if (businessCoValues.length > 0) {
        badges.push(`${businessCoValues.length} business code${businessCoValues.length === 1 ? '' : 's'}`);
    }

    updateCustomerDisplay(filtered, {
        contextLabel: badges.length > 0 ? 'Filtered' : 'Overall',
        filterBadges: badges,
        emptyMessage: 'No customer records match the selected filters.'
    });
}

function clearCustomerFilters() {
    const dateFrom = document.getElementById('customerDateFrom');
    const dateTo = document.getElementById('customerDateTo');
    if (dateFrom) dateFrom.value = '';
    if (dateTo) dateTo.value = '';
    clearMultiSelect(document.getElementById('customerDivisionFilter'));
    clearMultiSelect(document.getElementById('customerGroupFilter'));
    clearMultiSelect(document.getElementById('customerBusinessCoFilter'));
    updateCustomerDisplay();
}

// Navigation
const reportTiles = document.querySelectorAll('[data-open]');
reportTiles.forEach(tile => {
tile.addEventListener('click', () => {
reportTiles.forEach(t => t.classList.toggle('selected', t === tile));
showView(tile.dataset.open);
});
});

function showView(id) {
document.querySelectorAll('.view').forEach(v => v.style.display = v.id === id ? 'block' : 'none');
activeView = id;
if (id === 'home') {
reportTiles.forEach(t => t.classList.remove('selected'));
} else if (id === 'sales') {
updateSalesDisplay();
populateSalesFilters();
} else if (id === 'customers') {
updateCustomerDisplay();
populateCustomerFilters();
} else if (id === 'pricing') {
populatePricingFilters();
productTableState.visibleRows = PRODUCT_TABLE_DEFAULT_ROWS;
renderProductView();
} else if (id === 'salesDashboard' || id === 'dashboard') {
initializeSalesDashboardFilters();
updateSalesDashboard();
}
renderGroupSlicer((salesNormalizationState.meta && Array.isArray(salesNormalizationState.meta.salesGroups)) ? salesNormalizationState.meta.salesGroups : []);
}

// File input listener
document.getElementById('unifiedFileInput').addEventListener('change', function(e) {
const file = e.target.files[0];
const info = document.getElementById('fileSelectedInfo');
info.textContent = file ? `ğŸ“ ${file.name} selected` : 'ğŸ“ No file chosen';
});

// Data type change listener
document.getElementById('uploadDataType').addEventListener('change', function() {
    updateDataCount();
});

// Initialize data count on page load
document.addEventListener('DOMContentLoaded', function() {
    updateDataCount();
});

// Additional filter functions for all sections
function toggleStockFilters() {
    const filters = document.getElementById('stockFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

function togglePricingFilters() {
    const filters = document.getElementById('pricingFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

function toggleFinancialFilters() {
    const filters = document.getElementById('financialFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

function toggleKpiFilters() {
    const filters = document.getElementById('kpiFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

function toggleSalesDashboardFilters() {
    const filters = document.getElementById('salesDashboardFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// Stock filter functions
function applyStockFilters() {
    console.log('Applying stock filters...');
    // Implementation for filtering stock data
}

function clearStockFilters() {
    clearMultiSelect(document.getElementById('stockCategoryFilter'));
    clearMultiSelect(document.getElementById('stockSupplierFilter'));
    clearMultiSelect(document.getElementById('stockLevelFilter'));
}

// Pricing filter functions
function applyPricingFilters() {
    productFilterState.division = getMultiSelectValues(document.getElementById('pricingDivisionFilter'));
    productFilterState.sector = getMultiSelectValues(document.getElementById('pricingSectorFilter'));
    productFilterState.reps = getMultiSelectValues(document.getElementById('pricingRepFilter'));
    const powerSelect = document.getElementById('pricingPowerFilter');
    productFilterState.power = powerSelect ? powerSelect.value : '';
    const searchInput = document.getElementById('pricingProductSearch');
    productFilterState.productSearch = searchInput ? searchInput.value.trim() : '';
    productTableState.visibleRows = PRODUCT_TABLE_DEFAULT_ROWS;
    renderProductView();
}

function clearPricingFilters() {
    clearMultiSelect(document.getElementById('pricingDivisionFilter'));
    clearMultiSelect(document.getElementById('pricingSectorFilter'));
    clearMultiSelect(document.getElementById('pricingRepFilter'));
    const powerSelect = document.getElementById('pricingPowerFilter');
    if (powerSelect) {
        powerSelect.value = '';
    }
    const searchInput = document.getElementById('pricingProductSearch');
    if (searchInput) {
        searchInput.value = '';
    }
    productFilterState.division = [];
    productFilterState.sector = [];
    productFilterState.reps = [];
    productFilterState.power = '';
    productFilterState.productSearch = '';
    productTableState.visibleRows = PRODUCT_TABLE_DEFAULT_ROWS;
    renderProductView();
}

function applyProductPivot() {
    const divSelect = document.getElementById('pivotDivisionSelect');
    const sectorSelect = document.getElementById('pivotGroupSelect');
    const repSelect = document.getElementById('pivotRepSelect');

    productFilterState.division = divSelect && divSelect.value ? [divSelect.value] : [];
    productFilterState.sector = sectorSelect && sectorSelect.value ? [sectorSelect.value] : [];
    productFilterState.reps = repSelect && repSelect.value ? [repSelect.value] : [];

    // Keep the main filter selects aligned with the pivot choices
    const pricingDivisionFilter = document.getElementById('pricingDivisionFilter');
    const pricingSectorFilter = document.getElementById('pricingSectorFilter');
    const pricingRepFilter = document.getElementById('pricingRepFilter');
    if (pricingDivisionFilter) {
        Array.from(pricingDivisionFilter.options).forEach(opt => {
            opt.selected = productFilterState.division.includes(opt.value);
        });
    }
    if (pricingSectorFilter) {
        Array.from(pricingSectorFilter.options).forEach(opt => {
            opt.selected = productFilterState.sector.includes(opt.value);
        });
    }
    if (pricingRepFilter) {
        Array.from(pricingRepFilter.options).forEach(opt => {
            opt.selected = productFilterState.reps.includes(opt.value);
        });
    }

    productTableState.visibleRows = PRODUCT_TABLE_DEFAULT_ROWS;
    renderProductView();
}

// Financial filter functions
function applyFinancialFilters() {
    console.log('Applying financial filters...');
    // Implementation for filtering financial data
}

function clearFinancialFilters() {
    document.getElementById('financialDateFrom').value = '';
    document.getElementById('financialDateTo').value = '';
    clearMultiSelect(document.getElementById('financialDepartmentFilter'));
    clearMultiSelect(document.getElementById('financialAmountFilter'));
}

// KPI filter functions
function applyKpiFilters() {
    console.log('Applying KPI filters...');
    // Implementation for filtering KPI data
}

function clearKpiFilters() {
    document.getElementById('kpiDateFrom').value = '';
    document.getElementById('kpiDateTo').value = '';
    clearMultiSelect(document.getElementById('kpiDepartmentFilter'));
    clearMultiSelect(document.getElementById('kpiPerformanceFilter'));
}

// Sales Dashboard filter functions
// Sales Dashboard filter functions with dropdown functionality
let activeDashboardFilters = {
    division: [],
    salesGroup: [],
    salesRep: '',
    performance: '',
    turnover: '',
    dateFrom: '',
    dateTo: ''
};

function applySalesDashboardFilters() {
    const dateFromInput = document.getElementById('dashboardDateFrom');
    const dateToInput = document.getElementById('dashboardDateTo');
    const divisionSelect = document.getElementById('dashboardDivisionFilter');
    const groupSelect = document.getElementById('dashboardGroupFilter');
    const salesRepSelect = document.getElementById('dashboardSalesRepFilter');
    const performanceSelect = document.getElementById('dashboardPerformanceFilter');
    const turnoverSelect = document.getElementById('dashboardTurnoverFilter');

    activeDashboardFilters.dateFrom = dateFromInput ? dateFromInput.value : '';
    activeDashboardFilters.dateTo = dateToInput ? dateToInput.value : '';
    activeDashboardFilters.division = getMultiSelectValues(divisionSelect);
    activeDashboardFilters.salesGroup = getMultiSelectValues(groupSelect);
    activeDashboardFilters.salesRep = salesRepSelect ? salesRepSelect.value : '';
    activeDashboardFilters.performance = performanceSelect ? performanceSelect.value : '';
    activeDashboardFilters.turnover = turnoverSelect ? turnoverSelect.value : '';

    groupSlicerState.selectedGroup = activeDashboardFilters.salesGroup.length === 1 ? activeDashboardFilters.salesGroup[0] : null;
    renderGroupSlicer((salesNormalizationState.meta && Array.isArray(salesNormalizationState.meta.salesGroups)) ? salesNormalizationState.meta.salesGroups : []);

    let activeCount = 0;
    if (activeDashboardFilters.dateFrom) activeCount += 1;
    if (activeDashboardFilters.dateTo) activeCount += 1;
    ['division', 'salesGroup', 'salesRep', 'performance', 'turnover'].forEach(key => {
        const value = activeDashboardFilters[key];
        if (Array.isArray(value) && value.length > 0) {
            activeCount += 1;
        } else if (!Array.isArray(value) && value) {
            activeCount += 1;
        }
    });

    const button = document.querySelector('button[onclick="applySalesDashboardFilters()"]');
    if (button) {
        if (activeCount > 0) {
            button.innerHTML = `âœ… ${activeCount} Filter${activeCount > 1 ? 's' : ''} Applied`;
            button.style.background = 'linear-gradient(135deg,#059669,#10b981)';
        } else {
            button.innerHTML = 'âœ¨ Apply Filters';
            button.style.background = 'linear-gradient(135deg,#059669,#10b981)';
        }
    }

    updateDashboardWithFilters();
}

function clearSalesDashboardFilters() {
    // Reset all filter values
    activeDashboardFilters = {
        division: [],
        salesRep: '',
        performance: '',
        turnover: '',
        salesGroup: [],
        dateFrom: '',
        dateTo: ''
    };
    
    // Clear all dropdown selections
    const dateFromInput = document.getElementById('dashboardDateFrom');
    const dateToInput = document.getElementById('dashboardDateTo');
    if (dateFromInput) dateFromInput.value = '';
    if (dateToInput) dateToInput.value = '';
    clearMultiSelect(document.getElementById('dashboardDivisionFilter'));
    clearMultiSelect(document.getElementById('dashboardGroupFilter'));
    const salesRepSelect = document.getElementById('dashboardSalesRepFilter');
    if (salesRepSelect) salesRepSelect.value = '';
    const performanceSelect = document.getElementById('dashboardPerformanceFilter');
    if (performanceSelect) performanceSelect.value = '';
    const turnoverSelect = document.getElementById('dashboardTurnoverFilter');
    if (turnoverSelect) turnoverSelect.value = '';
    groupSlicerState.selectedGroup = null;
    renderGroupSlicer((salesNormalizationState.meta && Array.isArray(salesNormalizationState.meta.salesGroups)) ? salesNormalizationState.meta.salesGroups : []);
    
    // Reset button appearance
    const button = document.querySelector('button[onclick="applySalesDashboardFilters()"]');
    button.innerHTML = 'âœ¨ Apply Filters';
    button.style.background = 'linear-gradient(135deg,#059669,#10b981)';
    
    // Refresh dashboard with all data
    updateSalesDashboard();
}

function populateDashboardFilters() {
    const { normalized, meta } = ensureSalesDataNormalized();

    const divisionSelect = document.getElementById('dashboardDivisionFilter');
    const repSelect = document.getElementById('dashboardSalesRepFilter');
    const groupSelect = document.getElementById('dashboardGroupFilter');

    if (!normalized.length) {
        if (divisionSelect) {
            setMultiSelectOptions(divisionSelect, [], 'All Sales Divisions');
        }
        if (groupSelect) {
            setMultiSelectOptions(groupSelect, [], 'All Sales Groups (Code + Name)');
        }
        if (repSelect) {
            setSingleSelectOptions(repSelect, [], 'All Sales Reps');
        }
        return;
    }

    setMultiSelectOptions(divisionSelect, meta.divisions, 'All Sales Divisions');
    setMultiSelectOptions(groupSelect, meta.salesGroups, 'All Sales Groups (Code + Name)');
    setSingleSelectOptions(repSelect, meta.salesReps, 'All Sales Reps');
    renderGroupSlicer(meta.salesGroups);
}

function updateDashboardWithFilters() {
    const { normalized } = ensureSalesDataNormalized();
    if (!normalized.length) {
        updateDashboardMetrics([], getDashboardTargetSummary());
        return;
    }

    const dateFrom = activeDashboardFilters.dateFrom ? new Date(activeDashboardFilters.dateFrom) : null;
    const dateTo = activeDashboardFilters.dateTo ? new Date(activeDashboardFilters.dateTo) : null;
    const divisionFilters = Array.isArray(activeDashboardFilters.division) ? activeDashboardFilters.division : [];
    const groupFilters = Array.isArray(activeDashboardFilters.salesGroup) ? activeDashboardFilters.salesGroup : [];
    const salesRepFilter = activeDashboardFilters.salesRep || '';
    const performanceFilter = activeDashboardFilters.performance || '';
    const turnoverFilter = activeDashboardFilters.turnover || '';

    const filtered = normalized.filter(entry => {
        if (dateFrom && (!entry.date || entry.date < dateFrom)) {
            return false;
        }
        if (dateTo && (!entry.date || entry.date > dateTo)) {
            return false;
        }
        if (!matchesMultiFilter(divisionFilters, entry.division)) {
            return false;
        }
        if (!matchesMultiFilter(groupFilters, entry.salesGroup)) {
            return false;
        }
        if (salesRepFilter && entry.salesRep !== salesRepFilter) {
            return false;
        }
        if (performanceFilter) {
            const performanceBand = entry.turnover >= 20000 ? 'high' : entry.turnover >= 10000 ? 'medium' : 'low';
            if (performanceBand !== performanceFilter) {
                return false;
            }
        }
        if (turnoverFilter) {
            const matchesRange = (() => {
                if (turnoverFilter === '0-10000') {
                    return entry.turnover >= 0 && entry.turnover <= 10000;
                }
                if (turnoverFilter === '10000-25000') {
                    return entry.turnover >= 10000 && entry.turnover <= 25000;
                }
                if (turnoverFilter === '25000-50000') {
                    return entry.turnover >= 25000 && entry.turnover <= 50000;
                }
                if (turnoverFilter === '50000+') {
                    return entry.turnover >= 50000;
                }
                return true;
            })();
            if (!matchesRange) {
                return false;
            }
        }
        return true;
    });

    const targetDateFrom = dateFrom instanceof Date && !Number.isNaN(dateFrom.getTime())
        ? new Date(Date.UTC(dateFrom.getUTCFullYear(), dateFrom.getUTCMonth(), 1))
        : null;
    const targetDateTo = dateTo instanceof Date && !Number.isNaN(dateTo.getTime())
        ? new Date(Date.UTC(dateTo.getUTCFullYear(), dateTo.getUTCMonth(), 1))
        : null;

    const targetSummary = getDashboardTargetSummary({
        division: divisionFilters,
        salesGroup: groupFilters,
        salesRep: salesRepFilter,
        dateFrom: targetDateFrom,
        dateTo: targetDateTo
    });

    updateDashboardMetrics(filtered, targetSummary);
}

const dashboardChartState = {
    turnoverTrend: null,
    turnoverProgress: null,
    repMomentum: null
};

const DASHBOARD_CHART_COLORS = ['#2563eb', '#059669', '#f97316', '#8b5cf6', '#ec4899', '#0ea5e9', '#facc15'];
const DASHBOARD_CHART_ANIMATION = {
    duration: 900,
    easing: 'easeOutQuart',
    delay(ctx) {
        if (!ctx || typeof ctx.dataIndex !== 'number') {
            return 0;
        }
        return Math.min(ctx.dataIndex * 60, 600);
    }
};

if (typeof Chart !== 'undefined') {
    Chart.defaults.color = '#0f172a';
    Chart.defaults.font.family = "'Inter','Segoe UI',sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.plugins.legend.labels.color = '#0f172a';
    Chart.defaults.plugins.tooltip.titleColor = '#0f172a';
    Chart.defaults.plugins.tooltip.bodyColor = '#0f172a';
}

function withAlpha(hex, alpha) {
    if (typeof hex !== 'string') {
        return `rgba(37,99,235,${alpha})`;
    }
    const normalized = hex.replace('#', '');
    if (normalized.length !== 6) {
        return `rgba(37,99,235,${alpha})`;
    }
    const r = parseInt(normalized.slice(0, 2), 16);
    const g = parseInt(normalized.slice(2, 4), 16);
    const b = parseInt(normalized.slice(4, 6), 16);
    if ([r, g, b].some(value => Number.isNaN(value))) {
        return `rgba(37,99,235,${alpha})`;
    }
    return `rgba(${r},${g},${b},${alpha})`;
}

const DASHBOARD_CHART_FORECAST_COLORS = DASHBOARD_CHART_COLORS.map(color => withAlpha(color, 0.32));

function destroyDashboardChart(key) {
    const chartInstance = dashboardChartState[key];
    if (chartInstance && typeof chartInstance.destroy === 'function') {
        chartInstance.destroy();
    }
    dashboardChartState[key] = null;
}

function formatMonthLabelFromKey(key) {
    if (!key || typeof key !== 'string') {
        return key || '';
    }
    const parts = key.split('-');
    const year = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    if (!Number.isFinite(year) || !Number.isFinite(month)) {
        return key;
    }
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const safeIndex = Math.max(1, Math.min(12, month)) - 1;
    return `${monthNames[safeIndex]} ${year}`;
}

function incrementMonthKey(key) {
    if (!key || typeof key !== 'string') {
        return null;
    }
    const parts = key.split('-');
    const year = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    if (!Number.isFinite(year) || !Number.isFinite(month)) {
        return null;
    }
    const baseDate = new Date(Date.UTC(year, month - 1, 1));
    if (Number.isNaN(baseDate.getTime())) {
        return null;
    }
    baseDate.setUTCMonth(baseDate.getUTCMonth() + 1);
    return `${baseDate.getUTCFullYear()}-${String(baseDate.getUTCMonth() + 1).padStart(2, '0')}`;
}

function calculateGroupForecastSeries(actualValues = []) {
    if (!Array.isArray(actualValues) || actualValues.length === 0) {
        return [];
    }
    const forecast = [];
    actualValues.forEach((value, index) => {
        if (index === 0) {
            forecast.push(Number.isFinite(value) ? value : 0);
            return;
        }
        const windowStart = Math.max(0, index - 2);
        const window = actualValues.slice(windowStart, index).filter(val => Number.isFinite(val));
        if (window.length === 0) {
            forecast.push(Number.isFinite(value) ? value : 0);
            return;
        }
        const sum = window.reduce((acc, val) => acc + val, 0);
        forecast.push(sum / window.length);
    });
    return forecast;
}

function calculateNextForecast(actualValues = []) {
    if (!Array.isArray(actualValues) || actualValues.length === 0) {
        return 0;
    }
    const window = actualValues.filter(val => Number.isFinite(val) && val > 0).slice(-3);
    if (window.length === 0) {
        const lastValue = actualValues[actualValues.length - 1];
        return Number.isFinite(lastValue) ? lastValue : 0;
    }
    const sum = window.reduce((acc, val) => acc + val, 0);
    return sum / window.length;
}

function buildGroupTurnoverSeries(normalized = [], options = {}) {
    const topN = Number.isFinite(options.topN) && options.topN > 0 ? options.topN : 4;
    const monthKeysSet = new Set();
    const groupMonthMap = new Map();

    normalized.forEach(entry => {
        if (!(entry.date instanceof Date) || Number.isNaN(entry.date.getTime())) {
            return;
        }
        const monthKey = `${entry.date.getFullYear()}-${String(entry.date.getMonth() + 1).padStart(2, '0')}`;
        monthKeysSet.add(monthKey);
        const groupName = entry.salesGroup || 'Unassigned';
        if (!groupMonthMap.has(groupName)) {
            groupMonthMap.set(groupName, new Map());
        }
        const monthMap = groupMonthMap.get(groupName);
        monthMap.set(monthKey, (monthMap.get(monthKey) || 0) + (entry.turnover || 0));
    });

    if (monthKeysSet.size === 0 || groupMonthMap.size === 0) {
        return { labels: [], groups: [] };
    }

    const monthKeys = Array.from(monthKeysSet).sort((a, b) => a.localeCompare(b));
    const monthLabels = monthKeys.map(formatMonthLabelFromKey);

    const rankedGroups = Array.from(groupMonthMap.entries())
        .map(([name, monthMap]) => ({
            name,
            monthMap,
            total: Array.from(monthMap.values()).reduce((acc, value) => acc + value, 0)
        }))
        .sort((a, b) => b.total - a.total)
        .slice(0, topN);

    const futureKey = monthKeys.length > 0 ? incrementMonthKey(monthKeys[monthKeys.length - 1]) : null;
    const labels = futureKey ? monthLabels.concat(formatMonthLabelFromKey(futureKey)) : monthLabels;

    const groups = rankedGroups.map(group => {
        const actualValues = monthKeys.map(key => group.monthMap.get(key) || 0);
        const forecastValues = calculateGroupForecastSeries(actualValues);
        const actualSeries = actualValues.slice();
        const forecastSeries = forecastValues.slice();
        if (futureKey) {
            actualSeries.push(null);
            forecastSeries.push(calculateNextForecast(actualValues));
        }
        return {
            name: group.name || 'Unassigned',
            actualValues: actualSeries,
            forecastValues: forecastSeries
        };
    });

    return {
        labels,
        groups,
        monthCount: monthKeys.length
    };
}

function getTurnoverProgressData(summary = null, targetSummary = null) {
    const actual = summary && Number.isFinite(summary.totalTurnover) ? summary.totalTurnover : 0;
    const targetBucket = targetSummary && targetSummary.turnover ? targetSummary.turnover : null;
    const target = targetBucket && Number.isFinite(targetBucket.target) ? targetBucket.target : null;
    if (!Number.isFinite(target) || target <= 0) {
        return null;
    }
    const achieved = Math.max(Math.min(actual, target), 0);
    const remaining = Math.max(target - actual, 0);
    const overshoot = actual > target ? actual - target : 0;
    return {
        actual,
        target,
        achieved,
        remaining,
        overshoot
    };
}

function getRepMomentumSeries(summary = null) {
    const rawReps = summary && Array.isArray(summary.topSalesReps) ? summary.topSalesReps : [];
    if (rawReps.length === 0) {
        return { labels: [], values: [] };
    }

    const positive = rawReps.filter(rep => Number.isFinite(rep.turnover) && rep.turnover > 0).slice(0, 6);
    return {
        labels: positive.map(rep => rep.name || 'Unassigned'),
        values: positive.map(rep => rep.turnover)
    };
}

function renderDashboardCharts(normalized = [], summary = null, targetSummary = null) {
    if (typeof Chart === 'undefined') {
        return;
    }

    const messageEl = document.getElementById('dashboardChartMessage');
    const turnoverCanvas = document.getElementById('turnoverTrendChart');
    const progressCanvas = document.getElementById('turnoverProgressChart');
    const repCanvas = document.getElementById('repMomentumChart');
    if (!turnoverCanvas || !progressCanvas || !repCanvas) {
        return;
    }

    const turnoverEmpty = document.getElementById('turnoverTrendEmpty');
    const progressEmpty = document.getElementById('turnoverProgressEmpty');
    const repEmpty = document.getElementById('repMomentumEmpty');

    const hasData = Array.isArray(normalized) && normalized.length > 0;
    if (!hasData) {
        if (messageEl) {
            messageEl.textContent = 'Upload sales data to unlock visual insights.';
        }
        destroyDashboardChart('turnoverTrend');
        destroyDashboardChart('turnoverProgress');
        destroyDashboardChart('repMomentum');
        if (turnoverEmpty) turnoverEmpty.style.display = 'flex';
        if (progressEmpty) progressEmpty.style.display = 'flex';
        if (repEmpty) repEmpty.style.display = 'flex';
        return;
    }

    if (messageEl) {
        messageEl.textContent = 'Charts respond to your filters in real time.';
    }

    const summaryRef = summary || summarizeSalesData(normalized);
    const groupSeries = buildGroupTurnoverSeries(normalized);
    if (groupSeries.monthCount >= 2 && groupSeries.groups.length > 0) {
        if (turnoverEmpty) turnoverEmpty.style.display = 'none';
        destroyDashboardChart('turnoverTrend');
        const datasets = [];
        groupSeries.groups.forEach((group, idx) => {
            const baseColor = DASHBOARD_CHART_COLORS[idx % DASHBOARD_CHART_COLORS.length];
            const forecastColor = DASHBOARD_CHART_FORECAST_COLORS[idx % DASHBOARD_CHART_FORECAST_COLORS.length];
            datasets.push({
                label: `${group.name} Actual`,
                data: group.actualValues,
                borderColor: baseColor,
                backgroundColor: withAlpha(baseColor, 0.18),
                borderWidth: 2.4,
                tension: 0.35,
                spanGaps: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
            datasets.push({
                label: `${group.name} Forecast`,
                data: group.forecastValues,
                borderColor: forecastColor,
                backgroundColor: forecastColor,
                borderWidth: 2,
                tension: 0.25,
                spanGaps: true,
                borderDash: [6, 4],
                pointRadius: 0,
                pointHoverRadius: 0
            });
        });

        dashboardChartState.turnoverTrend = new Chart(turnoverCanvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: groupSeries.labels,
                datasets
            },
            options: {
                animation: DASHBOARD_CHART_ANIMATION,
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'nearest', intersect: false },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 10 }
                    },
                    tooltip: {
                        callbacks: {
                            label(context) {
                                const value = context.parsed && Number.isFinite(context.parsed.y) ? context.parsed.y : context.raw;
                                return `${context.dataset.label}: ${formatSalesCurrency(value || 0, { compact: false, decimals: 0 })}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { maxRotation: 0, autoSkip: true }
                    },
                    y: {
                        ticks: {
                            callback(value) {
                                return formatSalesCurrency(value, { compact: true, decimals: 0 });
                            }
                        },
                        grid: { color: 'rgba(148,163,184,0.2)' }
                    }
                }
            }
        });
    } else {
        if (turnoverEmpty) turnoverEmpty.style.display = 'flex';
        destroyDashboardChart('turnoverTrend');
    }

    const progressData = getTurnoverProgressData(summaryRef, targetSummary);
    if (progressData) {
        if (progressEmpty) progressEmpty.style.display = 'none';
        destroyDashboardChart('turnoverProgress');

        const achievedSegment = progressData.achieved;
        const remainingSegment = progressData.remaining;
        const overshootSegment = progressData.overshoot;

        const outerData = overshootSegment > 0
            ? [achievedSegment, remainingSegment, overshootSegment]
            : [achievedSegment, remainingSegment];
        const outerColors = overshootSegment > 0
            ? ['#2563eb', '#d1d5db', '#f97316']
            : ['#2563eb', '#d1d5db'];
        const outerLabels = overshootSegment > 0
            ? ['Achieved', 'Remaining', 'Above Target']
            : ['Achieved', 'Remaining'];

        const innerRemaining = remainingSegment > 0 ? remainingSegment : 0;
        const innerFiller = Math.max(progressData.target - innerRemaining, 0.0001);
        const innerData = [innerRemaining, innerFiller];

        const progressPercent = progressData.target > 0
            ? Math.round(Math.min((progressData.actual / progressData.target) * 100, 999))
            : 0;

        dashboardChartState.turnoverProgress = new Chart(progressCanvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: outerLabels,
                datasets: [
                    {
                        data: outerData,
                        backgroundColor: outerColors,
                        borderWidth: 0,
                        hoverOffset: 6,
                        radius: '100%',
                        innerRadius: '58%'
                    },
                    {
                        data: innerData,
                        backgroundColor: [
                            innerRemaining > 0 ? 'rgba(37,99,235,0.25)' : 'rgba(37,99,235,0.12)',
                            'rgba(255,255,255,0)'
                        ],
                        borderWidth: 0,
                        hoverOffset: 0,
                        radius: '80%',
                        innerRadius: '70%'
                    }
                ]
            },
            options: {
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 900,
                    easing: 'easeOutCubic'
                },
                responsive: true,
                maintainAspectRatio: false,
                cutout: '52%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, boxHeight: 12, padding: 12 }
                    },
                    tooltip: {
                        callbacks: {
                            label(context) {
                                const value = context.parsed;
                                return `${context.label}: ${formatSalesCurrency(value || 0, { compact: false, decimals: 0 })}`;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `Achieved ${progressPercent}% of target`,
                        color: '#1f2937',
                        font: { size: 14, weight: '600' }
                    }
                }
            }
        });
    } else {
        if (progressEmpty) progressEmpty.style.display = 'flex';
        destroyDashboardChart('turnoverProgress');
    }

    const repSeries = getRepMomentumSeries(summaryRef);
    if (repSeries.labels.length > 0) {
        if (repEmpty) repEmpty.style.display = 'none';
        destroyDashboardChart('repMomentum');
        const barColors = repSeries.labels.map((_, idx) => DASHBOARD_CHART_COLORS[(idx + 2) % DASHBOARD_CHART_COLORS.length]);
        dashboardChartState.repMomentum = new Chart(repCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: repSeries.labels,
                datasets: [{
                    label: 'Turnover',
                    data: repSeries.values,
                    backgroundColor: barColors,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                animation: {
                    ...DASHBOARD_CHART_ANIMATION,
                    delay(ctx) {
                        if (!ctx || typeof ctx.dataIndex !== 'number') {
                            return 0;
                        }
                        return Math.min(ctx.dataIndex * 80, 700);
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label(context) {
                                const value = context.parsed && Number.isFinite(context.parsed.y) ? context.parsed.y : context.raw;
                                return formatSalesCurrency(value || 0, { compact: false, decimals: 0 });
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            autoSkip: false,
                            maxRotation: 0,
                            callback(value, idx) {
                                const source = Array.isArray(repSeries.labels) ? repSeries.labels[idx] : null;
                                const label = source || (typeof value === 'string' ? value : String(value));
                                return label.length > 10 ? `${label.slice(0, 9)}â€¦` : label;
                            }
                        },
                        grid: { display: false }
                    },
                    y: {
                        ticks: {
                            callback(value) {
                                return formatSalesCurrency(value, { compact: true, decimals: 0 });
                            }
                        },
                        grid: { color: 'rgba(148,163,184,0.2)' }
                    }
                }
            }
        });
    } else {
        if (repEmpty) repEmpty.style.display = 'flex';
        destroyDashboardChart('repMomentum');
    }
}

function updateDashboardMetrics(normalized = [], targetSummary = null) {
    const turnoverEl = document.getElementById('dashboardTotalTurnover');
    const clientsEl = document.getElementById('dashboardActiveClients');
    const orderLinesEl = document.getElementById('dashboardOrderLines');
    const balanceEl = document.getElementById('dashboardCustomerBalance');
    const newBusinessEl = document.getElementById('dashboardNewBusiness');
    const remainingDaysEl = document.getElementById('dashboardRemainingDays');
    const remainingTargetEl = document.getElementById('dashboardRemainingTarget');
    const remainingCardMessageEl = document.getElementById('dashboardRemainingCardMessage');
    const totalDealsEl = document.getElementById('dashboardTotalDeals');
    const avgDealEl = document.getElementById('dashboardAvgDealSize');
    const topDivisionEl = document.getElementById('dashboardTopDivision');
    const topRepEl = document.getElementById('dashboardTopRep');
    const tableBody = document.getElementById('dashboardTableBody');
    const turnoverTrendEl = document.getElementById('turnoverTrend');
    const clientsBreakdownEl = document.getElementById('clientsBreakdown');
    const avgOrderValueEl = document.getElementById('avgOrderValue');
    const balanceStatusEl = document.getElementById('balanceStatus');
    const newBusinessCountEl = document.getElementById('newBusinessCount');
    const forecast30El = document.getElementById('dashboardForecast30');
    const forecast90El = document.getElementById('dashboardForecast90');
    const forecastConfidenceEl = document.getElementById('dashboardForecastConfidence');
    const forecastMomentumEl = document.getElementById('dashboardForecastMomentum');
    const dealVelocityEl = document.getElementById('dashboardDealVelocity');
    const cycleDurationEl = document.getElementById('dashboardCycleDuration');
    const stageDurationsEl = document.getElementById('dashboardStageDurations');
    const velocitySampleEl = document.getElementById('dashboardVelocitySample');
    const marginSummaryEl = document.getElementById('marginIntelligenceSummary');
    const marginListEl = document.getElementById('marginIntelligenceList');
    const trendsContentEl = document.getElementById('performanceTrendsContent');
    const funnelContentEl = document.getElementById('conversionFunnelContent');
    const topCustomersByRepEl = document.getElementById('topCustomersByRepContent');
    const filterLabel = describeActiveDashboardFilters(activeDashboardFilters);

    const progressPlaceholders = [
        { textId: 'turnoverTargetText', progressId: 'turnoverProgressBar' },
        { textId: 'activeClientsTargetText', progressId: 'activeClientsProgressBar' },
        { textId: 'orderLinesTargetText', progressId: 'orderLinesProgressBar' },
        { textId: 'customerBalanceTargetText', progressId: 'customerBalanceProgressBar' },
        { textId: 'newBusinessTargetText', progressId: 'newBusinessProgressBar' }
    ];

    if (!Array.isArray(normalized) || normalized.length === 0) {
        setSalesDrilldownState(null, [], null, {});
        if (turnoverEl) turnoverEl.textContent = 'R0';
        if (clientsEl) clientsEl.textContent = '0';
        if (orderLinesEl) orderLinesEl.textContent = '0';
        if (balanceEl) balanceEl.textContent = 'R0';
        if (newBusinessEl) newBusinessEl.textContent = 'R0';
            const baseRemainingDays = calculateRemainingWorkingDays(new Date(), COMPANY_END_DATE);
            const baseDayLabel = baseRemainingDays === 1 ? 'day' : 'days';
            if (remainingDaysEl) remainingDaysEl.textContent = `${baseRemainingDays} ${baseDayLabel}`;
        if (remainingTargetEl) remainingTargetEl.textContent = 'Target pending';
        if (remainingCardMessageEl) remainingCardMessageEl.textContent = 'Upload sales targets to calculate the remaining gap.';
        if (totalDealsEl) totalDealsEl.textContent = '0';
        if (avgDealEl) avgDealEl.textContent = 'R0';
        if (topDivisionEl) topDivisionEl.textContent = '-';
        if (topRepEl) topRepEl.textContent = '-';
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" style="padding:40px;text-align:center;color:#6b7280;font-style:italic">No data matches the selected filters</td></tr>';
        }
        if (turnoverTrendEl) turnoverTrendEl.textContent = '+0%';
        if (clientsBreakdownEl) clientsBreakdownEl.textContent = '0 reps â€¢ No customers >=R1000';
        if (avgOrderValueEl) avgOrderValueEl.textContent = 'R0';
        if (balanceStatusEl) balanceStatusEl.textContent = 'External feed';
        if (newBusinessCountEl) newBusinessCountEl.textContent = 'External feed';
        if (forecast30El) forecast30El.textContent = 'R0';
        if (forecast90El) forecast90El.textContent = 'R0';
        if (forecastConfidenceEl) forecastConfidenceEl.textContent = 'Confidence: Pending data';
        if (forecastMomentumEl) forecastMomentumEl.textContent = 'Momentum: Waiting for sales history';
        if (dealVelocityEl) dealVelocityEl.textContent = '0 deals/week';
        if (cycleDurationEl) cycleDurationEl.textContent = '- days';
        if (stageDurationsEl) stageDurationsEl.textContent = 'Stage insights pending';
        if (velocitySampleEl) velocitySampleEl.textContent = 'Upload transactional history to unlock velocity analytics.';
        if (marginSummaryEl) marginSummaryEl.textContent = 'No margin alerts yet.';
        if (marginListEl) {
            marginListEl.innerHTML = '<p style="margin:0;color:#6b7280;font-size:13px">Upload sales with gross margin% to surface high-risk deals.</p>';
        }
        if (trendsContentEl) {
            trendsContentEl.innerHTML = '<p style="margin:0;color:#6b7280;font-size:13px">7-day and 30-day momentum will appear once sales are loaded.</p>';
        }
        if (funnelContentEl) {
            funnelContentEl.innerHTML = '<p style="margin:0;color:#6b7280;font-size:13px">Lead â†’ quote â†’ order conversion flow will appear with sales activity.</p>';
        }
        if (topCustomersByRepEl) {
            topCustomersByRepEl.innerHTML = '<p style="margin:0;color:#6b7280;font-size:13px">Load sales with customer detail to surface top accounts by sales rep.</p>';
        }
        progressPlaceholders.forEach(({ textId, progressId }) => {
            const textEl = document.getElementById(textId);
            if (textEl) {
                textEl.textContent = 'Targets pending upload';
            }
            const progressEl = document.getElementById(progressId);
            if (progressEl) {
                progressEl.style.width = '0%';
                progressEl.style.background = 'rgba(248,113,113,0.9)';
            }
        });
        renderDashboardRecommendations([], null);
        renderDashboardAlerts(null, null, { hasData: false, filterLabel });
        renderDashboardCharts([], null, targetSummary);
        return;
    }

    const summary = summarizeSalesData(normalized);
    const targets = targetSummary || getDashboardTargetSummary();
    const drilldownContextLabel = filterLabel && filterLabel !== 'all data' ? filterLabel : 'Dashboard';
    setSalesDrilldownState(summary, normalized, targets, { contextLabel: drilldownContextLabel });
    wireSalesDashboardDrilldowns();

    const forecast = calculateSalesForecast(normalized, summary);
    const today = new Date();
    const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    let currentMonthTurnover = 0;
    let currentMonthDeals = 0;

    normalized.forEach(entry => {
        if (!(entry.date instanceof Date) || Number.isNaN(entry.date.getTime())) {
            return;
        }
        const entryMonthKey = `${entry.date.getFullYear()}-${String(entry.date.getMonth() + 1).padStart(2, '0')}`;
        if (entryMonthKey === currentMonthKey) {
            currentMonthTurnover += Number.isFinite(entry.turnover) ? entry.turnover : 0;
            currentMonthDeals += 1;
        }
    });

    const latestDataDate = summary.dateInfo && summary.dateInfo.maxDate instanceof Date && !Number.isNaN(summary.dateInfo.maxDate.getTime())
        ? summary.dateInfo.maxDate
        : null;
    const currentMonthHasData = currentMonthTurnover > 0;
    const dataThrough = currentMonthHasData && latestDataDate ? latestDataDate : today;
    const daysElapsed = Math.max(1, Math.floor((dataThrough - monthStart) / DAY_IN_MS) + 1);
    const pacePerDay = currentMonthTurnover > 0 ? currentMonthTurnover / daysElapsed : 0;
    const projectedMonthTurnover = pacePerDay > 0 ? pacePerDay * daysInMonth : 0;
    const currentMonthLabel = formatSalesDateLabel(monthStart, { mode: 'month' }) || 'Current Month';

    const currentSnapshot = {
        label: currentMonthLabel,
        turnover: currentMonthTurnover,
        deals: currentMonthDeals,
        projectedTotal: projectedMonthTurnover,
        daysElapsed,
        daysInMonth,
        dataThrough,
        latestDataDate,
        asOf: today
    };
    if (forecast30El) {
        forecast30El.textContent = formatSalesCurrency(forecast.forecast30, { compact: true, decimals: 0 });
    }
    if (forecast90El) {
        forecast90El.textContent = formatSalesCurrency(forecast.forecast90, { compact: true, decimals: 0 });
    }
    if (forecastConfidenceEl) {
        const basisLabel = forecast.basisDays ? `${forecast.basisDays} day${forecast.basisDays === 1 ? '' : 's'} of history` : 'insufficient history';
        forecastConfidenceEl.textContent = `Confidence: ${forecast.confidence}${basisLabel ? ` (${basisLabel})` : ''}`;
    }
    if (forecastMomentumEl) {
        const momentumPercent = ((forecast.momentumFactor || 1) - 1) * 100;
        const descriptor = momentumPercent > 5 ? 'Accelerating' : momentumPercent < -5 ? 'Cooling' : 'Stable';
        const formattedPercent = Number.isFinite(momentumPercent) ? `${momentumPercent >= 0 ? '+' : ''}${momentumPercent.toFixed(1)}%` : '+0.0%';
        forecastMomentumEl.textContent = `Momentum: ${descriptor} (${formattedPercent})`;
    }

    const groupForecastEl = document.getElementById('groupForecastList');
    if (groupForecastEl) {
        const groupSeries = buildGroupTurnoverSeries(normalized, { topN: 6 });
        if (groupSeries.groups.length > 0 && groupSeries.labels.length > 0) {
            const futureLabel = groupSeries.labels[groupSeries.labels.length - 1];
            const rows = groupSeries.groups.map(group => {
                const nextForecast = group.forecastValues[group.forecastValues.length - 1] || 0;
                const latestActual = group.actualValues.slice().reverse().find(val => Number.isFinite(val));
                const delta = latestActual ? nextForecast - latestActual : null;
                const deltaText = delta !== null && Number.isFinite(delta)
                    ? `${delta >= 0 ? '+' : ''}${formatSalesCurrency(delta, { compact: true, decimals: 0 })}`
                    : '';
                return `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 4px;border-bottom:1px solid #e5e7eb">
                    <span style="color:#0f172a;font-weight:600">${escapeHtml(group.name || 'Unassigned')}</span>
                    <span style="color:#059669;font-weight:700">${formatSalesCurrency(nextForecast, { compact: true, decimals: 0 })}${deltaText ? ` (${deltaText})` : ''}</span>
                </div>`;
            }).join('');
            groupForecastEl.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Forecast by group (${escapeHtml(futureLabel)})</div>${rows}`;
        } else {
            groupForecastEl.textContent = 'Need at least two months of group sales to forecast.';
        }
    }

    const velocity = calculateDealVelocity(normalized, summary);
    if (dealVelocityEl) {
        dealVelocityEl.textContent = `${velocity.dealsPerWeek.toFixed(1)} deals/week`;
    }
    if (cycleDurationEl) {
        cycleDurationEl.textContent = `${velocity.avgCycleDays.toFixed(1)} days`;
    }
    if (stageDurationsEl) {
        stageDurationsEl.textContent = `First touch â†’ quote: ${velocity.firstToQuote.toFixed(1)} days | Quote â†’ close: ${velocity.quoteToClose.toFixed(1)} days`;
    }
    if (velocitySampleEl) {
        const sampleText = velocity.sampleSize > 0
            ? `Derived from ${velocity.sampleSize} customer journey${velocity.sampleSize === 1 ? '' : 's'} over ${velocity.coverageDays} day window.`
            : 'Upload transactional history to unlock velocity analytics.';
        velocitySampleEl.textContent = sampleText;
    }

    const marginIntel = calculateMarginIntelligence(normalized, { threshold: 10 });
    if (marginSummaryEl) {
        marginSummaryEl.textContent = marginIntel.count > 0
            ? `${marginIntel.count} deal${marginIntel.count === 1 ? '' : 's'} under ${marginIntel.threshold}% margin (${marginIntel.share.toFixed(1)}% of deals).`
            : 'No margin alerts under the 10% threshold.';
    }
    if (marginListEl) {
        marginListEl.innerHTML = renderMarginIntelligence(marginIntel);
    }

    const trends = calculatePerformanceTrends(normalized, summary);
    if (trendsContentEl) {
        trendsContentEl.innerHTML = renderPerformanceTrends(trends);
    }

    const funnel = calculateConversionFunnel(normalized);
    if (funnelContentEl) {
        funnelContentEl.innerHTML = renderConversionFunnel(funnel);
    }

    const activeClientsByRep = new Map();
    const activeCustomersSet = new Set();
    const activeCustomerStats = [];
    const repPrimaryDivision = {};
    const referenceDate = summary.dateInfo && summary.dateInfo.maxDate instanceof Date && !Number.isNaN(summary.dateInfo.maxDate.getTime())
        ? summary.dateInfo.maxDate
        : today;
    const twelveMonthsAgo = new Date(referenceDate.getTime() - 365 * DAY_IN_MS);

    const customerAggregates = new Map();
    normalized.forEach(entry => {
        const entryDate = entry.date instanceof Date && !Number.isNaN(entry.date.getTime()) ? entry.date : null;
        if (!entryDate || entryDate < twelveMonthsAgo) {
            if (!repPrimaryDivision[entry.salesRep] && entry.division) {
                repPrimaryDivision[entry.salesRep] = entry.division;
            }
            return;
        }

        const repKey = entry.salesRep || 'Unassigned';
        const customerKey = entry.customerId || entry.customer || `${repKey}-${entry.rowIndex}`;
        const customerLabel = entry.customerDisplay || entry.customer || 'Unassigned Customer';
        const turnover = Number.isFinite(entry.turnover) ? Math.max(entry.turnover, 0) : 0;

        if (!customerAggregates.has(customerKey)) {
            customerAggregates.set(customerKey, {
                label: customerLabel,
                turnover: 0,
                reps: new Set()
            });
        }
        const agg = customerAggregates.get(customerKey);
        agg.turnover += turnover;
        agg.reps.add(repKey);

        if (!repPrimaryDivision[entry.salesRep] && entry.division) {
            repPrimaryDivision[entry.salesRep] = entry.division;
        }
    });

    customerAggregates.forEach((agg, customerKey) => {
        if (agg.turnover > 0 && agg.turnover < 1000) {
            activeCustomersSet.add(customerKey);
            agg.reps.forEach(rep => {
                if (!activeClientsByRep.has(rep)) {
                    activeClientsByRep.set(rep, new Set());
                }
                activeClientsByRep.get(rep).add(customerKey);
            });
            activeCustomerStats.push({ label: agg.label, turnover: agg.turnover });
        }
    });

    const activeClientsTotal = activeCustomersSet.size;
    const activeRepCount = Array.from(activeClientsByRep.values()).filter(set => set.size > 0).length;
    const topActiveCustomers = activeCustomerStats
        .sort((a, b) => b.turnover - a.turnover)
        .slice(0, 3);
    summary.activeUnder1k12m = activeClientsTotal;
    const customerBalance = 0;
    const newBusinessTurnover = 0;
    const remainingWorkingDays = calculateRemainingWorkingDays(today, COMPANY_END_DATE);
    const orderLineTotal = summary.totalOrderLines || summary.totalRecords;

    if (turnoverEl) turnoverEl.textContent = formatSalesCurrency(summary.totalTurnover, { compact: true, decimals: 0 });
    if (clientsEl) clientsEl.textContent = activeClientsTotal.toString();
    if (orderLinesEl) orderLinesEl.textContent = orderLineTotal.toString();
    if (balanceEl) balanceEl.textContent = formatSalesCurrency(customerBalance, { compact: true, decimals: 0 });
    if (newBusinessEl) newBusinessEl.textContent = formatSalesCurrency(newBusinessTurnover, { compact: true, decimals: 0 });
    const turnoverTarget = targets.turnover && Number.isFinite(targets.turnover.target) ? targets.turnover.target : null;
    const remainingTargetValue = turnoverTarget !== null ? Math.max(turnoverTarget - summary.totalTurnover, 0) : null;
    if (remainingDaysEl) {
        const dayLabel = remainingWorkingDays === 1 ? 'day' : 'days';
        remainingDaysEl.textContent = `${remainingWorkingDays} ${dayLabel}`;
    }
    if (remainingTargetEl) {
        remainingTargetEl.textContent = remainingTargetValue !== null
            ? formatSalesCurrency(remainingTargetValue, { compact: true, decimals: 0 })
            : 'Target pending';
    }
    if (remainingCardMessageEl) {
        if (remainingTargetValue === null) {
            remainingCardMessageEl.textContent = 'Upload sales targets to calculate the remaining gap.';
        } else if (remainingTargetValue === 0) {
            remainingCardMessageEl.textContent = 'Turnover target achieved ahead of the 15 Dec 2026 close.';
        } else {
            const dayLabel = remainingWorkingDays === 1 ? 'day' : 'days';
            remainingCardMessageEl.textContent = `${remainingWorkingDays} working ${dayLabel} left to close ${formatSalesCurrency(remainingTargetValue, { compact: true, decimals: 0 })}.`;
        }
    }
    if (totalDealsEl) totalDealsEl.textContent = orderLineTotal.toString();
    if (avgDealEl) avgDealEl.textContent = formatSalesCurrency(summary.avgDealSize);
    if (topDivisionEl) topDivisionEl.textContent = summary.topDivisions[0] ? summary.topDivisions[0].name : '-';
    if (topRepEl) topRepEl.textContent = summary.topSalesReps[0] ? summary.topSalesReps[0].name.split(' ')[0] : '-';

    const turnoverTrend = summary.totalTurnover ? Math.min(99, Math.max(-25, Math.round((newBusinessTurnover / summary.totalTurnover) * 100))) : 0;
    if (turnoverTrendEl) turnoverTrendEl.textContent = `${turnoverTrend >= 0 ? '+' : ''}${turnoverTrend}%`;
    if (clientsBreakdownEl) {
        const customerSnippet = topActiveCustomers.length
            ? `Top: ${topActiveCustomers.map(item => item.label).join(', ')}`
            : 'No customers <R1000 in last 12m';
        clientsBreakdownEl.textContent = `${activeRepCount} rep${activeRepCount === 1 ? '' : 's'} â€¢ ${customerSnippet}`;
    }
    if (avgOrderValueEl) avgOrderValueEl.textContent = formatSalesCurrency(summary.avgDealSize);
    if (balanceStatusEl) balanceStatusEl.textContent = 'External feed';
    if (newBusinessCountEl) newBusinessCountEl.textContent = 'External feed';
    if (topCustomersByRepEl) {
        const customerMap = new Map();
        normalized.forEach(entry => {
            if (!Number.isFinite(entry.turnover) || entry.turnover <= 0) {
                return;
            }
            if (isExcludedFromTopDeals(entry)) {
                return;
            }
            const customerName = entry.customerDisplay || entry.customer || 'Unassigned Customer';
            const repName = entry.salesRep || 'Unassigned';
            const key = `${customerName}|||${repName}`;
            if (!customerMap.has(key)) {
                customerMap.set(key, { customer: customerName, rep: repName, turnover: 0 });
            }
            const agg = customerMap.get(key);
            agg.turnover += entry.turnover;
        });

        const topTenCustomers = Array.from(customerMap.values())
            .filter(item => Number.isFinite(item.turnover) && item.turnover > 0)
            .sort((a, b) => b.turnover - a.turnover)
            .slice(0, 10);

        if (topTenCustomers.length > 0) {
            const listItems = topTenCustomers.map((item, index) => {
                const isLast = index === topTenCustomers.length - 1;
                return `
                    <li style="margin:0;padding:6px 0;display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;border-bottom:${isLast ? 'none' : '1px solid #f1f5f9'}">
                        <span style="font-weight:600;color:#1f2937">${escapeHtml(item.customer)}</span>
                        <span style="color:#475569;font-size:13px;justify-self:end">${escapeHtml(item.rep)}</span>
                        <span style="font-weight:600;color:#059669;justify-self:end">${formatSalesCurrency(item.turnover, { compact: true, decimals: 0 })}</span>
                    </li>`;
            });
            topCustomersByRepEl.innerHTML = `<ol style="margin:0;padding:0;list-style:none">${listItems.join('')}</ol>`;
        } else {
            topCustomersByRepEl.innerHTML = '<p style="margin:0;color:#6b7280;font-size:13px">No qualifying customers listed yet.</p>';
        }
    }

    const metricStatuses = [];
    const turnoverStatus = updateMetricTargetDisplay({
        metricKey: 'turnover',
        actualValue: summary.totalTurnover,
        targetBucket: targets.turnover || null,
        textElementId: 'turnoverTargetText',
        progressElementId: 'turnoverProgressBar'
    });
    if (turnoverStatus) {
        metricStatuses.push(turnoverStatus);
    }
    const activeClientsStatus = updateMetricTargetDisplay({
        metricKey: 'activeClients',
        actualValue: activeClientsTotal,
        targetBucket: targets.activeClients || null,
        textElementId: 'activeClientsTargetText',
        progressElementId: 'activeClientsProgressBar'
    });
    if (activeClientsStatus) {
        metricStatuses.push(activeClientsStatus);
    }
    const orderLinesStatus = updateMetricTargetDisplay({
        metricKey: 'orderLines',
        actualValue: orderLineTotal,
        targetBucket: targets.orderLines || null,
        textElementId: 'orderLinesTargetText',
        progressElementId: 'orderLinesProgressBar'
    });
    if (orderLinesStatus) {
        metricStatuses.push(orderLinesStatus);
    }
    const balanceStatus = updateMetricTargetDisplay({
        metricKey: 'customerBalance',
        actualValue: customerBalance,
        targetBucket: targets.customerBalance || null,
        textElementId: 'customerBalanceTargetText',
        progressElementId: 'customerBalanceProgressBar'
    });
    if (balanceStatus) {
        metricStatuses.push(balanceStatus);
    }
    const newBusinessStatus = updateMetricTargetDisplay({
        metricKey: 'newBusiness',
        actualValue: newBusinessTurnover,
        targetBucket: targets.newBusiness || null,
        textElementId: 'newBusinessTargetText',
        progressElementId: 'newBusinessProgressBar'
    });
    if (newBusinessStatus) {
        metricStatuses.push(newBusinessStatus);
    }
    if (tableBody) {
        const topPerformers = summary.topSalesReps.slice(0, 10);
        tableBody.innerHTML = topPerformers.map((rep, idx) => {
            const division = rep.divisions && rep.divisions.length > 0 ? rep.divisions[0] : (repPrimaryDivision[rep.name] || 'Unassigned');
            return `
                <tr style="border-bottom:1px solid #f3f4f6;${idx % 2 === 0 ? 'background:#f9fafb' : ''}">
                    <td style="padding:12px;font-weight:500">${escapeHtml(division)}</td>
                    <td style="padding:12px">${escapeHtml(rep.name)}</td>
                    <td style="padding:12px;text-align:right;font-weight:600;color:#059669">${formatSalesCurrency(rep.turnover)}</td>
                    <td style="padding:12px;text-align:center">${rep.deals}</td>
                </tr>
            `;
        }).join('');
    }

    renderDashboardRecommendations(metricStatuses, summary);
    renderDashboardAlerts(summary, targets, {
        hasData: true,
        filterLabel,
        activeClientsTotal,
        activeClientsTarget: targets.activeClients && Number.isFinite(targets.activeClients.target) ? targets.activeClients.target : null,
        topDivision: summary.topDivisions[0] ? summary.topDivisions[0].name : null,
        topRep: summary.topSalesReps[0] ? summary.topSalesReps[0].name : null,
        newBusinessTurnover: summary.dateInfo ? summary.dateInfo.last30DaysTurnover : null,
        last30Deals: summary.dateInfo.last30DaysDeals,
        last30ActiveCustomers: summary.activeCustomersLast30Days,
        activeRepCount,
        turnoverPerRep: summary.turnoverPerRep,
        avgGrossMargin: summary.avgGrossMargin,
        currentSnapshot,
        forecastSummary: forecast,
        today
    });
    renderDashboardCharts(normalized, summary, targets);
}

// Initialize dashboard filters when showing sales dashboard
function initializeSalesDashboardFilters() {
    populateDashboardFilters();
}

// Update Sales Dashboard with real data
function updateSalesDashboard() {
    const { normalized } = ensureSalesDataNormalized();
    const targetSummary = getDashboardTargetSummary();
    updateDashboardMetrics(normalized, targetSummary);
}
</script>
</body>
</html>
